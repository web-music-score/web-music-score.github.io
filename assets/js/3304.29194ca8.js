"use strict";(globalThis.webpackChunkweb_music_score_org=globalThis.webpackChunkweb_music_score_org||[]).push([[3304],{2652:(t,e,i)=>{i.d(e,{B:()=>h,U:()=>c});var s=i(7758),n=i(6540),o=i(7976),r=i(4848),a=i(5221),h=class extends n.Component{constructor(t){super(t),(0,s.Mu)(this,"ctx"),this.ctx=new o.Bj,this.ctx.setDocument(t.doc),t.onScoreEvent&&this.ctx.setScoreEventListener(t.onScoreEvent)}componentDidUpdate(t,e){t.doc!==this.props.doc&&(this.ctx.setDocument(this.props.doc),this.ctx.draw())}render(){return(0,r.jsx)("canvas",{style:{position:"relative"},ref:t=>{t&&(this.ctx.setCanvas(t),this.ctx.draw())},children:"Your browser does not support the HTML canvas tag."})}};var c=class extends n.Component{constructor(t){switch(super(t),(0,s.Mu)(this,"state"),(0,s.Mu)(this,"buttonClass"),(0,s.Mu)(this,"buttonGroupClass"),this.state={controller:(new o.w0).setDocument(t.doc)},function(){if("undefined"==typeof window)return"unknown";const t=document.createElement("button");t.className="btn btn-primary",document.body.appendChild(t);const e=getComputedStyle(t).padding;return document.body.removeChild(t),e.includes("6px")&&e.includes("12px")?"bootstrap":""!==getComputedStyle(document.documentElement).getPropertyValue("--ifm-color-primary").trim()?"infima":"unknown"}()){case"bootstrap":this.buttonClass="btn btn-primary",this.buttonGroupClass="btn-group";break;case"infima":this.buttonClass="button button--primary",this.buttonGroupClass="ifm-button-group";break;default:this.buttonClass="wms-button",this.buttonGroupClass="wms-button-group"}}componentDidUpdate(t){this.props.doc!==t.doc&&this.state.controller.setDocument(this.props.doc)}render(){let{singlePlayStop:t,playStop:e,playLabel:i,pauseLabel:s,stopLabel:n}=this.props,{controller:o}=this.state;const{buttonClass:a,buttonGroupClass:h}=this;return null!=i||(i="Play"),null!=s||(s="Pause"),null!=n||(n="Stop"),t?(0,r.jsx)("button",{className:a,ref:t=>{t&&o.setPlayStopButton(t,i,n)}}):e?(0,r.jsxs)("div",{className:h,children:[(0,r.jsx)("button",{className:a,ref:t=>{t&&o.setPlayButton(t,i)}}),(0,r.jsx)("button",{className:a,ref:t=>{t&&o.setStopButton(t,n)}})]}):(0,r.jsxs)("div",{className:h,children:[(0,r.jsx)("button",{className:a,ref:t=>{t&&o.setPlayButton(t,i)}}),(0,r.jsx)("button",{className:a,ref:t=>{t&&o.setPauseButton(t,s)}}),(0,r.jsx)("button",{className:a,ref:t=>{t&&o.setStopButton(t,n)}})]})}};(0,a.Ts)()},7976:(t,e,i)=>{i.d(e,{Bj:()=>Qi,Vx:()=>tt,t5:()=>je,w0:()=>$i});var s=i(560),n=i(8710),o=i(6171),r=i(7758),a=i(3543),h=i(5221),c=i(1236),g=!1,u=1,l=75,d=10,f=1.7,I=10,m=.5,C=.5,p=2,A=1.3,b=1.8,y=.8,v=7,w=1.5,M=4,S=2,R=1.25,x=.5,L=4,T=.5,N=3.6,O=5,j=8,k=20,P={HilightStaffPos:"#55cc55",HilightObject:"#55cc55",PlayCursor:"#44aa44",Background:"white",Header_Title:"black",Header_Composer:"black",Header_Arranger:"black",RowGroup_Instrument:"black",RowGroup_Frame:"black",Staff_Frame:"black",Staff_Note:"black",Staff_Rest:"black",Staff_Connective:"black",Staff_Signature_Clef:"black",Staff_Signature_Key:"black",Staff_Signature_Time:"black",Staff_Signature_Tempo:"black",Staff_Signature_MeasureNum:"black",Staff_Element_Fermata:"black",Staff_Element_Annotation:"black",Staff_Element_Navigation:"black",Staff_Element_Label:"black",Tab_Frame:"black",Tab_Note:"black",Tab_Rest:"black",Tab_Connective:"black",Tab_Tuning:"black",Tab_Signature_Time:"black",Tab_Signature_Tempo:"black",Tab_Signature_MeasureNum:"black",Tab_Element_Fermata:"black",Tab_Element_Annotation:"black",Tab_Element_Navigation:"black",Tab_Element_Label:"black"};var E=(t=>(t.Treble="treble",t.Bass="bass",t.Grand="grand",t.GuitarTreble="guitarTreble",t.GuitarTab="guitarTab",t.GuitarCombined="guitarCombined",t))(E||{}),D=(t=>(t.G="G",t.F="F",t))(D||{});function G(t){return o.I8.isIncluded(t,[0,1,2,3])}function B(t){if(G(t))return t;throw new s.O(6,`Voice id ${t} is invalid!`)}function Y(t){return o.I8.isIncluded(t,[1,2,3,4,5,6])}function W(t){return o.I8.isIncluded(t,[1,2,3])}var F,U,z,Z,V=(t=>(t.Auto="auto",t.Up="up",t.Down="down",t))(V||{}),H=(t=>(t.Up="up",t.Down="down",t))(H||{}),X=(t=>(t.Stub="stub",t.ToMeasureEnd="toMeasureEnd",t))(X||{}),q=(t=>(t.Auto="auto",t.Above="above",t.Center="center",t.Below="below",t.StemTip="stemTip",t))(q||{}),J=(t=>(t.Tie="tie",t.Slur="slur",t.Slide="slide",t))(J||{}),K=(t=>(t.Auto="auto",t.Above="above",t.Below="below",t.Both="both",t))(K||{}),Q=(t=>(t.Left="left",t.Center="center",t.Right="right",t))(Q||{}),_=(t=>(t.Hyphen="-",t.Extender="---",t))(_||{}),$=(t=>(t.AtNote="atNote",t.AtMeasureEnd="atMeasureEnd",t))($||{}),tt=(t=>(t.DC_al_Fine="D.C. al Fine",t.DC_al_Coda="D.C. al Coda",t.DS_al_Fine="D.S. al Fine",t.DS_al_Coda="D.S. al Coda",t.Coda="Coda",t.toCoda="toCoda",t.Segno="Segno",t.Fine="Fine",t.StartRepeat="startRepeat",t.EndRepeat="endRepeat",t.Ending="ending",t))(tt||{}),et=(t=>(t.Dynamics="dynamics",t.Tempo="tempo",t))(et||{}),it=(t=>(t.cresc="cresc.",t.decresc="decresc.",t.dim="dim.",t.ppp="ppp",t.pp="pp",t.p="p",t.mp="mp",t.m="m",t.mf="mf",t.f="f",t.ff="ff",t.fff="fff",t))(it||{}),st=(t=>(t.accel="accel.",t.rit="rit.",t.a_tempo="a tempo",t))(st||{}),nt=(t=>(t.Note="note",t.Chord="chord",t))(nt||{}),ot=class{constructor(t){(0,r.Mu)(this,"head"),(0,r.Mu)(this,"tail"),this.head=t,this.tail=[]}getHead(){return this.head}getTails(){return this.tail}addTail(t){this.tail.push(t)}detachTail(t){let e=this.tail.indexOf(t);e>=0&&this.tail.splice(e,1)}},rt=class{constructor(t){this.parent=t,(0,r.Mu)(this,"anchoredLayoutObjects",[]),(0,r.Mu)(this,"link"),(0,r.Mu)(this,"userData",{}),(0,r.Mu)(this,"rect",new o.vW),(0,r.Mu)(this,"needRectUpdate",!0)}getParent(){return this.parent}requestRectUpdate(){this.needRectUpdate=!0}updateRect(){}forceRectUpdate(){this.needRectUpdate=!0,this.updateRect(),this.needRectUpdate=!1}getRect(){return this.needRectUpdate&&this.forceRectUpdate(),this.rect}offsetX(t){this.offset(t,0)}offsetY(t){this.offset(0,t)}setLeft(t){this.offset(t-this.getRect().left,0)}setRight(t){this.offset(t-this.getRect().right,0)}setTop(t){this.offset(0,t-this.getRect().top)}setBottom(t){this.offset(0,t-this.getRect().bottom)}setAnchor(t,e){this.offset(t-this.getRect().anchorX,e-this.getRect().anchorY)}setAnchorX(t){this.offset(t-this.getRect().anchorX,0)}setAnchorY(t){this.offset(0,t-this.getRect().anchorY)}setCenter(t,e){this.offset(t-this.getRect().centerX,e-this.getRect().centerY)}setCenterX(t){this.offset(t-this.getRect().centerX,0)}setCenterY(t){this.offset(0,t-this.getRect().centerY)}getShapeRects(){return[this.rect]}addAnchoredLayoutObject(t){this.anchoredLayoutObjects.push(t)}getAnchoredLayoutObjects(){return this.anchoredLayoutObjects}setLink(t){this.link=t}getLink(){return this.link}isLinked(){return null!==this.link}};(U=F=F||(F={})).AliceBlue="aliceblue",U.AntiqueWhite="antiquewhite",U.Aqua="aqua",U.Aquamarine="aquamarine",U.Azure="azure",U.Beige="beige",U.Bisque="bisque",U.Black="black",U.BlanchedAlmond="blanchedalmond",U.Blue="blue",U.BlueViolet="blueviolet",U.Brown="brown",U.BurlyWood="burlywood",U.CadetBlue="cadetblue",U.Chartreuse="chartreuse",U.Chocolate="chocolate",U.Coral="coral",U.CornflowerBlue="cornflowerblue",U.CornSilk="cornsilk",U.Crimson="crimson",U.Cyan="cyan",U.DarkBlue="darkblue",U.DarkCyan="darkcyan",U.DarkGoldenRod="darkgoldenrod",U.DarkGray="darkgray",U.DarkGreen="darkgreen",U.DarkGrey="darkgrey",U.DarkKhaki="darkkhaki",U.DarkMagenta="darkmagenta",U.DarkOliveGreen="darkolivegreen",U.DarkOrange="darkorange",U.DarkOrchid="darkorchid",U.DarkRed="darkred",U.DarkSalmon="darksalmon",U.DarkSeaGreen="darkseagreen",U.DarkSlateBlue="darkslateblue",U.DarkSlateGray="darkslategray",U.DarkSlateGrey="darkslategrey",U.DarkTurquoise="darkturquoise",U.DarkViolet="darkviolet",U.DeepPink="deeppink",U.DeepSkyBlue="deepskyblue",U.DimGray="dimgray",U.DimGrey="dimgrey",U.DodgerBlue="dodgerblue",U.FireBrick="firebrick",U.FloralWhite="floralwhite",U.ForestGreen="forestgreen",U.Fuchsia="fuchsia",U.Gainsboro="gainsboro",U.GhostWhite="ghostwhite",U.Gold="gold",U.GoldenRod="goldenrod",U.Gray="gray",U.Green="green",U.GreenYellow="greenyellow",U.Grey="grey",U.Honeydew="honeydew",U.HotPink="hotpink",U.IndianRed="indianred",U.Indigo="indigo",U.Ivory="ivory",U.Khaki="khaki",U.Lavender="lavender",U.LavenderBlush="lavenderblush",U.LawnGreen="lawngreen",U.LemonChiffon="lemonchiffon",U.LightBlue="lightblue",U.LightCoral="lightcoral",U.LightCyan="lightcyan",U.LightGoldenRodYellow="lightgoldenrodyellow",U.LightGray="lightgray",U.LightGreen="lightgreen",U.LightGrey="lightgrey",U.LightPink="lightpink",U.LightSalmon="lightsalmon",U.LightSeaGreen="lightseagreen",U.LightSkyBlue="lightskyblue",U.LightSlateGray="lightslategray",U.LightSlateGrey="lightslategrey",U.LightSteelBlue="lightsteelblue",U.LightYellow="lightyellow",U.Lime="lime",U.LimeGreen="limegreen",U.Linen="linen",U.Magenta="magenta",U.Maroon="maroon",U.MediumAquamarine="mediumaquamarine",U.MediumBlue="mediumblue",U.MediumOrchid="mediumorchid",U.MediumPurple="mediumpurple",U.MediumSeaGreen="mediumseagreen",U.MediumSlateBlue="mediumslateblue",U.MediumSpringGreen="mediumspringgreen",U.MediumTurquoise="mediumturquoise",U.MediumVioletRed="mediumvioletred",U.MidnightBlue="midnightblue",U.MintCream="mintcream",U.MistyRose="mistyrose",U.Moccasin="moccasin",U.NavajoWhite="navajowhite",U.Navy="navy",U.OldLace="oldlace",U.Olive="olive",U.OliveDrab="olivedrab",U.Orange="orange",U.OrangeRed="orangered",U.Orchid="orchid",U.PaleGoldenRod="palegoldenrod",U.PaleGreen="palegreen",U.PaleTurquoise="paleturquoise",U.PaleVioletRed="palevioletred",U.PapayaWhip="papayawhip",U.PeachPuff="peachpuff",U.Peru="peru",U.Pink="pink",U.Plum="plum",U.PowderBlue="powderblue",U.Purple="purple",U.RebeccaPurple="rebeccapurple",U.Red="red",U.RosyBrown="rosybrown",U.RoyalBlue="royalblue",U.SaddleBrown="saddlebrown",U.Salmon="salmon",U.SandyBrown="sandybrown",U.SeaGreen="seagreen",U.SeaShell="seashell",U.Sienna="sienna",U.Silver="silver",U.SkyBlue="skyblue",U.SlateBlue="slateblue",U.SlateGray="slategray",U.SlateGrey="slategrey",U.Snow="snow",U.SpringGreen="springgreen",U.SteelBlue="steelblue",U.Tan="tan",U.Teal="teal",U.Thistle="thistle",U.Tomato="tomato",U.Turquoise="turquoise",U.Violet="violet",U.Wheat="wheat",U.White="white",U.WhiteSmoke="whitesmoke",U.Yellow="yellow",U.YellowGreen="yellowgreen",(Z=z=z||(z={})).Hex="hex",Z.RGB="rgb",Z.Array="array";var at={aliceblue:[240,248,255],antiquewhite:[250,235,215],aqua:[0,255,255],aquamarine:[127,255,212],azure:[240,255,255],beige:[245,245,220],bisque:[255,228,196],black:[0,0,0],blanchedalmond:[255,235,205],blue:[0,0,255],blueviolet:[138,43,226],brown:[165,42,42],burlywood:[222,184,135],cadetblue:[95,158,160],chartreuse:[127,255,0],chocolate:[210,105,30],coral:[255,127,80],cornflowerblue:[100,149,237],cornsilk:[255,248,220],crimson:[220,20,60],cyan:[0,255,255],darkblue:[0,0,139],darkcyan:[0,139,139],darkgoldenrod:[184,134,11],darkgray:[169,169,169],darkgreen:[0,100,0],darkgrey:[169,169,169],darkkhaki:[189,183,107],darkmagenta:[139,0,139],darkolivegreen:[85,107,47],darkorange:[255,140,0],darkorchid:[153,50,204],darkred:[139,0,0],darksalmon:[233,150,122],darkseagreen:[143,188,143],darkslateblue:[72,61,139],darkslategray:[47,79,79],darkslategrey:[47,79,79],darkturquoise:[0,206,209],darkviolet:[148,0,211],deeppink:[255,20,147],deepskyblue:[0,191,255],dimgray:[105,105,105],dimgrey:[105,105,105],dodgerblue:[30,144,255],firebrick:[178,34,34],floralwhite:[255,250,240],forestgreen:[34,139,34],fuchsia:[255,0,255],gainsboro:[220,220,220],ghostwhite:[248,248,255],gold:[255,215,0],goldenrod:[218,165,32],gray:[128,128,128],green:[0,128,0],greenyellow:[173,255,47],grey:[128,128,128],honeydew:[240,255,240],hotpink:[255,105,180],indianred:[205,92,92],indigo:[75,0,130],ivory:[255,255,240],khaki:[240,230,140],lavender:[230,230,250],lavenderblush:[255,240,245],lawngreen:[124,252,0],lemonchiffon:[255,250,205],lightblue:[173,216,230],lightcoral:[240,128,128],lightcyan:[224,255,255],lightgoldenrodyellow:[250,250,210],lightgray:[211,211,211],lightgreen:[144,238,144],lightgrey:[211,211,211],lightpink:[255,182,193],lightsalmon:[255,160,122],lightseagreen:[32,178,170],lightskyblue:[135,206,250],lightslategray:[119,136,153],lightslategrey:[119,136,153],lightsteelblue:[176,196,222],lightyellow:[255,255,224],lime:[0,255,0],limegreen:[50,205,50],linen:[250,240,230],magenta:[255,0,255],maroon:[128,0,0],mediumaquamarine:[102,205,170],mediumblue:[0,0,205],mediumorchid:[186,85,211],mediumpurple:[147,112,219],mediumseagreen:[60,179,113],mediumslateblue:[123,104,238],mediumspringgreen:[0,250,154],mediumturquoise:[72,209,204],mediumvioletred:[199,21,133],midnightblue:[25,25,112],mintcream:[245,255,250],mistyrose:[255,228,225],moccasin:[255,228,181],navajowhite:[255,222,173],navy:[0,0,128],oldlace:[253,245,230],olive:[128,128,0],olivedrab:[107,142,35],orange:[255,165,0],orangered:[255,69,0],orchid:[218,112,214],palegoldenrod:[238,232,170],palegreen:[152,251,152],paleturquoise:[175,238,238],palevioletred:[219,112,147],papayawhip:[255,239,213],peachpuff:[255,218,185],peru:[205,133,63],pink:[255,192,203],plum:[221,160,221],powderblue:[176,224,230],purple:[128,0,128],rebeccapurple:[102,51,153],red:[255,0,0],rosybrown:[188,143,143],royalblue:[65,105,225],saddlebrown:[139,69,19],salmon:[250,128,114],sandybrown:[244,164,96],seagreen:[46,139,87],seashell:[255,245,238],sienna:[160,82,45],silver:[192,192,192],skyblue:[135,206,235],slateblue:[106,90,205],slategray:[112,128,144],slategrey:[112,128,144],snow:[255,250,250],springgreen:[0,255,127],steelblue:[70,130,180],tan:[210,180,140],teal:[0,128,128],thistle:[216,191,216],tomato:[255,99,71],turquoise:[64,224,208],violet:[238,130,238],wheat:[245,222,179],white:[255,255,255],whitesmoke:[245,245,245],yellow:[255,255,0],yellowgreen:[154,205,50]};for(const ts in at)Object.freeze(at[ts]);var ht=Object.freeze(at),ct={hash:!0,lowercase:!1,short:!1};var gt=(0,r.ko)((0,r.IA)({},ct),{fallback:!0,alpha:1,format:z.Hex});function ut(t,e={}){const i=(0,r.IA)((0,r.IA)({},gt),e),{fallback:s,format:n,hash:o,lowercase:a,short:h,alpha:c}=i,g=(t=`${t}`).toLowerCase().replaceAll(/[^a-z]/g,"");let u=ht[g];if(!u){if(!s)throw new Error(`no matching color found for '${t}'`);const e=t.toLowerCase().replaceAll(/[^\da-f]/g,"");u=(e.length<=3?[e.slice(0,1).repeat(2),e.slice(1,2).repeat(2),e.slice(2,3).repeat(2)]:[e.slice(0,2),e.slice(2,4),e.slice(4,6)]).map(t=>Number.parseInt(t.length<2?`${"0".repeat(2-t.length)}${t}`:t,16))}switch(n){case z.Array:return[...u];case z.RGB:return function(t,e=1){return(e=Math.min(1,Math.max(0,e)))<1?`rgba(${t[0]}, ${t[1]}, ${t[2]}, ${e})`:`rgb(${t[0]}, ${t[1]}, ${t[2]})`}(u,c);default:return function(t,e){const i=(0,r.IA)((0,r.IA)({},ct),e),{hash:s,lowercase:n,short:o}=i;let a=t.map(t=>{let e=t.toString(16);return e=1===e.length?`0${e}`:e,e}).join("");if(o){const t=[...a];t[0]===t[1]&&t[2]===t[3]&&t[4]===t[5]&&(a=`${t[0]}${t[2]}${t[4]}`)}return a=n?a.toLowerCase():a.toUpperCase(),s&&(a=`#${a}`),a}(u,{hash:o,lowercase:a,short:h})}}var lt=new o.b1([[0,"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAADwAAACWCAYAAACCe+v6AAADHXpUWHRSYXcgcHJvZmlsZSB0eXBlIGV4aWYAAHja7ZZRcu0mDIbfWUWXgCSExHIwmJnu4C6/Pxg7J2kyTdv7GJhjsJCF0CfZJ5y//hzhDzRK5iGpeS45R7RUUuGKicerHetKMa3ratL2Gr2Xh5L3AkMkU/O6LbzlJ+SY074vexO69W9D94QqZvq2UOuWH+/lxzbI/tHQ9kDo2jn2/cA2JLw9Std92x7l4vbuaH2fGYqXyN9+SYyzZrKEa+JolgvmzjEZ4tmno6NxWYb0CugjuO9vVYZPfApJxFUkXV7K/IlUjBlXrAYokhhuFMK5UFbgI1DCBXha9kY1PsF8jc1bjL5o3zlWxCbjnMov1J7xQ97k/HnePLOdBg81z3tB3mON+Rk/lZPehu4Fefbh1529PTu/k4vE9BqK8Ip7jO5jHRqnqCkjFnkf6j7KmkHvmFFcT2V0izkgax2T2Qu6xxobcqrHhko7MC/EoDsoUadKg841NmpwMfHJhpG5BZYldEAq3GQmQ5qdBpsU6eLImHblkPDjC61ty9qukcceYieoMsEY4ZH/3MN3FceYtUQU/YoT0gJ+8axOeBEJ+OcANTCgsYOqK8B3/9gm18lMV5gdB6zxCJeJQ+ktuWSBFigqxgsyWd8GECJsrXCGBARiJlHK8MiYjQiBdACqcJ0l8QECpModTnISyYCD6sDeeMZoqbLyJcZbVVJAsWYUrYNQBayUFPljyZFDVUWTqmY1dS1as+RZeTlbnq/namLJ1LIZ3tlWrLp4cvXs5u7Fa+EieH1rQZ0WL6XUik0rLFc8XaFQ68GHHOnQIx92+FHCURvSp6WmLTdr3kqrnbt0FHjP3br30utJJ1LpTKee+bTTz3LWgVQbMtLQkYeF4aOM+lCjXbYf+7+gRpsaL1JT0R5qkJrdJmi+TnQyAzFOBOAGaiCGxJ7MolNKPMlNZvgeoSqU4aROOJ0mMRBMJ7EOethtcoHr7+EWzBc3/r/kwkT3TXJ/5/YZtT6/Em0Ru8pwBjUKqg/rp1f2Oj+vX47hnxS+O/4Y+jH0Y+jrcYwROv51hb8AKbCqdGIdCl0AAAGFaUNDUElDQyBwcm9maWxlAAB4nH2RPUjDQBzFX1O1UqoOdhBxyFCd7OAH0rFUsQgWSluhVQeTS7+gSUOS4uIouBYc/FisOrg46+rgKgiCHyCuLk6KLlLi/5JCi1gPjvvx7t7j7h0gNCpMNXuigKpZRioeE7O5VdH3ij74MYgpRCRm6on0YgZdx9c9PHy9C/Os7uf+HANK3mSARySOMt2wiDeI5zYtnfM+cZCVJIX4nHjSoAsSP3JddvmNc9FhgWcGjUxqnjhILBY7WO5gVjJU4lnikKJqlC9kXVY4b3FWKzXWuid/YSCvraS5TnMMcSwhgSREyKihjAoshGnVSDGRov1YF/+o40+SSyZXGYwcC6hCheT4wf/gd7dmYWbaTQrEgN4X2/4YB3y7QLNu29/Htt08AbzPwJXW9lcbQOST9HpbCx0BQ9vAxXVbk/eAyx1g5EmXDMmRvDSFQgF4P6NvygHDt4B/ze2ttY/TByBDXS3fAAeHwESRste7vLu/s7d/z7T6+wEMNXLkxtwRywAADzRpVFh0WE1MOmNvbS5hZG9iZS54bXAAAAAAADw/eHBhY2tldCBiZWdpbj0i77u/IiBpZD0iVzVNME1wQ2VoaUh6cmVTek5UY3prYzlkIj8+Cjx4OnhtcG1ldGEgeG1sbnM6eD0iYWRvYmU6bnM6bWV0YS8iIHg6eG1wdGs9IlhNUCBDb3JlIDQuNC4wLUV4aXYyIj4KIDxyZGY6UkRGIHhtbG5zOnJkZj0iaHR0cDovL3d3dy53My5vcmcvMTk5OS8wMi8yMi1yZGYtc3ludGF4LW5zIyI+CiAgPHJkZjpEZXNjcmlwdGlvbiByZGY6YWJvdXQ9IiIKICAgIHhtbG5zOnhtcE1NPSJodHRwOi8vbnMuYWRvYmUuY29tL3hhcC8xLjAvbW0vIgogICAgeG1sbnM6c3RFdnQ9Imh0dHA6Ly9ucy5hZG9iZS5jb20veGFwLzEuMC9zVHlwZS9SZXNvdXJjZUV2ZW50IyIKICAgIHhtbG5zOmRjPSJodHRwOi8vcHVybC5vcmcvZGMvZWxlbWVudHMvMS4xLyIKICAgIHhtbG5zOkdJTVA9Imh0dHA6Ly93d3cuZ2ltcC5vcmcveG1wLyIKICAgIHhtbG5zOnRpZmY9Imh0dHA6Ly9ucy5hZG9iZS5jb20vdGlmZi8xLjAvIgogICAgeG1sbnM6eG1wPSJodHRwOi8vbnMuYWRvYmUuY29tL3hhcC8xLjAvIgogICB4bXBNTTpEb2N1bWVudElEPSJnaW1wOmRvY2lkOmdpbXA6NDA3ODVjMzYtNDAxZC00YTZlLTkxODctMDQ1NTI4MmM0ZGY2IgogICB4bXBNTTpJbnN0YW5jZUlEPSJ4bXAuaWlkOjhiZTJkYzc1LTVlYjQtNDk0Yy1iNWRlLWQ2MzZkNzZhNjI2YiIKICAgeG1wTU06T3JpZ2luYWxEb2N1bWVudElEPSJ4bXAuZGlkOmU3YWE0MWNhLTNiYjMtNGU5Yi05NDQxLTllNTNmZTJiZjM5ZiIKICAgZGM6Rm9ybWF0PSJpbWFnZS9wbmciCiAgIEdJTVA6QVBJPSIyLjAiCiAgIEdJTVA6UGxhdGZvcm09IldpbmRvd3MiCiAgIEdJTVA6VGltZVN0YW1wPSIxNjg2NDA4NjA5MzE2NDM4IgogICBHSU1QOlZlcnNpb249IjIuMTAuMzQiCiAgIHRpZmY6T3JpZW50YXRpb249IjEiCiAgIHhtcDpDcmVhdG9yVG9vbD0iR0lNUCAyLjEwIgogICB4bXA6TWV0YWRhdGFEYXRlPSIyMDIzOjA2OjEwVDE3OjUwOjA5KzAzOjAwIgogICB4bXA6TW9kaWZ5RGF0ZT0iMjAyMzowNjoxMFQxNzo1MDowOSswMzowMCI+CiAgIDx4bXBNTTpIaXN0b3J5PgogICAgPHJkZjpTZXE+CiAgICAgPHJkZjpsaQogICAgICBzdEV2dDphY3Rpb249InNhdmVkIgogICAgICBzdEV2dDpjaGFuZ2VkPSIvIgogICAgICBzdEV2dDppbnN0YW5jZUlEPSJ4bXAuaWlkOjI3MzY2YmY0LWVkZDMtNDE5OC05NjJhLWU5ZTM5MTBlNThiZSIKICAgICAgc3RFdnQ6c29mdHdhcmVBZ2VudD0iR2ltcCAyLjEwIChXaW5kb3dzKSIKICAgICAgc3RFdnQ6d2hlbj0iMjAyMi0wOC0yMlQwMjo1NTozNiIvPgogICAgIDxyZGY6bGkKICAgICAgc3RFdnQ6YWN0aW9uPSJzYXZlZCIKICAgICAgc3RFdnQ6Y2hhbmdlZD0iLyIKICAgICAgc3RFdnQ6aW5zdGFuY2VJRD0ieG1wLmlpZDo5NjVlMTM3OS0wZDlmLTQ5ODItYWQ3MC05MzhjOWMzOWE0ZjMiCiAgICAgIHN0RXZ0OnNvZnR3YXJlQWdlbnQ9IkdpbXAgMi4xMCAoV2luZG93cykiCiAgICAgIHN0RXZ0OndoZW49IjIwMjItMDktMTFUMTY6MzU6MDAiLz4KICAgICA8cmRmOmxpCiAgICAgIHN0RXZ0OmFjdGlvbj0ic2F2ZWQiCiAgICAgIHN0RXZ0OmNoYW5nZWQ9Ii8iCiAgICAgIHN0RXZ0Omluc3RhbmNlSUQ9InhtcC5paWQ6MTBmYmEwYTMtOTI5Yi00NTRlLThjNGMtOGVkOGM4YWJhZGRjIgogICAgICBzdEV2dDpzb2Z0d2FyZUFnZW50PSJHaW1wIDIuMTAgKFdpbmRvd3MpIgogICAgICBzdEV2dDp3aGVuPSIyMDIzLTA2LTEwVDE3OjUwOjA5Ii8+CiAgICA8L3JkZjpTZXE+CiAgIDwveG1wTU06SGlzdG9yeT4KICA8L3JkZjpEZXNjcmlwdGlvbj4KIDwvcmRmOlJERj4KPC94OnhtcG1ldGE+CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgICAgICAgICAKPD94cGFja2V0IGVuZD0idyI/Ppn4NIQAAAAGYktHRAD/AP8A/6C9p5MAAAAJcEhZcwAALiMAAC4jAXilP3YAAAAHdElNRQfnBgoOMgm5WlWBAAAAGXRFWHRDb21tZW50AENyZWF0ZWQgd2l0aCBHSU1QV4EOFwAACHtJREFUeNrtnXuQVmMcxz+77cauTWUpbGSVu2w3BpnUEBq3chkmBjGayG1GBuNWLtUgw5SJkBkjl4QKg1wyQyarK0lRSlstU20bWam9+OM8O3P6vc8553nOe97tnO18Z84f57zP7XvOc/ndnueFfQx5e6neUmAI0B3oDPwD/AJ8Dvzcml5we+Al4D+gyeOaB1S0BrLHAut9iLqvf4ERSSZbBmwwJOu+RieV8JwQZJuARjXWE4WBIck2X38AByaJ8MwsCTcBTyWFbCFQFwHhv4DiKBqUn2PCPYEin9+bgI3AUuBPn3TtgMuT8IWv8vlq7wLdRPrTgPke6d9JAuFbPBo/3UfKK1TCh8yzIQmEb/cYjx0C8pUDuzV5D477GN6mefY+UBuQby0wV/O8U9wJr9E8W2iY92vNs45xJ6zTfKoN827UPNsdd8K1SlJyo8Awb7XhEIkVYYAVmjXVBPtr1uyqJBBeLu5LDPMdppkPdiaRcHvDfKeJ+++SIFoCLBP3R1toWW58lhQFogiodwkPlYZf1y1w/AcclCQVcYWQtILwqiA8M2lGgDcFgSN90nbXiJUXRdWQ/BYiLMdxH5+0k8VavRb4JGmEl4j7vh7pRgDni2fj1RyQKBwiuqjui/Un015dBbQloXCbaTdrZuUajTp4IwnGbEHmKPX8QmCHhuwC9p4rKBI8IghdB0zCsT1Lsg0+4zwxuEiQqqcVmGWDlAETk+zSJE9Ublyjuqof2TrgxKQT7anMNSZfd1iSiZYCUwy+avP1dJLJXglsxdyV8hHQJolEDwBewc5v9J3Klzj0xYnTsCG7W4mdicMdwC7CeQaPTBLRAjUxZeMKvSwpZPcDPghBUGpE45JAthjH92NLdiUwSDz7NO5k24YkuwTHGZYvtKMtcSabD7wVguy37OkilU7v8rgSfjoE2c816+wkkebKOJK9NgTZ2Wpykxgu0k2IG9lTcMIBbchOx9tTWKHpBbFBoZpwbMi+iL9FtEC8wG1xIvyQJdlJhuVWinzd4kD2cJxYZlOyky3KfkHkvSoOhF+2IPu8Zdk3x82O1QV96JDumhJSu5KB4XsVEwzJziCcy2Z/8UK3K5G1PZnhDi2iBW02IDvPY501xY8BuvJ6JcY+AQzAPCDGGucZkF2GefiCxFk4AWoN2K0AG4HHiSBATWJqQMXr1Qxui3Jlv8o2nHiHIl4UFeF1+G/ACOMGuZVoYqfd12qgX7ZkuwZUMjyEoWBaxETd1y5gVDaEr/YpfGqIyW9ODsm6r7FhCY/z6T625tTpLUS2+bo3DOHZHoVdYFnOqBYmG3rbz1JNQbZ2p2MsZfAor604G8OMsUVTyEBLwjMsv4r7vkapl28AH+PEWNqu1++ZNjRPk3mFJdnjDBu4HBipVoUGsewVaGb6fjgRPSsMSQ8wNb/KjA9bEp5osIzcLUitEml6BNQxxGPoWVtROmoynmFJ+CefRvytxFaJt0W6GwwtqE8GkA56cZSSGVxiI74FhTUM9ch3f0irCerleNU3wbZL2xrJzwhp+hks0s6PaBitMsnsXk7WWlY8xKPi7fjvOZI94x/sHOQFPobGw+U4kHBvrrDVRrw2RE4L6C3V7Ln3sBg43qLeeuAxj996BxHeJCYxm2i4Gh8RMwjL/BpqgA/VpKgTgnwJuzdXtbWUWpZpntUCiwwlPDf6WBLeBSzWPO8URFjuHOthUWm1ptJFaizZErb9wvJjNaMkiLDck2CrYD8n7k13hUrCvUIYB3Vdui6I8FI1qzbjUstKXwe+EV3aBKtE40pwjsKwwQEeuoEv4d3ALNf9ycCpFpU24ngRVrvkYNN8y7Ps1rqlb3MQYXCc3m7YytOb1FCYa2lhzHbiqjAoU4s2GoG+D+Fg85VGijq/ssh7qEboqLGZB6QDvBLHdZpLnK6R0EzlgNs0hGfZVJ6v1lV3ARNzTLhYo0sfY5h3sYWy4ole7Blh16ismrnEStFok/ou05BdR8iA1QfJDN2/PoeEZZTQkwZL0RoN4bvCNiCPzONlGpVJNBe7Tu4TdX1h2bbmmLCCbMfWAvTew6iDQy/QzLReZJ/RtKk+pFiagXZqmdCdyzGG8J5Eic6aOuSe4yK8A+RGRfn2/SqqwdmbVBZBPX/gHbh2MfAbEbtbTAQEr7itehyX6DDCn6zyCZlhUHcoTc7Ltj2WHKNcLexBRvaFaqxdr0Q/k2OixmNudN9uo+BEMcsOAB4AzrXIU6vUxlrVU3YqJaMEOELZoUzW0PeBezz04JyjN07o0mZy7zD7EjiTmKAQOAfHJlyJ/xmWtsHlo1UPCI28FnoBJym9urtaYspwdrOUKkmprerC/6pl7lel/HdxlTORBB/7aIJnLSQuK40orlisUWRaNXpoxnHX1ky4DZlhTkNbc5duwAlNjLRb58f8Ky/e1wgv2dcmrr6aiSur3agFOWxsL6XM91a6crUSCWfi+H9NoDtEsIKY7YI52sNQ4D5uZpBFeTKMamScyJqeFL4L8yOjfhB5x8Rp0ppoaPEoBF4j86A/HerEfUlcCB8GXGGRvqPSZYPQIeAF7DXC/bE3fJsY2eWsvCEuhMtC9oouAROgPPxveVwIN4TM53f08tnifgfmh/nmnPC6kPk2+fx2k7ifpWb4WKAT9mG+foFvMqqvkRj+pYntFp0HPMrZj8wg1VieEd8Tc6NdFXr3TCFOgLc77TZifE7AaAOyv+MY9iS64pxBK7vyJXHWcLy8eu4T0dybo9vhBMBMJvMwwEbgzqSodnfhvxOtDieQzOv3ncRkE7UNytV4tJ295+LsnUgsugKPAt/jvQm7DmcX2+Bcj7eWRjFwAo4rtYOa1avUMrSTFClSpEiRIkWKFClSpEiRIkWKFClSpEiRIkWKFClSpEiRIgL8D6ed2EKeJMaTAAAAAElFTkSuQmCC"],[1,"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAADwAAABGCAYAAACQRffVAAADInpUWHRSYXcgcHJvZmlsZSB0eXBlIGV4aWYAAHja7VdbktwgDPznFDkCkgCJ4/AwVblBjp8GY+/OZFPZPD7yMVADWIiWUEt2jTu+fR3uCxplTi5EtZRT8mghh8wFC/Nnq2skH9a4mrS9R49yF9LeYIhkap6Pmbf8gBxr2s95G6FL/wK6FlSwim8bpWx5fZTXDcj2DLQ3hE7Lvu8DG0h4exTO57Y9Stn04Wp93xmKp8jefkGUU0ykAWNgr5oy1sY+KOLZp6PcznP31S7B9XypMnziQ0g8RpFweinzJ1IwJ4wk4qA4hUXiGlmWGTiUEG4Fbj6BR/F3MN/H5i1GP2mfuZaHkXFM5XdXu+envOn147y5VzsN3JU3lvaGPNLq0z1/KKd4AV0bctvh95at3ZYf5ENWdt3Nvad7jG5jXRq3KCEhFmlf6rrKWkGvziiuUwldfXLANSxmz+jmi2/Iqe4bKq1inYnB/aBAnQoNOtbcqMHFwAcrZubmWJbQQFLmhlQgCbPTYJUsXQwp0c4cEr59oWU2L3ONzHfnO0GVCWCEI3/c3WcVx5i1ROTtjBM8g188qxNeeAL9c4IaGKGxgxpXgK/+3CavAgbjCrPhgsVXd0LUSG/JJYvoSW/EfFY9ad8ACBFMRzhDAgZ8IomU4JEyKxECaSCowHWWwBUMUIzc4SQHkQRyUB2wjTNKS5Ujn2K8VSU4FGsSBTdZCsgKISJ/NBhyqESJIcaYokaLOZYkaVZeSprm67moaNCoSVXNadZiYsGiJVMzy1YyZ8HrO2bUabaccykwWoBccLpAoZTKVWqosaaq1Wp2tTSkTwstttS0WcutdO7SUeA9de3Wcy8HHUilIxzxSIceduSjDKTakBFGHGmoGzbyKDdrtMv2uf8Ga7RZ48XUVNSbNUhVLwiar5M4OQNjHAiEK1gDY0jsyZk3CoEnc5MzfI9QFZHhZJzkdJqMgcFwEMdBN3ebOcfl3/Dm1BZv/LfMuUndJ5n7kbePWOvzK9EWY2cZzqB6QfVh/7DCVubn9aez+5XCZ+cX0AvoBfQCegG9gP57oIEPJ/4Bue+bLIaQwqExNwAAAYVpQ0NQSUNDIHByb2ZpbGUAAHicfZE9SMNAHMVfU7UiFQeLijhkqE4WREUcSxWLYKG0FVp1MLn0Q2jSkKS4OAquBQc/FqsOLs66OrgKguAHiKuLk6KLlPi/pNAixoPjfry797h7Bwj1MlPNjiigapaRisfEbG5FDLyiC0EMYgIDEjP1RHohA8/xdQ8fX+8iPMv73J+jV8mbDPCJxFGmGxbxOvHMpqVz3icOsZKkEJ8Tjxt0QeJHrssuv3EuOizwzJCRSc0Rh4jFYhvLbcxKhko8TRxWVI3yhazLCuctzmq5ypr35C8M5rXlNNdpjiCORSSQhAgZVWygDAsRWjVSTKRoP+bhH3b8SXLJ5NoAI8c8KlAhOX7wP/jdrVmYmnSTgjGg88W2P0aBwC7QqNn297FtN04A/zNwpbX8lTow+0l6raWFj4C+beDiuqXJe8DlDjD0pEuG5Eh+mkKhALyf0TflgP5boGfV7a25j9MHIENdLd0AB4fAWJGy1zze3d3e279nmv39ANCccsygwwDVAAAQE2lUWHRYTUw6Y29tLmFkb2JlLnhtcAAAAAAAPD94cGFja2V0IGJlZ2luPSLvu78iIGlkPSJXNU0wTXBDZWhpSHpyZVN6TlRjemtjOWQiPz4KPHg6eG1wbWV0YSB4bWxuczp4PSJhZG9iZTpuczptZXRhLyIgeDp4bXB0az0iWE1QIENvcmUgNC40LjAtRXhpdjIiPgogPHJkZjpSREYgeG1sbnM6cmRmPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5LzAyLzIyLXJkZi1zeW50YXgtbnMjIj4KICA8cmRmOkRlc2NyaXB0aW9uIHJkZjphYm91dD0iIgogICAgeG1sbnM6eG1wTU09Imh0dHA6Ly9ucy5hZG9iZS5jb20veGFwLzEuMC9tbS8iCiAgICB4bWxuczpzdEV2dD0iaHR0cDovL25zLmFkb2JlLmNvbS94YXAvMS4wL3NUeXBlL1Jlc291cmNlRXZlbnQjIgogICAgeG1sbnM6ZGM9Imh0dHA6Ly9wdXJsLm9yZy9kYy9lbGVtZW50cy8xLjEvIgogICAgeG1sbnM6R0lNUD0iaHR0cDovL3d3dy5naW1wLm9yZy94bXAvIgogICAgeG1sbnM6dGlmZj0iaHR0cDovL25zLmFkb2JlLmNvbS90aWZmLzEuMC8iCiAgICB4bWxuczp4bXA9Imh0dHA6Ly9ucy5hZG9iZS5jb20veGFwLzEuMC8iCiAgIHhtcE1NOkRvY3VtZW50SUQ9ImdpbXA6ZG9jaWQ6Z2ltcDo0MDc4NWMzNi00MDFkLTRhNmUtOTE4Ny0wNDU1MjgyYzRkZjYiCiAgIHhtcE1NOkluc3RhbmNlSUQ9InhtcC5paWQ6Nzg3YjYxN2YtMjg1MS00YzhlLTg2MTYtZWM3NGMwYzYwMWVlIgogICB4bXBNTTpPcmlnaW5hbERvY3VtZW50SUQ9InhtcC5kaWQ6ZTdhYTQxY2EtM2JiMy00ZTliLTk0NDEtOWU1M2ZlMmJmMzlmIgogICBkYzpGb3JtYXQ9ImltYWdlL3BuZyIKICAgR0lNUDpBUEk9IjIuMCIKICAgR0lNUDpQbGF0Zm9ybT0iV2luZG93cyIKICAgR0lNUDpUaW1lU3RhbXA9IjE2ODY2MTM5NDcxOTU2ODAiCiAgIEdJTVA6VmVyc2lvbj0iMi4xMC4zNCIKICAgdGlmZjpPcmllbnRhdGlvbj0iMSIKICAgeG1wOkNyZWF0b3JUb29sPSJHSU1QIDIuMTAiCiAgIHhtcDpNZXRhZGF0YURhdGU9IjIwMjM6MDY6MTNUMDI6NTI6MjUrMDM6MDAiCiAgIHhtcDpNb2RpZnlEYXRlPSIyMDIzOjA2OjEzVDAyOjUyOjI1KzAzOjAwIj4KICAgPHhtcE1NOkhpc3Rvcnk+CiAgICA8cmRmOlNlcT4KICAgICA8cmRmOmxpCiAgICAgIHN0RXZ0OmFjdGlvbj0ic2F2ZWQiCiAgICAgIHN0RXZ0OmNoYW5nZWQ9Ii8iCiAgICAgIHN0RXZ0Omluc3RhbmNlSUQ9InhtcC5paWQ6MjczNjZiZjQtZWRkMy00MTk4LTk2MmEtZTllMzkxMGU1OGJlIgogICAgICBzdEV2dDpzb2Z0d2FyZUFnZW50PSJHaW1wIDIuMTAgKFdpbmRvd3MpIgogICAgICBzdEV2dDp3aGVuPSIyMDIyLTA4LTIyVDAyOjU1OjM2Ii8+CiAgICAgPHJkZjpsaQogICAgICBzdEV2dDphY3Rpb249InNhdmVkIgogICAgICBzdEV2dDpjaGFuZ2VkPSIvIgogICAgICBzdEV2dDppbnN0YW5jZUlEPSJ4bXAuaWlkOjk2NWUxMzc5LTBkOWYtNDk4Mi1hZDcwLTkzOGM5YzM5YTRmMyIKICAgICAgc3RFdnQ6c29mdHdhcmVBZ2VudD0iR2ltcCAyLjEwIChXaW5kb3dzKSIKICAgICAgc3RFdnQ6d2hlbj0iMjAyMi0wOS0xMVQxNjozNTowMCIvPgogICAgIDxyZGY6bGkKICAgICAgc3RFdnQ6YWN0aW9uPSJzYXZlZCIKICAgICAgc3RFdnQ6Y2hhbmdlZD0iLyIKICAgICAgc3RFdnQ6aW5zdGFuY2VJRD0ieG1wLmlpZDoxMGZiYTBhMy05MjliLTQ1NGUtOGM0Yy04ZWQ4YzhhYmFkZGMiCiAgICAgIHN0RXZ0OnNvZnR3YXJlQWdlbnQ9IkdpbXAgMi4xMCAoV2luZG93cykiCiAgICAgIHN0RXZ0OndoZW49IjIwMjMtMDYtMTBUMTc6NTA6MDkiLz4KICAgICA8cmRmOmxpCiAgICAgIHN0RXZ0OmFjdGlvbj0ic2F2ZWQiCiAgICAgIHN0RXZ0OmNoYW5nZWQ9Ii8iCiAgICAgIHN0RXZ0Omluc3RhbmNlSUQ9InhtcC5paWQ6MDBmYjM4YTMtZjZiMi00NjQ1LTliMTYtMjlhNWE0ODZlMjhhIgogICAgICBzdEV2dDpzb2Z0d2FyZUFnZW50PSJHaW1wIDIuMTAgKFdpbmRvd3MpIgogICAgICBzdEV2dDp3aGVuPSIyMDIzLTA2LTEzVDAyOjUyOjI3Ii8+CiAgICA8L3JkZjpTZXE+CiAgIDwveG1wTU06SGlzdG9yeT4KICA8L3JkZjpEZXNjcmlwdGlvbj4KIDwvcmRmOlJERj4KPC94OnhtcG1ldGE+CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgICAgICAgICAKPD94cGFja2V0IGVuZD0idyI/PsIRrtIAAAAGYktHRAD/AP8A/6C9p5MAAAAJcEhZcwAALiMAAC4jAXilP3YAAAAHdElNRQfnBgwXNBsqJURsAAAAGXRFWHRDb21tZW50AENyZWF0ZWQgd2l0aCBHSU1QV4EOFwAABF9JREFUeNrtmluIF1Ucxz9/E8P1VnnJ9dJWC4Frmq2JJmqolGEILoQvK2gZeXlRCSm1Fx9UEsJQERWsXhRftECs0Gq70EK9ZHlbFyHbds3VVXFX91+7664P81tYhpnfmft//st84TzMzDm/8/vOnPO7nYEMGTJkyJAhQ4YMGSJBLkJZw4FyYAIwDHgU+A9oAxqBv4C7xfyySoBlwKfAFaAb6DG0euAzoAoYXCxEnwH2A60eCGrtFrALGJNWokNEwY6QRO2tFXgPGJAmss8DlyImam/fASPTQHaeGJueBFod8FQhrfSLwM+ynDX8L1/oV+BP4LZY58eBUUAlMB94ycPSvQTMERmJ4jGgwYPh2Qg84VFmGbAP6DTI/aoQS/lzg1JfA2MDyn4ZuGaQvyZJspUGv3oKGBhyjmeBJmWOmxLMJIITiiIXIgwaZgFdylxbDeNHANXAZmAVUBpEiScNe2xRxC/3Y2WuRmUlLRHD1rd/HljvV4F3FAVqYlhNo4B7Pl/wdPEMbmOq/ShwRBH0Vkxb6LAy536fW64HuOpn8vOKoLKYCC9Q5rzs0L/JQxDjyYPkgHYXAW0xGslByrLuFuPUFw0eCI92mmiAQ4LgZoEbYyTcAZxVPsJk271ag7x6cWueCLvhfsyu8LzybKLtersUF9ywxe2BnXBnAZOUJuXZeNv1OSki3LLdzwPrgONuguw+7g7wAHjEoW+vEagAXgeelr1yUSZoCUn4hvJsqMO9byRaWyLGtFkiwOtBJnYzBKcVg/ZuSMIrlHl3RrWMnFK1OqX/q8oXOAisDqFLVxL7xonw9yHk7Q5RoxpuyLdjI3wmhLzBwMqAY0ck4SGcCNeKIQqKOTF84RtxEu4BPgohc2QM467HSRjgqBL5mBDUPU1Rnl1JwqBNUuJqrW0M+OLdYuk8Cdas38Rf4b3FR0HP/nLdZNYaioKbxSVuA6ZGQfoNvNWlO6VvEKxW5O5yGbNc4ml7ZrUtCtLjgGMSdjop9Q+wMIT8GoXwKw79ZxrKUG9r+a8flMoyr5AA4ybwo1QgggYHpZJ6Ou3Ta5IpddvufwEsVWQ2xFisCI1Nypf6RMmsIql4JI0S8bFuSs9UvmCgikeh8b6i8C/KuKOYD+VShzGSwLsprRnByYYYoSqNhE8qCv/kYfxrYjT7jmuPIC+PBWsVsl1YRzBeE45qqWGtwjo1SR0WoZ8a7KAfYa5h7/2OVaPuF1gqtS83srclpi565IAP0c+b7wOz+wPZckOc3Jt0LC52oiXABx7y6VasGnfRYgiwwRAu9raGqPLXQmAGcADvvyN+m9bgXnP4i4E9wN8+KiJ5WQG5QilumnioJP9lwHPANKw/fF7A+fxJw2ms/y9SFdiPBf4Vn9hJNL8T/iFxbyoxgej+m6zBOtnLpXlvhiXcDOyVJV8UCEL4KnBI/OnAtBP0q+ADMTq/SfshrdUFr4TzwJdY9d57WIdYzRIk1GMdeXSQIUOGDBmSwUMtd8u2ArdcUAAAAABJRU5ErkJggg=="]]),dt=t=>lt.getOrDefault(t,""),ft=new o.kM;var It=class{constructor(t){this.mi=t,(0,r.Mu)(this,"devicePixelRatio"),(0,r.Mu)(this,"fontSize"),(0,r.Mu)(this,"unitSize"),(0,r.Mu)(this,"_lineWidth"),(0,r.Mu)(this,"scoreEventListener"),(0,r.Mu)(this,"canvas"),(0,r.Mu)(this,"ctx"),(0,r.Mu)(this,"mdoc"),(0,r.Mu)(this,"cursorRect"),(0,r.Mu)(this,"mousePos"),(0,r.Mu)(this,"curStaffPos"),(0,r.Mu)(this,"curObjects"),(0,r.Mu)(this,"hilightedStaffPos"),(0,r.Mu)(this,"hilightedObj"),(0,r.Mu)(this,"usingTouch",!1),(0,r.Mu)(this,"onClickFn"),(0,r.Mu)(this,"onMouseMoveFn"),(0,r.Mu)(this,"onMouseLeaveFn"),(0,r.Mu)(this,"onTouchEndFn"),this.devicePixelRatio="undefined"!=typeof window?window.devicePixelRatio:1,this.fontSize=o.L_.FontSize*u*this.devicePixelRatio,this.unitSize=.3*this.fontSize,this._lineWidth=.2*this.unitSize,this.onClickFn=this.onClick.bind(this),this.onMouseMoveFn=this.onMouseMove.bind(this),this.onMouseLeaveFn=this.onMouseLeave.bind(this),this.onTouchEndFn=this.onTouchEnd.bind(this)}getMusicInterface(){return this.mi}get doc(){var t;return null==(t=this.mdoc)?void 0:t.getMusicObject()}getImageAsset(t,e){var i;return null!=e||(e=""),null==(i=ft.getOrCreate(t,e,()=>{const i={src:dt(t),color:e,loaded:!1,colorized:!1},s=new Image;return s.src=i.src,s.onload=()=>{i.img=s,this.onImageLoaded(i)},s.onerror=()=>{console.error("Failed to load image: "+i.src)},i}))?void 0:i.img}forceDraw(){var t;null==(t=this.doc)||t.requestFullLayout(),this.draw()}onImageLoaded(t){if(t.loaded||!t.img)return;if(t.colorized||""===t.color)return this.forceDraw(),void(t.loaded=!0);const[e,i,s,n]=function(t,e=1){const i=ut(t).replace("#","");return[parseInt(i.slice(0,2),16),parseInt(i.slice(2,4),16),parseInt(i.slice(4,6),16),Math.round(255*e)]}(t.color);if("undefined"==typeof document)return void console.error("Failed to colorize image: document is undefined.");const o=document.createElement("canvas");o.width=t.img.width,o.height=t.img.height;const r=o.getContext("2d");if(null==r)return void console.error("Failed to colorize image: ctx = null.");r.drawImage(t.img,0,0);const a=r.getImageData(0,0,o.width,o.height),h=a.data;for(let c=0;c<h.length;c+=4){const t=h[c],n=h[c+1],o=h[c+2];0!==h[c+3]&&(t<40&&n<40&&o<40&&(h[c+0]=e,h[c+1]=i,h[c+2]=s))}r.putImageData(a,0,0),t.img.src=o.toDataURL("image/png"),t.img.onload=()=>{t.colorized=!0,this.onImageLoaded(t)},t.img.onerror=()=>{console.error("Failed to colorize image.")}}setDocument(t){if(this.mdoc===t)return;this.updateCursorRect(void 0);let e=this.mdoc;this.mdoc=t,e&&e.getMusicObject().setRenderContext(void 0),t&&t.getMusicObject().setRenderContext(this)}setCanvas(t){var e,i;this.canvas!==t&&(this.canvas&&(this.canvas.removeEventListener("click",this.onClickFn),this.canvas.removeEventListener("mousemove",this.onMouseMoveFn),this.canvas.removeEventListener("mouseleave",this.onMouseLeaveFn),this.canvas.removeEventListener("touchend",this.onTouchEndFn)),this.canvas=t,this.canvas.addEventListener("click",this.onClickFn),this.canvas.addEventListener("mousemove",this.onMouseMoveFn),this.canvas.addEventListener("mouseleave",this.onMouseLeaveFn),this.canvas.addEventListener("touchend",this.onTouchEndFn),this.canvas.style.position="relative"),this.ctx=null!=(i=null==(e=this.canvas)?void 0:e.getContext("2d"))?i:void 0}setScoreEventListener(t){this.scoreEventListener=t}needMouseInput(){return void 0!==this.scoreEventListener}getMousePos(t){return new o.l2(t.offsetX,t.offsetY)}updateCurStaffPos(t,e){let i=(s=t,n=this.curStaffPos,!(!s&&!n||s&&n&&s.scoreRow===n.scoreRow&&s.diatonicId===n.diatonicId));var s,n;if(i&&this.curStaffPos&&this.scoreEventListener){let{scoreRow:t,diatonicId:e}=this.curStaffPos;this.scoreEventListener(new Pe("leave",this.getMusicInterface(),t.getMusicInterface(),e))}if(i&&t&&this.scoreEventListener){let{scoreRow:e,diatonicId:i}=t;this.scoreEventListener(new Pe("enter",this.getMusicInterface(),e.getMusicInterface(),i))}if(e&&t&&this.scoreEventListener){let{scoreRow:e,diatonicId:i}=t;this.scoreEventListener(new Pe("click",this.getMusicInterface(),e.getMusicInterface(),i))}return this.curStaffPos=t,i}updateCurObjects(t,e){let i=(s=t,n=this.curObjects,!(!s&&!n||s&&n&&s.length===n.length&&s.every((t,e)=>t===n[e])));var s,n;return i&&this.curObjects&&this.curObjects.length>0&&this.scoreEventListener&&this.scoreEventListener(new Ee("leave",this.getMusicInterface(),this.curObjects.map(t=>t.getMusicInterface()))),i&&t&&t.length>0&&this.scoreEventListener&&this.scoreEventListener(new Ee("enter",this.getMusicInterface(),t.map(t=>t.getMusicInterface()))),e&&t&&t.length>0&&this.scoreEventListener&&this.scoreEventListener(new Ee("click",this.getMusicInterface(),t.map(t=>t.getMusicInterface()))),this.curObjects=t,i}onClick(t){let{doc:e}=this;if(this.needMouseInput()&&e&&(this.mousePos=this.txFromScreenCoord(this.getMousePos(t)),this.scoreEventListener)){let t=e.pick(this.mousePos.x,this.mousePos.y),i=e.pickStaffPosAt(this.mousePos.x,this.mousePos.y),s=this.updateCurStaffPos(i,!0),n=this.updateCurObjects(t,!0);(s||n)&&this.draw()}}onMouseMove(t){let{doc:e}=this;if(this.needMouseInput()&&e&&(this.mousePos=this.txFromScreenCoord(this.getMousePos(t)),!this.usingTouch)){let t=e.pick(this.mousePos.x,this.mousePos.y),i=e.pickStaffPosAt(this.mousePos.x,this.mousePos.y),s=this.updateCurStaffPos(i,!1),n=this.updateCurObjects(t,!1);(s||n)&&this.draw()}}onMouseLeave(t){if(!this.needMouseInput())return;this.mousePos=void 0;let e=this.updateCurStaffPos(void 0,!1),i=this.updateCurObjects(void 0,!1);(e||i)&&this.draw()}onTouchEnd(t){this.usingTouch=!0}hilightObject(t){this.hilightedObj=t}hilightStaffPos(t){this.hilightedStaffPos=t}updateCursorRect(t){this.cursorRect=t,this.draw()}updateCanvasSize(){let{canvas:t,doc:e}=this;if(t&&e){let i=e.getRect(),s=i.width+1,n=i.height+1;t.width=s,t.height=n,t.style.width=s/this.devicePixelRatio+"px",t.style.height=n/this.devicePixelRatio+"px"}}draw(){try{let{doc:t}=this;t&&(t.layout(),this.updateCanvasSize(),this.clearCanvas(),this.drawHilightStaffPosRect(),this.drawHilightObjectRect(),this.drawPlayCursor(),t.drawContent())}catch(t){console.error("Render failed!",t)}}drawHilightStaffPosRect(){let{mousePos:t,hilightedStaffPos:e,unitSize:i}=this;if(!e)return;let{scoreRow:s,diatonicId:n}=e,o=s.getStaff(n);o&&(this.fillColor(P.HilightStaffPos),this.fillRect(o.row.getRect().left,o.getDiatonicIdY(n)-i,o.row.getRect().width,2*i),void 0!==t&&this.drawLedgerLines(o,n,t.x))}drawHilightObjectRect(){let{hilightedObj:t}=this;if(!t)return;let e=t.getRect();this.lineColor(P.HilightObject),this.strokeRect(e.left,e.top,e.width,e.height)}drawPlayCursor(){let{cursorRect:t}=this;t&&this.color(P.PlayCursor).lineWidth(2).strokeLine(t.centerX,t.top,t.centerX,t.bottom)}txFromScreenCoord(t){return t.mul(this.devicePixelRatio)}txToScreenCoord(t){return t.div(this.devicePixelRatio)}clearCanvas(){this.ctx&&(this.ctx.canvas.style.background=P.Background,this.ctx.clearRect(0,0,this.ctx.canvas.width,this.ctx.canvas.height))}drawDebugRect(t){g&&this.color("red").lineWidth(1).strokeRect(t.left,t.top,t.width,t.height)}drawLedgerLines(t,e,i){let{unitSize:s}=this,n=s*N;if(e>=t.topLineDiatonicId+2){for(let o=t.topLineDiatonicId+2;o<=e;o+=2)if(t.containsDiatonicId(o)){let e=t.getDiatonicIdY(o);this.strokeLine(i-n/2,e,i+n/2,e)}}else if(e<=t.bottomLineDiatonicId-2)for(let o=t.bottomLineDiatonicId-2;o>=e;o-=2)if(t.containsDiatonicId(o)){let e=t.getDiatonicIdY(o);this.strokeLine(i-n/2,e,i+n/2,e)}}getRestRect(t){let{unitSize:e}=this,{flagCount:i}=n.Xp.get((0,n.PW)(t+"n")),s=0,r=0,a=0,h=0;if(n.Xp.equals(t,"1n"))s=e,r=e,a=0,h=e;else if(n.Xp.equals(t,"2n"))s=e,r=e,a=e,h=0;else if(n.Xp.equals(t,"4n"))s=1*e,r=1*e,a=3.2*e,h=3*e;else{let t=1-i%2;s=e*(1+.25*i),r=e*(1+.125*i),a=e*(.5+i-t),h=e*(1+i+t)}return new o.vW(-s,0,r,-a,0,h)}drawRest(t,e,i){let{unitSize:s}=this,{flagCount:o}=n.Xp.get((0,n.PW)(t+"n"));if(n.Xp.equals(t,"1n"))this.fillRect(e-s,i,2*s,s);else if(n.Xp.equals(t,"2n"))this.fillRect(e-s,i-s,2*s,s);else if(n.Xp.equals(t,"4n"))this.beginPath(),this.moveTo(e-.6*s,i-3.2*s),this.lineTo(e+.7*s,i-1.5*s),this.quadraticCurveTo(e-.8*s,i-.5*s,e+1*s,i+1.5*s),this.lineTo(e-1*s,i-.75*s),this.quadraticCurveTo(e+.2*s,i-1.5*s,e-.6*s,i-3.2*s),this.moveTo(e+1*s,i+1.5*s),this.quadraticCurveTo(e-.8*s,i+1*s,e-.2*s,i+2.8*s),this.bezierCurveTo(e-1.8*s,i+1.5*s,e-.6*s,i-.2*s,e+.9*s,i+1.5*s),this.fill(),this.stroke();else if(o>0){let t=1-o%2,n=t=>e+(.25*-t+.5)*s,r=e=>i+(e+t)*s;this.beginPath(),this.moveTo(n(1+o),r(1+o)),this.lineTo(n(-.5-o),r(-.5-o)),this.stroke();for(let e=0;e<o;e++){let t=o-2*e;this.beginPath(),this.moveTo(n(t-2.5),r(t-2.5)),this.quadraticCurveTo(n(t-.5)+.25*s,r(t-1.5),n(t-1.5)-1.5*s,r(t-1.5)),this.stroke(),this.beginPath(),this.arc(n(t-2)-1.5*s,r(t-2),.5*s,0,2*Math.PI),this.fill()}}}drawFlag(t,e){let i=t.left,s=t.right-i,n="up"===e?t.top:t.bottom,o="up"===e?t.bottom:t.top;this.beginPath(),this.moveTo(i,n),this.bezierCurveTo(i,.75*n+.25*o,i+1.5*s,.5*n+.5*o,i+.5*s,o),this.stroke()}color(t){return this.ctx&&(this.ctx.strokeStyle=this.ctx.fillStyle=t),this}lineColor(t){return this.ctx&&(this.ctx.strokeStyle=t),this}fillColor(t){return this.ctx&&(this.ctx.fillStyle=t),this}lineWidth(t){return this.ctx&&(this.ctx.lineWidth=this._lineWidth*(null!=t?t:1)),this}font(t){return this.ctx&&(this.ctx.font=t),this}beginPath(){return this.ctx&&this.ctx.beginPath(),this}stroke(){return this.ctx&&this.ctx.stroke(),this}fill(){return this.ctx&&this.ctx.fill(),this}moveTo(t,e){return this.ctx&&this.ctx.moveTo(t,e),this}lineTo(t,e){return this.ctx&&this.ctx.lineTo(t,e),this}bezierCurveTo(t,e,i,s,n,o){return this.ctx&&this.ctx.bezierCurveTo(t,e,i,s,n,o),this}quadraticCurveTo(t,e,i,s){return this.ctx&&this.ctx.quadraticCurveTo(t,e,i,s),this}fillRect(t,e,i,s){return this.ctx&&this.ctx.fillRect(t,e,i,s),this}setLineDash(t){return this.ctx&&this.ctx.setLineDash(t),this}drawImage(t,e,i,s,n){return this.ctx&&this.ctx.drawImage(t,e,i,s,n),this}ellipse(t,e,i,s,n,o,r){return this.ctx&&this.ctx.ellipse(t,e,i,s,n,o,r),this}clip(){return this.ctx&&this.ctx.clip(),this}save(){return this.ctx&&this.ctx.save(),this}restore(){return this.ctx&&this.ctx.restore(),this}rect(t,e,i,s){return this.ctx&&this.ctx.rect(t,e,i,s),this}scale(t,e){return this.ctx&&this.ctx.scale(t,e),this}strokeRect(t,e,i,s){return this.ctx&&this.ctx.strokeRect(t,e,i,s),this}fillText(t,e,i){return this.ctx&&this.ctx.fillText(t,e,i),this}getTextWidth(t,e){if(this.ctx){let i=this.ctx.font;this.ctx.font=e;let s=this.ctx.measureText(t);return this.ctx.font=i,s.width}return o.OZ.Dom.getCanvasTextWidth(t,e)}arc(t,e,i,s,n){return this.ctx&&this.ctx.arc(t,e,i,s,n),this}fillCircle(t,e,i){return this.ctx?(this.ctx.beginPath(),this.ctx.arc(t,e,i,0,2*Math.PI),this.ctx.fill(),this):this}strokeLine(t,e,i,s){return this.ctx?(this.ctx.beginPath(),this.ctx.moveTo(t,e),this.ctx.lineTo(i,s),this.ctx.stroke(),this):this}strokePartialLine(t,e,i,s,n,o){if(!this.ctx)return this;let r=t+(i-t)*n,a=e+(s-e)*n,h=t+(i-t)*o,c=e+(s-e)*o;return this.ctx.beginPath(),this.ctx.moveTo(r,a),this.ctx.lineTo(h,c),this.ctx.stroke(),this}drawBracket(t,e){if(!this.ctx)return this;let{left:i,right:s,width:n,top:o,bottom:r,height:a,anchorY:h}=t;switch([")","]","}",">"].includes(e)&&([i,s,n]=[s,i,-n]),e){case"(":case")":this.ctx.beginPath(),this.ctx.moveTo(s,o),this.ctx.bezierCurveTo(i-.2*n,o+.3*a,i-.2*n,o+.7*a,s,r),this.ctx.stroke();break;case"{":case"}":this.ctx.beginPath(),this.ctx.moveTo(s,o),this.ctx.bezierCurveTo(i+.1*n,o,i+.8*n,h,i,h),this.ctx.moveTo(s,r),this.ctx.bezierCurveTo(i+.1*n,r,i+.8*n,h,i,h),this.ctx.stroke();break;case"[":case"]":this.ctx.beginPath(),this.ctx.moveTo(s,o),this.ctx.lineTo(i,o),this.ctx.lineTo(i,r),this.ctx.lineTo(s,r),this.ctx.stroke();break;case"<":case">":this.ctx.beginPath(),this.ctx.moveTo(s,o),this.ctx.lineTo(i,h),this.ctx.lineTo(s,r),this.ctx.stroke()}return this}},mt=class{constructor(t){this.measure=t,(0,r.Mu)(this,"accidentalByDiatonicId",[])}getAccidentalFromKeySignature(t){let e=this.measure.getKeySignature().getOrderedAccidentalNotes().find(e=>e.diatonicClass===a.L7.getDiatonicClass(t));return e?e.accidental:void 0}setAccidental(t){this.accidentalByDiatonicId[t.diatonicId]=t.accidental}needAccidental(t){var e,i;let s=null!=(i=null!=(e=this.accidentalByDiatonicId[t.diatonicId])?e:this.getAccidentalFromKeySignature(t.diatonicId))?i:0;return t.accidental!==s}},Ct=class extends rt{constructor(t,e,i,s,n){super(t),this.image=e,this.anchorX=i,this.anchorY=s,this.imageScale=n,(0,r.Mu)(this,"mi"),this.mi=new ni(this)}getMusicInterface(){return this.mi}pick(t,e){return this.rect.contains(t,e)?[this]:[]}layout(t){let{anchorX:e,anchorY:i,image:s,imageScale:n}=this,{unitSize:r}=t;try{let t=s.naturalWidth*n*r,a=s.naturalHeight*n*r;this.rect=o.vW.createSections(t*e,t*(1-e),a*i,a*(1-i))}catch(a){this.rect=new o.vW}}offset(t,e){this.rect.offsetInPlace(t,e)}draw(t){let e=this.rect;t.drawDebugRect(e),t.drawImage(this.image,e.anchorX-e.leftw,e.anchorY-e.toph,e.width,e.height)}},pt=class extends rt{constructor(t,e,i,s="black"){super(t),this.diatonicId=e,this.accidental=i,this.color=s,(0,r.Mu)(this,"mi"),this.mi=new We(this)}getMusicInterface(){return this.mi}pick(t,e){return this.rect.contains(t,e)?[this]:[]}layout(t){let{unitSize:e}=t;switch(this.accidental){case-2:this.rect=o.vW.createSections(1.25*e,1.25*e,4*e,1.2*e);break;case-1:this.rect=o.vW.createSections(.75*e,.75*e,4*e,1.2*e);break;case 0:this.rect=o.vW.createSections(.75*e,.75*e,2.2*e,2.2*e);break;case 1:this.rect=o.vW.createSections(.75*e,.75*e,2*e,2*e);break;case 2:this.rect=o.vW.createSections(1*e,1*e,1*e,1*e);break;default:throw new h.O1(h.mN.Score,"Invalid accidental value: "+this.accidental)}}offset(t,e){this.rect.offsetInPlace(t,e)}draw(t){t.drawDebugRect(this.rect);let{unitSize:e}=t,{accidental:i}=this,s=this.rect.anchorX,n=this.rect.anchorY;t.color(this.color);const o=(i,s)=>{t.lineWidth(1).beginPath().moveTo(i-.75*e,s-4*e).lineTo(i-.75*e,s+1.1*e).bezierCurveTo(i+.75*e,s-0*e,i+.75*e,s-2.2*e,i-.75*e,s-.5*e).stroke()};-2===i?(o(s-.5*e,n),o(s+.5*e,n)):-1===i&&o(s,n),0===i?t.beginPath().lineWidth(1).moveTo(s-.5*e,n-2.2*e).lineTo(s-.5*e,n+1*e).moveTo(s+.5*e,n+2.2*e).lineTo(s+.5*e,n-1*e).stroke().beginPath().lineWidth(2).moveTo(s-.5*e,n+1*e).lineTo(s+.5*e,n+.6*e).moveTo(s+.5*e,n-1*e).lineTo(s-.5*e,n-.6*e).stroke():1===i?t.lineWidth(1).beginPath().moveTo(s-.3*e,n-1.6*e).lineTo(s-.3*e,n+2*e).moveTo(s+.3*e,n-2*e).lineTo(s+.3*e,n+1.6*e).stroke().lineWidth(2).beginPath().moveTo(s-.75*e,n-.5*e).lineTo(s+.75*e,n-.9*e).moveTo(s-.75*e,n+.9*e).lineTo(s+.75*e,n+.5*e).stroke():2===i&&t.lineWidth(1).beginPath().moveTo(s-.75*e,n-.75*e).lineTo(s+.75*e,n+.75*e).moveTo(s-.75*e,n+.75*e).lineTo(s+.75*e,n-.75*e).stroke().fillRect(s-1*e,n-1*e,.7*e,.7*e).fillRect(s+.3*e,n-1*e,.7*e,.7*e).fillRect(s-1*e,n+.3*e,.7*e,.7*e).fillRect(s+.3*e,n+.3*e,.7*e,.7*e)}},At=class extends rt{constructor(t,e,i,s){var n,a,h,c,g,u;super(t),this.anchorX=i,this.anchorY=s,(0,r.Mu)(this,"text"),(0,r.Mu)(this,"scale"),(0,r.Mu)(this,"color"),(0,r.Mu)(this,"bold"),(0,r.Mu)(this,"italic"),(0,r.Mu)(this,"boxed"),(0,r.Mu)(this,"padding"),(0,r.Mu)(this,"bgcolor"),(0,r.Mu)(this,"font",""),(0,r.Mu)(this,"textLines"),(0,r.Mu)(this,"lineWidths",[]),(0,r.Mu)(this,"lineHeight",0),(0,r.Mu)(this,"mi");let l="string"==typeof e?{text:e}:e;this.text=l.text,this.scale=null!=(n=l.scale)?n:1,this.color=null!=(a=l.color)?a:"black",this.bold=null!=(h=l.bold)&&h,this.italic=null!=(c=l.italic)&&c,this.boxed=null!=(g=l.boxed)&&g,this.padding=null!=(u=l.padding)?u:this.boxed?.5:0,this.bgcolor=l.bgcolor,(!isFinite(this.padding)||this.padding<0)&&(this.padding=0),this.textLines=this.text.split("\n"),0===this.textLines.length&&(this.textLines=[""]),this.rect=new o.vW,this.mi=new Ui(this)}getMusicInterface(){return this.mi}getText(){return this.text}pick(t,e){return this.rect.contains(t,e)?[this]:[]}layout(t){let{scale:e,anchorX:i,anchorY:s,bold:n,italic:r}=this,a=t.fontSize*e;this.font=(r?"italic ":"")+(n?"bold ":"")+a+"px Times New Roman",this.lineWidths=this.textLines.map(e=>t.getTextWidth(e,this.font)),this.lineHeight=a;let h=this.padding*t.unitSize,c=h+Math.max(...this.lineWidths)+h,g=h+this.lineHeight*this.textLines.length+h;"square"!==this.boxed&&"circle"!==this.boxed||(g=c=Math.max(g,c)),this.rect=o.vW.createSections(c*i,c*(1-i),g*s,g*(1-s))}offset(t,e){this.rect.offsetInPlace(t,e)}draw(t){var e;t.drawDebugRect(this.rect),t.lineWidth(1).font(this.font);let{rect:i,padding:s,lineHeight:n,lineWidths:o,anchorX:r,anchorY:a,italic:h}=this;void 0!==this.bgcolor&&(t.save(),t.fillColor(null!=(e=this.bgcolor)?e:"black"),t.beginPath(),t.fillRect(i.left,i.top,i.width,i.height),t.fill(),t.restore());let c=this.textLines.length*n,g=-n*(h?.25:.2),u=s*t.unitSize,l=(i.left+u)*(1-r)+(i.right-u)*r,d=(i.top+u)*(1-a)+(i.bottom-u)*a;switch(t.color(this.color),this.textLines.forEach((e,i)=>{let s=l-o[i]*r,h=d-c*a+n*(i+1)+g;t.fillText(e,s,h)}),this.boxed){case"square":case"rectangle":t.strokeRect(i.left,i.top,i.width,i.height);break;case"circle":case"ellipse":t.beginPath(),t.ellipse(i.centerX,i.centerY,i.width/2,i.height/2,0,0,2*Math.PI),t.stroke()}}},bt=class extends rt{constructor(t,e){super(t),this.measure=t,this.staff=e,(0,r.Mu)(this,"clefImage"),(0,r.Mu)(this,"eightBelowClef"),(0,r.Mu)(this,"measureNumber"),(0,r.Mu)(this,"ksNeutralizeAccidentals",[]),(0,r.Mu)(this,"ksNewAccidentals",[]),(0,r.Mu)(this,"beatCountText"),(0,r.Mu)(this,"beatSizeText"),(0,r.Mu)(this,"tempoText"),(0,r.Mu)(this,"mi"),this.mi=new Pi(this)}get doc(){return this.measure.doc}getMusicInterface(){return this.mi}updateClefImage(t,e){if(e){let e=P.Staff_Signature_Clef;["black","#000","#000000"].includes(e)&&(e="");let i=t.getImageAsset(this.staff.clefImageAsset,e);this.clefImage=i?new Ct(this,i,0,.5,.1):void 0,this.eightBelowClef=this.clefImage&&this.staff.isOctaveDown?new At(this,{text:"8",color:e},.5,0):void 0}else this.clefImage=void 0}updateMeasureNumber(t){if(t){let t=P.Staff_Signature_MeasureNum,e=this.measure.getMeasureNumber().toString();this.measureNumber=new At(this,{text:e,color:t},0,1)}else this.measureNumber=void 0}updateKeySignature(t){if(t){let{measure:t}=this,e=P.Staff_Signature_Key,i=t.getPrevMeasure(),s=i?i.getKeySignature():void 0,n=t.getKeySignature();this.ksNeutralizeAccidentals=[],this.ksNewAccidentals=[],s&&!a.u9.equals(n,s)&&s.getOrderedAccidentalNotes().forEach(t=>{this.ksNeutralizeAccidentals.push(new pt(this,this.getAccidentalDiatonicId(t),0,e))}),n.getOrderedAccidentalNotes().forEach(t=>{this.ksNewAccidentals.push(new pt(this,this.getAccidentalDiatonicId(t),t.accidental,e))})}else this.ksNeutralizeAccidentals=[],this.ksNewAccidentals=[]}updateTimeSignature(t){if(t){let t=this.measure.getTimeSignature(),e=P.Staff_Signature_Time,i=t.beatCount.toString();this.beatCountText=new At(this,{text:i,color:e,scale:1.4},.5,.5);let s=t.beatSize.toString();this.beatSizeText=new At(this,{text:s,color:e,scale:1.4},.5,.5)}else this.beatCountText=this.beatSizeText=void 0}updateTempo(t){if(t){let t=P.Staff_Signature_Tempo,e=(0,a.Xm)(this.measure.getTempo());this.tempoText=new At(this,{text:e,color:t},.5,1)}else this.tempoText=void 0}getAccidentalDiatonicId(t){let e,{clef:i}=this.staff.staffConfig;if("G"===i?t.accidental>0?e=this.staff.bottomLineDiatonicId+3:t.accidental<0&&(e=this.staff.bottomLineDiatonicId+1):"F"===i&&(t.accidental>0?e=this.staff.bottomLineDiatonicId+1:t.accidental<0&&(e=this.staff.bottomLineDiatonicId-1)),void 0!==e)return a.L7.findNextDiatonicIdAbove(t.diatonicId,e,!1);throw new h.O1(h.mN.Score,"Cannot get accidental diatonicId because note has no accidental.")}pick(t,e){if(!this.rect.contains(t,e))return[];if(this.eightBelowClef){let i=this.eightBelowClef.pick(t,e);if(i.length>0)return[this,...i]}if(this.clefImage){let i=this.clefImage.pick(t,e);if(i.length>0)return[this,...i]}for(let i=0;i<this.ksNeutralizeAccidentals.length;i++){let s=this.ksNeutralizeAccidentals[i].pick(t,e);if(s.length>0)return[this,...s]}for(let i=0;i<this.ksNewAccidentals.length;i++){let s=this.ksNewAccidentals[i].pick(t,e);if(s.length>0)return[this,...s]}if(this.beatCountText){let i=this.beatCountText.pick(t,e);if(i.length>0)return[this,...i]}if(this.beatSizeText){let i=this.beatSizeText.pick(t,e);if(i.length>0)return[this,...i]}if(this.tempoText){let i=this.tempoText.pick(t,e);if(i.length>0)return[this,...i]}if(this.measureNumber){let i=this.measureNumber.pick(t,e);if(i.length>0)return[this,...i]}return[this]}layout(t){var e,i,s,n,r,a;let{unitSize:h}=t,{staff:c}=this,g=h,u=0;if(this.rect=new o.vW,this.clefImage&&(u+=g,this.clefImage.layout(t),this.clefImage.setAnchor(u,c.getDiatonicIdY(c.clefLineDiatonicId)),this.rect.expandInPlace(this.clefImage.getRect()),u=this.rect.right,this.eightBelowClef)){let e=this.clefImage.getRect();this.eightBelowClef.layout(t),this.eightBelowClef.setCenterX(e.centerX),this.eightBelowClef.setTop(Math.max(e.anchorY+.3*e.height,c.getBottomLineY())),this.rect.expandInPlace(this.eightBelowClef.getRect())}this.measureNumber&&(this.measureNumber.layout(t),this.measureNumber.setLeft(0),this.measureNumber.setBottom(Math.min(c.getTopLineY(),this.clefImage?this.clefImage.getRect().top:c.getTopLineY())),this.rect.expandInPlace(this.measureNumber.getRect()),u=Math.max(u,this.rect.right)),this.ksNeutralizeAccidentals.length>0&&(u+=g,this.ksNeutralizeAccidentals.forEach(e=>{e.layout(t),e.setLeft(u),e.setAnchorY(c.getDiatonicIdY(e.diatonicId)),this.rect.expandInPlace(e.getRect()),u=this.rect.right})),this.ksNewAccidentals&&(u+=g,this.ksNewAccidentals.forEach(e=>{e.layout(t),e.setLeft(u),e.setAnchorY(c.getDiatonicIdY(e.diatonicId)),this.rect.expandInPlace(e.getRect()),u=this.rect.right}));let l=u;null==(e=this.beatCountText)||e.layout(t),null==(i=this.beatSizeText)||i.layout(t);let d=Math.max(null!=(n=null==(s=this.beatCountText)?void 0:s.getRect().width)?n:0,null!=(a=null==(r=this.beatSizeText)?void 0:r.getRect().width)?a:0);this.beatCountText&&(this.beatCountText.setCenter(u+d/2+g,c.getDiatonicIdY(c.middleLineDiatonicId+2)),this.rect.expandInPlace(this.beatCountText.getRect()),l=Math.max(l,this.rect.right)),this.beatSizeText&&(this.beatSizeText.setCenter(u+d/2+g,c.getDiatonicIdY(c.bottomLineDiatonicId+2)),this.rect.expandInPlace(this.beatSizeText.getRect()),l=Math.max(l,this.rect.right)),u=l,this.tempoText&&(this.tempoText.layout(t),this.tempoText.setCenterX(u),this.tempoText.setBottom(c.getTopLineY()),this.clefImage&&o.vW.overlap(this.clefImage.getRect(),this.tempoText.getRect())&&this.tempoText.setBottom(this.clefImage.getRect().top),[...this.ksNeutralizeAccidentals,...this.ksNewAccidentals].forEach(t=>{this.tempoText&&o.vW.overlap(t.getRect(),this.tempoText.getRect())&&this.tempoText.setBottom(t.getRect().top)}),this.rect.expandInPlace(this.tempoText.getRect())),this.rect.right+=g}offset(t,e){var i,s,n,o,r,a;null==(i=this.clefImage)||i.offset(t,e),null==(s=this.eightBelowClef)||s.offset(t,e),null==(n=this.measureNumber)||n.offset(t,e),this.ksNeutralizeAccidentals.forEach(i=>i.offset(t,e)),this.ksNewAccidentals.forEach(i=>i.offset(t,e)),null==(o=this.beatCountText)||o.offset(t,e),null==(r=this.beatSizeText)||r.offset(t,e),null==(a=this.tempoText)||a.offset(t,e),this.rect.offsetInPlace(t,e)}draw(t){var e,i,s,n,o,r;null==(e=this.clefImage)||e.draw(t),null==(i=this.eightBelowClef)||i.draw(t),null==(s=this.measureNumber)||s.draw(t),this.ksNeutralizeAccidentals.forEach(e=>e.draw(t)),this.ksNewAccidentals.forEach(e=>e.draw(t)),null==(n=this.beatCountText)||n.draw(t),null==(o=this.beatSizeText)||o.draw(t),null==(r=this.tempoText)||r.draw(t)}},yt=class extends rt{constructor(t,e){super(t),this.measure=t,this.tab=e,(0,r.Mu)(this,"measureNumber"),(0,r.Mu)(this,"beatCountText"),(0,r.Mu)(this,"beatSizeText"),(0,r.Mu)(this,"tempoText"),(0,r.Mu)(this,"mi"),this.mi=new Di(this)}getMusicInterface(){return this.mi}get doc(){return this.measure.doc}updateMeasureNumber(t){if(t){let t=P.Tab_Signature_MeasureNum,e=this.measure.getMeasureNumber().toString();this.measureNumber=new At(this,{text:e,color:t},0,1)}else this.measureNumber=void 0}updateTimeSignature(t){if(t){let t=this.measure.getTimeSignature(),e=P.Tab_Signature_Time,i=t.beatCount.toString();this.beatCountText=new At(this,{text:i,color:e,scale:1.4},.5,.5);let s=t.beatSize.toString();this.beatSizeText=new At(this,{text:s,color:e,scale:1.4},.5,.5)}else this.beatCountText=this.beatSizeText=void 0}updateTempo(t){if(t){let t=P.Tab_Signature_Tempo,e=(0,a.Xm)(this.measure.getTempo());this.tempoText=new At(this,{text:e,color:t},0,1)}else this.tempoText=void 0}pick(t,e){if(!this.rect.contains(t,e))return[];if(this.beatCountText){let i=this.beatCountText.pick(t,e);if(i.length>0)return[this,...i]}if(this.beatSizeText){let i=this.beatSizeText.pick(t,e);if(i.length>0)return[this,...i]}if(this.tempoText){let i=this.tempoText.pick(t,e);if(i.length>0)return[this,...i]}if(this.measureNumber){let i=this.measureNumber.pick(t,e);if(i.length>0)return[this,...i]}return[this]}layout(t){var e,i,s,n,r,a;let{unitSize:h}=t,{tab:c}=this,g=h,u=0,l=c.getTopLineY();this.rect=new o.vW,this.measureNumber&&(this.measureNumber.layout(t),this.measureNumber.setLeft(0),this.measureNumber.setBottom(l),this.rect.expandInPlace(this.measureNumber.getRect()),u=Math.max(u,this.rect.right)),null==(e=this.beatCountText)||e.layout(t),null==(i=this.beatSizeText)||i.layout(t);let d=Math.max(null!=(n=null==(s=this.beatCountText)?void 0:s.getRect().width)?n:0,null!=(a=null==(r=this.beatSizeText)?void 0:r.getRect().width)?a:0);this.beatCountText&&(this.beatCountText.setCenter(0+d/2+g,c.getRect().anchorY-this.beatCountText.getRect().bottomh),this.rect.expandInPlace(this.beatCountText.getRect())),this.beatSizeText&&(this.beatSizeText.setCenter(0+d/2+g,c.getRect().anchorY+this.beatSizeText.getRect().toph),this.rect.expandInPlace(this.beatSizeText.getRect())),this.tempoText&&(this.tempoText.layout(t),this.tempoText.setLeft(u+2*h),this.tempoText.setBottom(l),this.rect.expandInPlace(this.tempoText.getRect())),this.rect.right+=g}offset(t,e){var i,s,n,o;null==(i=this.measureNumber)||i.offset(t,e),null==(s=this.beatCountText)||s.offset(t,e),null==(n=this.beatSizeText)||n.offset(t,e),null==(o=this.tempoText)||o.offset(t,e),this.rect.offsetInPlace(t,e)}draw(t){var e,i,s,n;null==(e=this.measureNumber)||e.draw(t),null==(i=this.beatCountText)||i.draw(t),null==(s=this.beatSizeText)||s.draw(t),null==(n=this.tempoText)||n.draw(t)}},vt=class extends rt{constructor(t,e,i){super(t),this.col=t,this.line=e,this.arpeggioDir=i,(0,r.Mu)(this,"topArrowHeight",0),(0,r.Mu)(this,"bottomArrowHeight",0),(0,r.Mu)(this,"cycleHeight",0),(0,r.Mu)(this,"numCycles",0),(0,r.Mu)(this,"color","black"),(0,r.Mu)(this,"mi"),this.mi=new Ze(this)}getMusicInterface(){return this.mi}pick(t,e){return this.rect.contains(t,e)?[this]:[]}layout(t){let{unitSize:e}=t;this.topArrowHeight="up"===this.arpeggioDir?e:0,this.bottomArrowHeight="down"===this.arpeggioDir?e:0;let i=this.line.getTopLineY(),s=this.line.getBottomLineY();this.cycleHeight=2*e,this.numCycles=Math.ceil((s-i)/this.cycleHeight)+2;let n=2*e,r=this.numCycles*this.cycleHeight;this.rect=new o.vW(-n/2,n/2,-r/2-this.topArrowHeight,r/2+this.bottomArrowHeight)}offset(t,e){this.rect.offsetInPlace(t,e)}draw(t){let{rect:e,topArrowHeight:i,bottomArrowHeight:s}=this;t.drawDebugRect(this.rect),t.color(this.color),t.lineWidth(2),t.beginPath();for(let n=0,o=e.top+i;n<this.numCycles;n++,o+=this.cycleHeight)t.moveTo(e.anchorX,o),t.quadraticCurveTo(e.left,o+this.cycleHeight/4,e.anchorX,o+this.cycleHeight/2),t.quadraticCurveTo(e.right,o+3*this.cycleHeight/4,e.anchorX,o+this.cycleHeight);t.stroke(),i>0&&(t.beginPath(),t.moveTo(e.anchorX,e.top),t.lineTo(e.right,e.top+i),t.lineTo(e.left,e.top+i),t.fill()),s>0&&(t.beginPath(),t.moveTo(e.anchorX,e.bottom),t.lineTo(e.left,e.bottom-s),t.lineTo(e.right,e.bottom-s),t.fill())}};var wt=class extends rt{constructor(t,e){super(t),this.staff=t,this.rest=e,(0,r.Mu)(this,"restRect",new o.vW),(0,r.Mu)(this,"dotRects",[]),(0,r.Mu)(this,"mi"),t.addObject(this),this.mi=new vi(this)}getMusicInterface(){return this.mi}pick(t,e){return this.getRect().contains(t,e)?[this]:[]}offset(t,e){this.restRect.offsetInPlace(t,e),this.dotRects.forEach(i=>i.offsetInPlace(t,e)),this.requestRectUpdate(),this.rest.requestRectUpdate()}updateRect(){this.rect=this.restRect.clone(),this.dotRects.forEach(t=>this.rect.expandInPlace(t))}},Mt=class t extends rt{constructor(e,i,s,n,o){var h,c,g,u,l;super(e),this.col=e,this.voiceId=i,this.options=n,(0,r.Mu)(this,"color"),(0,r.Mu)(this,"hide"),(0,r.Mu)(this,"oldStyleTriplet"),(0,r.Mu)(this,"rhythmProps"),(0,r.Mu)(this,"setDiatonicId"),(0,r.Mu)(this,"runningDiatonicId"),(0,r.Mu)(this,"runningStemDir"),(0,r.Mu)(this,"beamGroup"),(0,r.Mu)(this,"staffObjects",[]),(0,r.Mu)(this,"mi"),this.setDiatonicId=null!=(c="number"==typeof(l=null==(h=this.options)?void 0:h.staffPos)?a.L7.getChromaticNote(l).diatonicId:"string"==typeof l?a.L7.getNote(l).diatonicId:l instanceof a.L7?l.diatonicId:void 0)?c:t.UndefinedDiatonicId;let d=this.row.getStaves().filter(t=>t.containsVoiceId(this.voiceId));this.setDiatonicId!==t.UndefinedDiatonicId&&d.length>0&&d[0].isSpace(this.setDiatonicId)&&(this.setDiatonicId+=this.setDiatonicId>=d[0].middleLineDiatonicId?1:-1),this.runningDiatonicId=this.setDiatonicId,this.runningStemDir="up",this.color=null!=(g=null==n?void 0:n.color)?g:P.Staff_Rest,this.hide=null!=(u=null==n?void 0:n.hide)&&u,this.oldStyleTriplet=void 0===o&&a.Xp.get(s).isTriplet,this.rhythmProps=a.R6.get(s,void 0,(null!=o?o:this.oldStyleTriplet)?a.Jh.Triplet:void 0),this.mi=new bi(this)}getMusicInterface(){return this.mi}get doc(){return this.col.doc}get measure(){return this.col.measure}get row(){return this.col.row}get noteLength(){return this.rhythmProps.noteLength}getDiatonicId(e){return this.runningDiatonicId===t.UndefinedDiatonicId?e?a.Xp.equals(this.noteLength,"1n")?e.middleLineDiatonicId+2:e.middleLineDiatonicId:a.L7.getNote("G4").diatonicId:this.runningDiatonicId}get stemDir(){return this.runningStemDir}updateRunningArguments(t,e,i){this.runningDiatonicId=t,this.runningStemDir=e}getStaticObjects(t){let e=[];return this.staffObjects.forEach(i=>{i.staff===t&&e.push(i)}),e}pick(t,e){if(!this.getRect().contains(t,e))return[];for(let i=0;i<this.staffObjects.length;i++){let s=this.staffObjects[i].pick(t,e);if(s.length>0)return[this,...s]}return[]}getBeamGroup(){return this.beamGroup}setBeamGroup(t){this.beamGroup=t}resetBeamGroup(){this.beamGroup=void 0}getBeamCoords(){return this.staffObjects.map(t=>{let e=t.staff,i=t.getRect().anchorX,s="up"===this.stemDir?t.getRect().top:t.getRect().bottom;return{staff:e,x:i,y:s,stemHeight:Math.abs(t.getRect().anchorY-s)}})}hasTuplet(){return void 0!==this.rhythmProps.tupletRatio}isEmpty(){return 0===this.staffObjects.length}visibleInStaff(t){return t.containsVoiceId(this.voiceId)&&this.staffObjects.some(e=>e instanceof wt&&e.staff===t)}getRestDotVerticalDisplacement(t){switch(t){case 1:return 1;case 2:case 4:case 8:case 16:return-1;case 32:case 64:return-3;default:throw new h.O1(h.mN.Score,`Get rest dot vertical displacement: Invalid note size: ${t}`)}}updateAccidentalState(t){}layout(t,e){if(this.requestRectUpdate(),this.staffObjects.length=0,this.hide)return;let{unitSize:i}=t,{noteSize:s,dotCount:n}=this.rhythmProps;this.row.getStaves().forEach(e=>{let r=this.getDiatonicId(e);if(!e.containsDiatonicId(r)||!e.containsVoiceId(this.voiceId))return;let a=new wt(e,this);a.restRect=t.getRestRect(s);for(let t=0;t<n;t++){let e=y*i,n=a.restRect.rightw+(T+y*i)+t*y*i*1.5,r=this.getRestDotVerticalDisplacement(s)*i;a.dotRects.push(o.vW.createCentered(n,r,e,e))}a.setAnchor(0,e.getDiatonicIdY(r)),this.staffObjects.push(a),this.measure.addStaticObject(e,a)})}updateRect(){if(0===this.staffObjects.length)this.rect=new o.vW;else if(this.rect=this.staffObjects[0].getRect().clone(),this.staffObjects.length>1)for(let t=1;t<this.staffObjects.length;t++)this.rect.expandInPlace(this.staffObjects[t].getRect())}offset(t,e){this.staffObjects.forEach(e=>e.offset(t,0)),this.requestRectUpdate()}draw(t){if(0===this.staffObjects.length)return;t.drawDebugRect(this.getRect());let{noteSize:e}=this.rhythmProps;t.color(this.color).lineWidth(1),this.staffObjects.forEach(i=>{let{dotRects:s,restRect:n}=i;t.drawRest(e,n.anchorX,n.anchorY),s.forEach(e=>t.fillCircle(e.anchorX,e.anchorY,e.width/2))})}};(0,r.Mu)(Mt,"UndefinedDiatonicId",1/0);var St=Mt;var Rt=class extends rt{constructor(t,e){super(t),this.staff=t,this.noteGroup=e,(0,r.Mu)(this,"noteHeadRects",[]),(0,r.Mu)(this,"dotRects",[]),(0,r.Mu)(this,"accidentals",[]),(0,r.Mu)(this,"stemTip"),(0,r.Mu)(this,"stemBase"),(0,r.Mu)(this,"flagRects",[]),(0,r.Mu)(this,"prevTopNoteY",0),(0,r.Mu)(this,"prevBottomNoteY",0),(0,r.Mu)(this,"mi"),this.mi=new mi(this)}getMusicInterface(){return this.mi}pick(t,e){if(!this.getRect().contains(t,e))return[];for(let i=0;i<this.accidentals.length;i++){let s=this.accidentals[i].pick(t,e);if(s.length>0)return[this,...s]}return[this]}updateRect(){this.rect=this.noteHeadRects[0].clone(),this.noteHeadRects.forEach(t=>this.rect.expandInPlace(t)),this.stemTip&&this.rect.expandInPlace(this.stemTip),this.stemBase&&this.rect.expandInPlace(this.stemBase),this.dotRects.forEach(t=>this.rect.expandInPlace(t)),this.flagRects.forEach(t=>this.rect.expandInPlace(t)),this.accidentals.forEach(t=>this.rect.expandInPlace(t.getRect()))}getRect(){let t=this.noteHeadRects[0],e=this.noteHeadRects[this.noteHeadRects.length-1];return this.prevTopNoteY===e.anchorY&&this.prevBottomNoteY===t.anchorY||(this.prevTopNoteY=e.anchorY,this.prevBottomNoteY=t.anchorY,this.requestRectUpdate()),super.getRect()}offset(t,e){var i,s;this.noteHeadRects.forEach(i=>i.offsetInPlace(t,e)),this.dotRects.forEach(i=>i.offsetInPlace(t,e)),this.accidentals.forEach(i=>i.offset(t,e)),null==(i=this.stemTip)||i.offsetInPlace(t,e),null==(s=this.stemBase)||s.offsetInPlace(t,e),this.flagRects.forEach(i=>i.offsetInPlace(t,e)),this.requestRectUpdate(),this.noteGroup.requestRectUpdate()}},xt=class extends rt{constructor(t,e){super(t),this.tab=t,this.noteGroup=e,(0,r.Mu)(this,"fretNumbers",[]),(0,r.Mu)(this,"mi"),this.mi=new pi(this)}getMusicInterface(){return this.mi}pick(t,e){return this.getRect().contains(t,e)?[this]:[]}updateRect(){this.rect=this.fretNumbers[0].getRect().clone(),this.fretNumbers.forEach(t=>this.rect.expandInPlace(t.getRect()))}offset(t,e){this.fretNumbers.forEach(i=>i.offset(t,e)),this.requestRectUpdate(),this.noteGroup.requestRectUpdate()}},Lt=class t extends rt{constructor(t,e,i,s,n,c){var g,u,l;if(super(t),this.col=t,this.voiceId=e,this.notes=i,this.options=n,(0,r.Mu)(this,"setDiatonicId"),(0,r.Mu)(this,"setStringsNumbers"),(0,r.Mu)(this,"runningDiatonicId"),(0,r.Mu)(this,"runningStemDir"),(0,r.Mu)(this,"runningStringNumbers"),(0,r.Mu)(this,"color"),(0,r.Mu)(this,"staccato"),(0,r.Mu)(this,"diamond"),(0,r.Mu)(this,"arpeggio"),(0,r.Mu)(this,"oldStyleTriplet"),(0,r.Mu)(this,"rhythmProps"),(0,r.Mu)(this,"startConnnectives",[]),(0,r.Mu)(this,"runningConnectives",[]),(0,r.Mu)(this,"leftBeamCount",0),(0,r.Mu)(this,"rightBeamCount",0),(0,r.Mu)(this,"beamGroup"),(0,r.Mu)(this,"staffObjects",[]),(0,r.Mu)(this,"tabObjects",[]),(0,r.Mu)(this,"isNoteDisplaced"),(0,r.Mu)(this,"mi"),!o.I8.isIntegerGte(i.length,1))throw new h.O1(h.mN.Score,"Cannot create note group object because notes array is empty.");let{sortedNotes:d,sortedStrings:f}=function(t,e){let i=o.OZ.Arr.isArray(e)?e:void 0!==e?[e]:[],s=t.map((t,e)=>({note:t,string:i[e]}));return s=o.OZ.Arr.removeDuplicates(s,(t,e)=>a.L7.equals(t.note,e.note)).sort((t,e)=>a.L7.compareFunc(t.note,e.note)),{sortedNotes:s.map(t=>t.note),sortedStrings:s.every(t=>void 0===t.string)?void 0:s.map(t=>t.string)}}(i,null==n?void 0:n.string);var I;this.notes=d,this.setStringsNumbers=f,this.isNoteDisplaced=this.notes.map(()=>!1),this.setDiatonicId=Math.round((this.minDiatonicId+this.maxDiatonicId)/2),this.runningDiatonicId=this.setDiatonicId,this.runningStemDir="up",this.runningStringNumbers=[],this.color=null!=(g=null==n?void 0:n.color)?g:P.Staff_Note,this.staccato=null!=(u=null==n?void 0:n.staccato)&&u,this.diamond=null!=(l=null==n?void 0:n.diamond)&&l,this.arpeggio=(I=null==n?void 0:n.arpeggio,o.I8.isEnumValue(I,H)?I:!0===I?"up":void 0),this.oldStyleTriplet=void 0===c&&a.Xp.get(s).isTriplet,this.rhythmProps=a.R6.get(s,void 0,(null!=c?c:this.oldStyleTriplet)?a.Jh.Triplet:void 0),this.mi=new fi(this)}getMusicInterface(){return this.mi}get doc(){return this.col.doc}get measure(){return this.col.measure}get row(){return this.col.row}get minDiatonicId(){return this.notes[0].diatonicId}get maxDiatonicId(){return this.notes[this.notes.length-1].diatonicId}getDiatonicId(t){return this.runningDiatonicId}get stemDir(){return this.runningStemDir}setNoteDisplacement(t,e){let i=this.notes.indexOf(t);i>=0&&(this.isNoteDisplaced[i]=e)}enableConnective(t){return t.containsVoiceId(this.voiceId)&&(t instanceof fe||t.containsDiatonicId(this.runningDiatonicId))}startConnective(t){if(!this.row.hasStaff&&"tie"===t.connective)throw new h.O1(h.mN.Score,"Ties not implemented for guitar tabs alone, staff is required!");if(!this.row.hasStaff&&"slur"===t.connective)throw new h.O1(h.mN.Score,"Slurs not implemented for guitar tabs alone, staff is required!");this.startConnnectives.push(t),this.doc.addConnectiveProps(t)}updateRunningArguments(t,e,i){this.runningDiatonicId=t===St.UndefinedDiatonicId?this.setDiatonicId:t,this.runningStemDir=e,this.runningStringNumbers=i}pick(t,e){if(!this.getRect().contains(t,e))return[];for(let i=0;i<this.staffObjects.length;i++){let s=this.staffObjects[i].pick(t,e);if(s.length>0)return[this,...s]}for(let i=0;i<this.tabObjects.length;i++){let s=this.tabObjects[i].pick(t,e);if(s.length>0)return[this,...s]}return[]}getTopNote(){return this.notes[this.notes.length-1]}getBottomNote(){return this.notes[0]}getConnectiveAnchorPoint(t,e,i,s,n){var o;if(!(e instanceof de)){if(e instanceof fe){let s=null==(o=this.tabObjects.find(t=>t.tab===e))?void 0:o.fretNumbers[i];if(!s)return{x:0,y:0};let r,a=s.getRect(),h="right"===n?a.left:a.right,c=.9;if("slide"===t.connective){let i=t.noteGroups[0].getFretNumber(e,0),s=t.noteGroups[1].getFretNumber(e,0),o=void 0===i||void 0===s||i<=s;r="left"===n?(o?a.anchorY+a.bottomh:a.anchorY-a.toph)*c:(o?a.anchorY-a.toph:a.anchorY+a.bottomh)*c}else r=a.anchorY+a.bottomh*c;return{x:h,y:r}}return{x:0,y:0}}{if(i<0||i>=this.notes.length)throw new h.O1(h.mN.Score,"Invalid noteIndex: "+i);let t=this.staffObjects.find(t=>t.staff===e);if(!t||i<0||i>=t.noteHeadRects.length){let t=this.getRect();return{x:t.anchorX,y:t.bottom}}let o=t.noteHeadRects[i],r=t.stemTip,a=this.stemDir,c=void 0!==r,g=c?"up"===a?"right":"left":void 0,u=o.height/2,l=o.anchorX,d=o.anchorY,f=o.left-u,I=o.right+u,m=o.top-u,C=o.bottom+u;switch("auto"===s?s="below":"stemTip"!==s||c||(s="up"===a?"above":"below"),s){case"center":return"left"===n?{x:I,y:d}:{x:f,y:d};case"above":return c&&"down"!==a?{x:"left"===n&&"right"===g?I:"right"===n&&"left"===g?f:l,y:m}:{x:l,y:m};case"below":return c&&"up"!==a?{x:"left"===n&&"right"===g?I:"right"===n&&"left"===g?f:l,y:C}:{x:l,y:C};case"stemTip":return{x:l,y:r.anchorY+("up"===a?-u:u)};default:throw new h.O1(h.mN.Score,"Invalid noteAnchor: "+s)}}}getFretNumberString(t){return this.runningStringNumbers[t]}getFretNumber(t,e){let i=this.tabObjects.find(e=>e.tab===t),s=null==i?void 0:i.fretNumbers[e];return s?parseInt(s.getText()):void 0}getNextNoteGroup(){let e=this.measure.getVoiceSymbols(this.voiceId).filter(e=>e instanceof t),i=e.indexOf(this);if(i<0)return;if(i<e.length-1)return e[i+1];let s=this.measure.getNextMeasure();for(;s;){let e=s.getVoiceSymbols(this.voiceId).filter(e=>e instanceof t);if(e.length>0)return e[0];s=s.getNextMeasure()}}collectConnectiveProps(){this.startConnnectives.forEach(t=>{this.runningConnectives.push(t);let e=this.getNextNoteGroup();for(;e&&t.addNoteGroup(e);)e.runningConnectives.push(t),e=e.getNextNoteGroup()})}removeConnectiveProps(){this.runningConnectives=[]}getPlaySlur(){let t=this.runningConnectives.filter(t=>"slur"===t.connective).map(t=>t.startsWith(this)?"first":"slurred");return t.indexOf("first")>=0?"first":t.indexOf("slurred")>=0?"slurred":void 0}getBeamGroup(){return this.beamGroup}setBeamGroup(t){this.beamGroup=t}resetBeamGroup(){this.leftBeamCount=this.rightBeamCount=0,this.beamGroup=void 0}getBeamCoords(){return this.staffObjects.map(t=>{var e,i,s,n;let o=t.staff,r=null!=(i=null==(e=t.stemTip)?void 0:e.anchorX)?i:t.noteHeadRects[0].anchorX,a=null!=(n=null==(s=t.stemTip)?void 0:s.anchorY)?n:"up"===this.stemDir?t.getRect().top:t.getRect().bottom;return{staff:o,x:r,y:a,stemHeight:"up"===this.stemDir?Math.abs(t.noteHeadRects[0].anchorY-a):Math.abs(t.noteHeadRects[t.noteHeadRects.length-1].anchorY-a)}})}getStemHeight(t){let{unitSize:e}=t,{flagCount:i,hasStem:s}=this.rhythmProps;if(s){let t=this.hasBeamCount()?R:S;return(v+Math.max(0,i-1)*t)*e}return 0}hasBeamCount(){return this.leftBeamCount>0||this.rightBeamCount>0}getLeftBeamCount(){return this.leftBeamCount}getRightBeamCount(){return this.rightBeamCount}setLeftBeamCount(t){this.leftBeamCount=t}setRightBeamCount(t){this.rightBeamCount=t}hasTuplet(){return void 0!==this.rhythmProps.tupletRatio}isEmpty(){return 0===this.staffObjects.length&&0===this.tabObjects.length}visibleInStaff(t){return t.containsVoiceId(this.voiceId)&&this.staffObjects.some(e=>e instanceof Rt&&e.staff===t)}getPlayTicks(t){let e=this.runningConnectives.filter(t=>"tie"===t.connective).map(e=>{let i=e.noteGroups,s=i.indexOf(this);if(s<0)return 0;if("stub"===e.span||"toMeasureEnd"===e.span)return Math.max(this.rhythmProps.ticks,this.measure.getMeasureTicks()-this.col.positionTicks);let n=i[s-1];return n&&n.notes.some(e=>a.L7.equals(e,t))?0:(i=i.slice(s),s=i.findIndex(e=>e.notes.every(e=>!a.L7.equals(e,t))),s>=0&&(i=i.slice(0,s)),o.OZ.Math.sum(i.map(t=>t.rhythmProps.ticks)))});return 0===e.length?this.rhythmProps.ticks:Math.max(...e)}updateAccidentalState(t){this.notes.forEach(e=>{t.needAccidental(e)&&t.setAccidental(e)})}layout(t,e){this.requestRectUpdate();let{unitSize:i}=t,{row:s,stemDir:n}=this,{dotCount:r,flagCount:a,hasStem:h}=this.rhythmProps,c=y*i,g=(this.diamond?b:p)*i,u=(this.diamond?b:A)*i;this.staffObjects.length=0,s.getStaves().forEach(s=>{if(!s.containsDiatonicId(this.runningDiatonicId)||!s.containsVoiceId(this.voiceId))return;let l=new Rt(s,this),d=s,f=s;this.notes.forEach((a,h)=>{var I;let p=0===h,A=h===this.notes.length-1,b=null!=(I=s.getActualStaff(a.diatonicId))?I:s,y=this.isNoteDisplaced[h]?g*("down"===n?-1:1):0,v=b.getDiatonicIdY(a.diatonicId),w=b.isLine(a.diatonicId);p&&"up"===n&&(d=b),A&&"up"===n&&(f=b),p&&"down"===n&&(f=b),A&&"down"===n&&(d=b);let M=l.noteHeadRects[h]=o.vW.createCentered(y,v,g,u);if(b.addObject(M),e.needAccidental(a)){let e=l.accidentals[h]=new pt(this,a.diatonicId,a.accidental,this.color);e&&(e.layout(t),e.setAnchor(-M.leftw-i*C-e.getRect().rightw,v)),b.addObject(e)}for(let t=0;t<r;t++){let e=M.right+m*i+c/2+t*c*1.5,r=v+this.getDotVerticalDisplacement(s,a.diatonicId,n)*i,h=o.vW.createCentered(e,r,c,c);l.dotRects.push(h),b.addObject(h)}if(this.staccato)if("up"===n&&p){let t=y,e=v+i*(w?3:2),s=o.vW.createCentered(t,e,c,c);l.dotRects.push(s),d.addObject(s)}else if("down"===n&&A){let t=y,e=v-i*(w?3:2),s=o.vW.createCentered(t,e,c,c);l.dotRects.push(s),d.addObject(s)}});let I=l.noteHeadRects[0].anchorY,p=l.noteHeadRects[l.noteHeadRects.length-1].anchorY,A="up"===n?g/2:-g/2,b=this.getStemHeight(t),y="up"===n?p-b:I+b,v="up"===n?I:p;if(h&&(l.stemTip=new o.vW(A,A,y,y),l.stemBase=new o.vW(A,A,v,v),f.addObject(l.stemTip),d.addObject(l.stemBase)),!this.hasBeamCount()){let t=0===a?0:w*i,e=0===a?0:M*i;for(let s=0;s<a;s++){let r=s*i*S,a=l.flagRects[s]="up"===n?new o.vW(A,A+t,y+r,y+e+r):new o.vW(A,A+t,y-e-r,y-r);f.addObject(a)}}this.staffObjects.push(l),this.measure.addStaticObject(s,l)}),this.tabObjects.length=0,s.getTabs().forEach(e=>{if(!e.containsVoiceId(this.voiceId))return;let i=new xt(e,this);const s=P.Background,n=P.Tab_Note;this.notes.forEach((r,a)=>{let h=this.runningStringNumbers[a];if(o.I8.isIntegerBetween(h,1,6)){let o=r.chromaticId-e.getTuningStrings()[h-1].chromaticId,a=new At(this,{text:String(o),color:n,bgcolor:s},.5,.5);a.layout(t),a.setAnchor(this.col.getRect().anchorX,e.getStringY(h-1)),i.fretNumbers.push(a)}}),i.fretNumbers.length>0&&(this.tabObjects.push(i),e.addObject(i),this.measure.addStaticObject(e,i))})}updateRect(){if(this.staffObjects.length>0)this.rect=this.staffObjects[0].noteHeadRects[0].clone();else{if(!(this.tabObjects.length>0&&this.tabObjects[0].fretNumbers.length>0))return void(this.rect=new o.vW);this.rect=this.tabObjects[0].fretNumbers[0].getRect().clone()}this.staffObjects.forEach(t=>this.rect.expandInPlace(t.getRect())),this.tabObjects.forEach(t=>this.rect.expandInPlace(t.getRect()))}setStemTipY(t,e){let i=this.staffObjects.find(e=>e.staff===t);this.hasBeamCount()&&(null==i?void 0:i.stemTip)&&e!==i.stemTip.anchorY&&(i.stemTip.top=i.stemTip.anchorY=i.stemTip.bottom=e,this.requestRectUpdate(),this.col.requestRectUpdate())}offset(t,e){this.staffObjects.forEach(e=>e.offset(t,0)),this.tabObjects.forEach(e=>e.offset(t,0)),this.requestRectUpdate()}draw(t){t.drawDebugRect(this.getRect());let{stemDir:e}=this,{isSolidNoteHead:i}=this.rhythmProps;this.staffObjects.forEach(s=>{s.accidentals.forEach(e=>e.draw(t)),t.color(this.color),t.lineWidth(1),s.noteHeadRects.forEach(e=>{this.diamond?i?(t.beginPath(),t.moveTo(e.anchorX,e.top),t.lineTo(e.right,e.anchorY),t.lineTo(e.anchorX,e.bottom),t.lineTo(e.left,e.anchorY),t.lineTo(e.anchorX,e.top),t.fill()):(t.beginPath(),t.lineWidth(2.5),t.moveTo(e.anchorX,e.top),t.lineTo(e.right,e.anchorY),t.moveTo(e.left,e.anchorY),t.lineTo(e.anchorX,e.bottom),t.stroke(),t.beginPath(),t.lineWidth(1),t.moveTo(e.right,e.anchorY),t.lineTo(e.anchorX,e.bottom),t.moveTo(e.anchorX,e.top),t.lineTo(e.left,e.anchorY),t.stroke()):(t.beginPath(),t.ellipse(e.anchorX,e.anchorY,e.leftw,e.toph,-.3,0,2*Math.PI),i?t.fill():t.stroke())}),s.dotRects.forEach(e=>t.fillCircle(e.anchorX,e.anchorY,e.width/2)),s.stemTip&&s.stemBase&&(t.beginPath(),t.moveTo(s.stemBase.anchorX,s.stemBase.anchorY),t.lineTo(s.stemTip.anchorX,s.stemTip.anchorY),t.stroke()),s.flagRects.forEach(i=>t.drawFlag(i,"up"===e?"up":"down"))}),this.tabObjects.forEach(e=>e.fretNumbers.forEach(e=>e.draw(t)))}getDotVerticalDisplacement(t,e,i){return t.isLine(e)?"up"===i?-1:1:0}static hasSameNotes(t,e){if(t.notes.length!==e.notes.length)return!1;for(let i=0;i<t.notes.length;i++){let s=t.notes[i],n=e.notes[i];if(s.diatonicId!==n.diatonicId||s.accidental!==n.accidental)return!1}return!0}},Tt=class extends rt{constructor(t,e){super(t),this.measure=t,this.positionTicks=e,(0,r.Mu)(this,"voiceSymbol",new o.qG),(0,r.Mu)(this,"lyricsObject",new o.Yz),(0,r.Mu)(this,"minDiatonicId"),(0,r.Mu)(this,"maxDiatonicId"),(0,r.Mu)(this,"staffMinDiatonicId",new o.b1),(0,r.Mu)(this,"staffMaxDiatonicId",new o.b1),(0,r.Mu)(this,"arpeggioDir"),(0,r.Mu)(this,"arpeggios",[]),(0,r.Mu)(this,"playerProps"),(0,r.Mu)(this,"needLayout",!0),(0,r.Mu)(this,"shapeRects",[]),(0,r.Mu)(this,"mi"),this.playerProps=new Ft(this),this.mi=new Mi(this)}getMusicInterface(){return this.mi}getPlayerProps(){return this.playerProps}getNextColumnInMeasure(){let t=this.measure.getColumns().indexOf(this);if(t>=0&&t<this.measure.getColumnCount())return this.measure.getColumn(t+1);throw new h.O1(h.mN.Score,"Cannot get next column in measure because current column's id in mesure is invalid.")}getNextColumn(){var t;let e=this.getNextColumnInMeasure();return e||(null==(t=this.measure.getNextMeasure())?void 0:t.getColumn(0))}getTicksToNextColumn(){let t=this.getNextColumnInMeasure(),e=this.positionTicks,i=t?t.positionTicks:this.measure.getConsumedTicks();return Math.max(0,i-e)}getShapeRects(){return this.forceRectUpdate(),this.shapeRects}get doc(){return this.measure.doc}get row(){return this.measure.row}pick(t,e){const i=this.getRect().contains(t,e);for(let s=0;s<this.voiceSymbol.length;s++){let n=this.voiceSymbol.get(s);if(n instanceof St){let s=n.pick(t,e);if(s.length>0)return i?[this,...s]:s}}if(!i)return[];for(let s=0;s<this.voiceSymbol.length;s++){let i=this.voiceSymbol.get(s);if(i instanceof Lt){let s=i.pick(t,e);if(s.length>0)return[this,...s]}}for(let s=0;s<this.arpeggios.length;s++){let i=this.arpeggios[s].pick(t,e);if(i.length>0)return[this,...i]}return[]}hasArpeggio(){return void 0!==this.arpeggioDir}getArpeggioDir(){var t;return null!=(t=this.arpeggioDir)?t:"up"}setVoiceSymbol(t,e){B(t),this.voiceSymbol.set(t,e),e instanceof St&&!e.hide?this.row.getStaves().forEach(t=>{let i=e.getDiatonicId(t);this.minDiatonicId=void 0===this.minDiatonicId?i:Math.min(this.minDiatonicId,i),this.maxDiatonicId=void 0===this.maxDiatonicId?i:Math.max(this.maxDiatonicId,i)}):e instanceof Lt&&(this.minDiatonicId=void 0===this.minDiatonicId?e.notes[0].diatonicId:Math.min(this.minDiatonicId,e.notes[0].diatonicId),this.maxDiatonicId=void 0===this.maxDiatonicId?e.notes[e.notes.length-1].diatonicId:Math.max(this.maxDiatonicId,e.notes[e.notes.length-1].diatonicId),void 0!==e.arpeggio&&(this.arpeggioDir=e.arpeggio),this.updateNoteDisplacements()),this.requestLayout(),this.requestRectUpdate()}getVoiceSymbol(t){return this.voiceSymbol.get(t)}getLyricsObject(t,e,i){return this.lyricsObject.get(t,e,i)}addLyricsObject(t){this.lyricsObject.set(t.verse,t.line,t.vpos,t)}updateNoteDisplacements(){let t=[];this.voiceSymbol.forEach(e=>{e instanceof Lt&&e.notes.forEach(i=>{e.setNoteDisplacement(i,!1),t.push({noteGroup:e,note:i})})});if(t.sort((t,e)=>{let i=a.L7.compareFunc(t.note,e.note);return 0===i?t.noteGroup.stemDir===e.noteGroup.stemDir?0:"up"===t.noteGroup.stemDir?1:-1:i}),!(t.length<2)){for(let e=0;e<t.length;e++){let i=t[e],s=t[e+1];s&&i.note.diatonicId===s.note.diatonicId&&(i.isDisplaced=s.isDisplaced=!1)}for(let e=0;e<t.length;e++){let i=t[e-1],s=t[e],n=t[e+1];void 0===s.isDisplaced&&(i&&s.note.diatonicId-i.note.diatonicId<=1?s.isDisplaced=!i.isDisplaced:n&&n.note.diatonicId-s.note.diatonicId<=1&&(s.isDisplaced=!n.isDisplaced))}t.forEach(t=>{var e;return t.noteGroup.setNoteDisplacement(t.note,null!=(e=t.isDisplaced)&&e)})}}isEmpty(){return 0===this.voiceSymbol.size||this.voiceSymbol.every(t=>t.isEmpty())}getPlayerNotes(){let t=[];return[0,1,2,3].forEach(e=>{const i=this.getVoiceSymbol(e);if(i instanceof Lt){let e=i.getPlaySlur();i.notes.forEach(s=>{!function(e,i,s,n){if(i<=0)return;t.some(t=>e.diatonicId===t.note.diatonicId&&e.accidental===t.note.accidental&&(t.ticks=Math.max(t.ticks,i),!0))||t.push({note:e,ticks:i,staccato:s,slur:n})}(s,i.getPlayTicks(s),i.staccato,e)})}}),t.sort((t,e)=>a.L7.compareFunc(t.note,e.note)),this.hasArpeggio()&&"down"===this.getArpeggioDir()&&t.reverse(),t}requestLayout(){this.needLayout||(this.needLayout=!0,this.measure.requestLayout())}layout(t,e){if(!this.needLayout)return;let{row:i}=this;this.rect=new o.vW,this.requestRectUpdate();let s=0,n=0;if(this.voiceSymbol.forEach(i=>{i.layout(t,e);let o=i.getRect();s=Math.max(s,o.leftw),n=Math.max(n,o.rightw)}),void 0!==this.arpeggioDir){this.arpeggios=i.getNotationLines().map(t=>new vt(this,t,this.getArpeggioDir())),this.arpeggios.forEach(e=>e.layout(t));const e=this.arpeggios.map(t=>t.getRect().width).reduce((t,e)=>Math.max(t,e))+t.unitSize;this.arpeggios.forEach(t=>{t.setAnchor(-s-e/2,t.line.getRect().anchorY),t.line.addObject(t),this.measure.addStaticObject(t.line,t)}),s+=e}else this.arpeggios=[];const r=this.voiceSymbol.mapToArray(t=>t.rhythmProps.noteSize),a=Math.min(8,Math.max(1,...r)),h=Math.ceil(8/a)*p*t.unitSize*.75;s=Math.max(s,h/2),n=Math.max(n,h/2),s*=f,n*=f,this.rect.left=-s,this.rect.anchorX=0,this.rect.right=n,this.requestRectUpdate(),this.voiceSymbol.forEach(t=>t.updateAccidentalState(e)),this.row.getStaves().forEach(t=>{let e,i;this.voiceSymbol.forEach(s=>{if(s.visibleInStaff(t))if(s instanceof Lt)e=void 0===e?s.minDiatonicId:Math.min(e,s.minDiatonicId),i=void 0===i?s.maxDiatonicId:Math.max(i,s.maxDiatonicId);else if(s instanceof St){let n=s.getDiatonicId(t);e=void 0===e?n:Math.min(e,n),i=void 0===i?n:Math.max(i,n)}}),void 0!==e?this.staffMinDiatonicId.set(t,e):this.staffMinDiatonicId.delete(t),void 0!==i?this.staffMaxDiatonicId.set(t,i):this.staffMaxDiatonicId.delete(t)})}layoutReserveSpace(t){const e=this.measure.getColumns(),i=t.unitSize;this.getAnchoredLayoutObjects().forEach(t=>{if(t.layoutGroup.reserveSpace){const s=e.indexOf(this);if(s<0)return;const n=t.getRect().leftw-this.getRect().leftw;if(n>0){const o=e[s-1];o&&o.getAnchoredLayoutObjects().forEach(e=>{if(e.layoutGroupId===t.layoutGroupId){const t=e.getRect().rightw-o.getRect().rightw;this.rect.left-=Math.max(t+n,0)+i,this.requestRectUpdate()}})}const o=t.getRect().rightw-this.getRect().rightw;if(o>0){const n=e[s+1];n&&n.getAnchoredLayoutObjects().forEach(e=>{if(e.layoutGroupId===t.layoutGroupId){const t=e.getRect().leftw-n.getRect().leftw;this.rect.right+=Math.max(o+t,0)+i,this.requestRectUpdate()}})}}})}layoutDone(){this.needLayout=!1}updateRect(){this.shapeRects=[...this.voiceSymbol.filter(t=>void 0!==t).mapToArray(t=>t.getRect().clone()),...this.arpeggios.map(t=>t.getRect().clone())],this.rect.top=Math.min(...this.shapeRects.map(t=>t.top)),this.rect.bottom=Math.max(...this.shapeRects.map(t=>t.bottom)),this.rect.anchorY=(this.rect.top+this.rect.bottom)/2}offset(t,e){this.voiceSymbol.forEach(e=>e.offset(t,0)),this.arpeggios.forEach(e=>e.offset(t,0)),this.shapeRects.forEach(i=>i.offsetInPlace(t,e)),this.rect.offsetInPlace(t,e)}draw(t){t.color(P.Staff_Frame),this.row.getStaves().forEach(e=>{let i=this.staffMinDiatonicId.get(e),s=this.staffMaxDiatonicId.get(e);void 0!==i&&t.drawLedgerLines(e,i,this.getRect().anchorX),void 0!==s&&t.drawLedgerLines(e,s,this.getRect().anchorX)}),this.voiceSymbol.forEach(e=>e.draw(t)),this.arpeggios.forEach(e=>e.draw(t))}},Nt=class t extends rt{constructor(e,i,s="black"){switch(super(e),this.text=i,this.color=s,(0,r.Mu)(this,"components",[]),(0,r.Mu)(this,"mi"),this.text){case t.Coda:this.components=[new At(this,{text:"\ud834\udd0c",scale:1.7,color:s},.5,.3),new At(this,{text:" Coda",color:s},0,1)];break;case t.toCoda:this.components=[new At(this,{text:"toCoda ",color:s},1,1),new At(this,{text:"\ud834\udd0c",scale:1.7,color:s},.5,.3)];break;case t.Segno:this.components=[new At(this,{text:"\ud834\udd0b",scale:1.1,color:s},.5,1)];break;default:this.components=[]}this.mi=new Wi(this)}getMusicInterface(){return this.mi}getText(){return this.text}pick(t,e){return this.rect.contains(t,e)?[this]:[]}layout(e){switch(this.text){case t.Coda:{let t=this.components[0],i=this.components[1];t.layout(e),i.layout(e),t.setAnchorY(i.getRect().centerY),i.setLeft(t.getRect().right),this.rect=new o.vW(t.getRect().left,t.getRect().anchorX,i.getRect().right,i.getRect().top,i.getRect().anchorY,i.getRect().bottom);break}case t.toCoda:{let t=this.components[0],i=this.components[1];t.layout(e),i.layout(e),i.setAnchorY(t.getRect().centerY),t.setRight(i.getRect().left),this.rect=new o.vW(t.getRect().left,i.getRect().anchorX,i.getRect().right,t.getRect().top,t.getRect().anchorY,t.getRect().bottom);break}default:{let t=this.components[0];t.layout(e),this.rect=t.getRect().clone();break}}}offset(t,e){this.components.forEach(i=>i.offset(t,e)),this.rect.offsetInPlace(t,e)}draw(t){t.drawDebugRect(this.rect),this.components.forEach(e=>e.draw(t))}};(0,r.Mu)(Nt,"toCoda","\ud834\udd0c toCoda"),(0,r.Mu)(Nt,"Coda","Coda \ud834\udd0c"),(0,r.Mu)(Nt,"Segno","\ud834\udd0b");var Ot=Nt;function jt(t){return t instanceof At||t instanceof Ot?t.getText():t instanceof re?"[measure]":""}var kt=class{constructor(t){this.startColumn=t,(0,r.Mu)(this,"columnRange"),(0,r.Mu)(this,"stopObject"),this.columnRange=[t]}get endColumn(){return this.columnRange[this.columnRange.length-1]}addColumn(t){this.endColumn!==t&&this.columnRange.push(t)}setStopObject(t){this.stopObject=t}},Pt=class t extends ot{constructor(t,e,i,s,n,o){super(t.musicObj),this.headObj=t,(0,r.Mu)(this,"length"),(0,r.Mu)(this,"visible"),(0,r.Mu)(this,"lineStyle"),(0,r.Mu)(this,"linePos"),(0,r.Mu)(this,"startColumn"),this.length=i+1,this.visible=s,this.lineStyle=n,this.linePos=o,this.startColumn=e}isVisible(){return this.visible}getLineStyle(){return this.lineStyle}getLinePos(){return this.linePos}whatStopped(e){const i=e.measure,s=i.getColumns(),n=e.getAnchoredLayoutObjects().filter(t=>t!==this.headObj&&t.layoutGroupId===this.headObj.layoutGroupId).map(t=>t.musicObj).filter(t=>t instanceof At||t instanceof Ot)[0];return n||(e===s[s.length-1]&&i.hasEndSection()||i.hasEndSong()||t.StopNavigations.some(t=>i.hasNavigation(t))?i.getBarLineRight():void 0)}getRange(){let{startColumn:t,length:e}=this,i=t,s=new kt(i),n=e;for(;;){if(n<=0)return s;const t=this.whatStopped(i);if(void 0!==t)return s.setStopObject(t),s;if(n-=i.getTicksToNextColumn(),i=i.getNextColumn(),!i)return s;n>0&&s.addColumn(i)}}};(0,r.Mu)(Pt,"StopNavigations",["endRepeat","ending"]);var Et=Pt;function Dt(t){switch(t){case"D.C. al Coda":return"D.C. al Coda";case"D.C. al Fine":return"D.C. al Fine";case"D.S. al Coda":return"D.S. al Coda";case"D.S. al Fine":return"D.S. al Fine";case"Fine":return"Fine";case"Segno":return Ot.Segno;case"Coda":return Ot.Coda;case"toCoda":return Ot.toCoda;default:return t[0].toUpperCase()+t.substring(1)}}function Gt(t){if(/^(p+|f+|m|mp|mf)$/.test(t)){let e=.5-.1*o.OZ.Str.charCount(t,"p")+.1*o.OZ.Str.charCount(t,"f");return o.OZ.Math.clamp(e,0,1)}}function Bt(t,e){return"undefined"==typeof window?void 0:window.setTimeout(t,e)}function Yt(t){"undefined"!=typeof window&&window.clearTimeout(t)}function Wt(){return Gt("m")}var Ft=class{constructor(t){this.col=t,(0,r.Mu)(this,"speed"),(0,r.Mu)(this,"volume"),this.speed=1,this.volume=Wt()}get measure(){return this.col.measure}reset(){this.speed=1,this.volume=Wt()}setSpeed(t){this.speed=t}getSpeed(){return this.speed}getTempo(){let t=o.OZ.Math.clamp(this.getSpeed(),.1,10);return(0,a.Bi)(this.measure.getTempo(),t)}setVolume(t){this.volume=t}getVolume(){return this.volume}hasFermata(){return this.measure.hasFermata(this.col)}getFermataHoldTicks(){if(!this.hasFermata())return 0;const{col:t}=this;if(t instanceof Ht)return this.measure.getMeasureTicks()/2;{let e=[0,1,2,3].map(e=>t.getVoiceSymbol(e)).filter(t=>!!t).map(t=>t.rhythmProps.ticks);return 0===e.length?0:o.OZ.Math.sum(e)/e.length}}},Ut=class t{constructor(){(0,r.Mu)(this,"playTimer"),(0,r.Mu)(this,"playPos"),(0,r.Mu)(this,"playState",2),(0,r.Mu)(this,"doc"),(0,r.Mu)(this,"cursorPositionChangeListener"),(0,r.Mu)(this,"playStateChnageListener"),(0,r.Mu)(this,"playerColumnSequence",[])}setDocument(t){this.doc=t,this.doc.resetMeasures(),this.playerColumnSequence=this.collectPlayerColumnSequence(),this.updatePlayerProps()}setCursorPositionChangeListener(t){this.cursorPositionChangeListener=t}setPlayStateChnageListener(t){this.playStateChnageListener=t}notifyCursorPositionChanged(){this.cursorPositionChangeListener&&this.cursorPositionChangeListener(this.getCursorRect())}notifyPlayStateChanged(){let t=void 0!==this.playPos&&void 0!==this.playTimer?0:void 0!==this.playPos&&void 0===this.playTimer?1:2;this.playState!==t&&(this.playStateChnageListener&&this.playStateChnageListener(t),this.playState=t)}collectPlayerMeasureSequence(){var e;if(!this.doc)return[];let i,s=[],n=this.doc.getFirstMeasure(),o=n,r=!1,a=!1;for(;n;){if(n.incPassCount(),n.getEnding()){let e=n.getPassCount();n=t.getMeasureByEndingPassage(n,e)}if(n)if(s.push(n),n.hasNavigation("startRepeat")&&(o=n),n.hasNavigation("Segno")&&(i=n),a&&n.hasNavigation("toCoda"))for(;n&&!n.hasNavigation("Coda");)n=n.getNextMeasure();else if(r&&n.hasNavigation("Fine"))n=void 0;else if(n.hasNavigation("D.C. al Coda"))a=!0,n=this.doc.getFirstMeasure();else if(n.hasNavigation("D.C. al Fine"))r=!0,n=this.doc.getFirstMeasure();else if(n.hasNavigation("D.S. al Coda"))a=!0,n=i;else if(n.hasNavigation("D.S. al Fine"))r=!0,n=i;else if(n.hasNavigation("endRepeat")){let t=n.getPassCount(),i=n.getEndRepeatPlayCount()-1,s=!0===(null==(e=n.getNextMeasure())?void 0:e.hasNavigation("ending"));n=t<=i||s?o:n.getNextMeasure()}else n=n.hasEndSong()?void 0:n.getNextMeasure()}return s}collectPlayerColumnSequence(){let t=this.collectPlayerMeasureSequence(),e=[];for(let i=0;i<t.length;i++){let s=t[i];e=e.concat(s.getColumns()),s.hasFermata(s.getBarLineRight())&&e.push(s.getBarLineRight())}return e}updatePlayerProps(){if(this.playerColumnSequence.forEach(t=>t.getPlayerProps().reset()),!this.doc)return;let t=1,e=Wt(),i=new o.b1,s=new o.b1;const n=(t,e)=>i.getOrCreate(t,[]).push(e),r=(t,e)=>s.getOrCreate(t,[]).push(e);this.playerColumnSequence.forEach(a=>{if(!(a instanceof Tt))return;a.getAnchoredLayoutObjects().forEach(i=>{const s=jt(i.musicObj);let a;if("a tempo"===s)t=1;else if(void 0!==(a=Gt(s)))e=a;else if(i.musicObj.getLink()instanceof Et){const h=i.musicObj.getLink().getRange(),c=h.stopObject?jt(h.stopObject):"";let g=o.OZ.Math.sum(h.columnRange.map(t=>t.getTicksToNextColumn()));switch(s){case"accel.":{let e=t,i=2*e,s=0;h.columnRange.forEach(t=>{s+=t.getTicksToNextColumn(),n(t,e+(i-e)*s/g)});break}case"rit.":{let e=t,i=e/2,s=0;h.columnRange.forEach(t=>{s+=t.getTicksToNextColumn(),n(t,e+(i-e)*s/g)});break}case"cresc.":{let t=e,i=t+.5;h.stopObject&&void 0!==(a=Gt(c))&&a>t&&(i=a);let s=0;h.columnRange.forEach(e=>{s+=e.getTicksToNextColumn(),r(e,t+(i-t)*s/g)});break}case"decresc.":case"dim.":{let t=e,i=t-.5;h.stopObject&&void 0!==(a=Gt(c))&&a<t&&(i=a);let s=0;h.columnRange.forEach(e=>{s+=e.getTicksToNextColumn(),r(e,t+(i-t)*s/g)});break}}}});let h=i.getOrDefault(a,[]);h.length>0&&(t=o.OZ.Math.sum(h)/h.length);let c=s.getOrDefault(a,[]);c.length>0&&(e=o.OZ.Math.sum(c)/c.length),a.getPlayerProps().setSpeed(t),a.getPlayerProps().setVolume(e)})}static getMeasureByEndingPassage(t,e){for(let i=t;;i=i.getNextMeasure()){let t=null==i?void 0:i.getEnding();if(t&&t.hasPassage(e))return i;let s=null==i?void 0:i.getNextMeasure();if(!i||i.hasEndSong()||i.hasEndSection()||!s||s.hasNavigation("startRepeat"))return}}playStep(){if(this.notifyCursorPositionChanged(),this.notifyPlayStateChanged(),void 0===this.playPos)return void this.stop();const t=this.playerColumnSequence[this.playPos];if(!t)return void this.stop();const e=(t,e)=>{let i=function(t,e){let i=a.R6.get(e.options.beatLength,e.options.dotCount).ticks;return 60*t/(e.beatsPerMinute*i)}(t,e);return Math.max(0,i)};let i,s=t.getPlayerProps().getTempo(),n=t.getPlayerProps().getFermataHoldTicks();if(t instanceof Ht)i=e(n,s);else{t.getPlayerNotes().forEach((i,o)=>{let r=t.hasArpeggio()?a.R6.get(a.r5.ThirtySecond).ticks*o:0,h=e(i.ticks+n-r,s);if(h>0){i.staccato&&(h=Math.min(e(a.R6.get(a.r5.Eighth).ticks,s)/2,h/2));let n=1.25*t.getPlayerProps().getVolume();if("slurred"===i.slur&&(n*=.5),r>0){Bt(()=>c.T6(i.note,h,n),1e3*e(r,s))}else c.T6(i.note,h,n)}}),i=e(t.getTicksToNextColumn()+n,s)}this.playTimer=Bt(()=>this.playStep(),1e3*i),this.playPos=this.getNextPlayPosition(this.playPos),this.notifyPlayStateChanged()}play(){if(0===this.playState)this.stop();else if(1===this.playState)return void this.playStep();let{doc:t}=this;t&&(t.getFirstMeasure()?(this.playPos=0,this.playStep()):this.playPos=void 0,this.notifyPlayStateChanged())}pause(){this.playTimer&&(Yt(this.playTimer),this.playTimer=void 0),this.notifyCursorPositionChanged(),this.notifyPlayStateChanged()}stop(){this.playPos=void 0,this.playTimer&&(Yt(this.playTimer),this.playTimer=void 0),this.notifyCursorPositionChanged(),this.notifyPlayStateChanged()}getNextPlayPosition(t){return void 0!==this.playPos&&++this.playPos>=this.playerColumnSequence.length&&(this.playPos=void 0),this.playPos}getCursorRect(){if(void 0===this.playPos)return;let t=this.playerColumnSequence[this.playPos];if(!t)return;let e=t.measure,i=t.getRect().anchorX,{top:s,height:n}=e.row.getRect();return new o.rw(i,s,0,n)}},zt=class extends rt{constructor(t,e,i){super(e),this.barLine=t,this.line=e,this.rowGroup=i,(0,r.Mu)(this,"vlines",[]),(0,r.Mu)(this,"dots",[]),(0,r.Mu)(this,"mi"),e.addObject(this),this.mi=new li(this)}getMusicInterface(){return this.mi}pick(t,e){return this.getRect().contains(t,e)?[this]:[]}updateRect(){this.rect=new o.vW(0,0,this.line.getTopLineY(),this.line.getBottomLineY()),this.vlines.forEach(t=>this.rect.expandInPlace(new o.vW(t.left,t.left+t.width,this.rect.top,this.rect.bottom))),this.dots.forEach(t=>this.rect.expandInPlace(new o.vW(t.x-t.r,t.x+t.r,t.y-t.r,t.y+t.r)))}offset(t,e){this.vlines.forEach(e=>e.left+=t),this.dots.forEach(i=>{i.x+=t,i.y+=e}),this.rect.offsetInPlace(t,e)}},Zt=class extends rt{constructor(t){super(t),this.measure=t,(0,r.Mu)(this,"notationLineObjects",[]),(0,r.Mu)(this,"notationLineObjectsByGrp",new o.b1),(0,r.Mu)(this,"barLineType",0)}get doc(){return this.measure.doc}get row(){return this.measure.row}pick(t,e){if(!this.getRect().contains(t,e))return[];for(let i=0;i<this.notationLineObjects.length;i++){let s=this.notationLineObjects[i].pick(t,e);if(s.length>0)return[this,...s]}return[this]}layout(t){this.requestRectUpdate(),this.barLineType=this.solveBarLineType();let{unitSize:e,_lineWidth:i}=t,{measure:s,barLineType:n}=this,{row:o}=s,r=i,a=.7*e,h=.7*e,c=y*e/2;this.notationLineObjects=[],this.notationLineObjectsByGrp.clear(),o.getRowGroups().forEach(t=>{t.lines.forEach(e=>{let i,s,o=new zt(this,e,t);this.notationLineObjects.push(o),this.notationLineObjectsByGrp.getOrCreate(t,[]).push(o);const g=(t,e)=>{o.vlines.push({left:t,width:e})},u=t=>{for(let e=-1;e<=1;e+=2){let n=i+e*s;o.dots.push({x:t,y:n,r:c})}};switch(e instanceof de?(i=e.getMiddleLineY(),s=e.getDiatonicSpacing()):(i=(e.getBottomLineY()+e.getTopLineY())/2,s=(e.getBottomLineY()-e.getTopLineY())/6),n){case 0:break;case 1:g(-r,r);break;case 2:g(-r-h-r,r),g(-r,r);break;case 3:g(-r-h-a,r),g(-a,a);break;case 4:g(0,a),g(a+h,r),u(a+h+r+h+c);break;case 5:g(-r-h-a,r),g(-a,a),u(-r-h-a-h-c);break;case 6:g(-a/2,a),g(-a/2-h-r,r),g(a/2+h,r),u(-a/2-h-r-h-c),u(a/2+h+r+h+c)}o.forceRectUpdate()})})}updateRect(){if(this.notationLineObjects.length>0){this.rect=this.notationLineObjects[0].getRect().clone();for(let t=1;t<this.notationLineObjects.length;t++)this.rect.expandInPlace(this.notationLineObjects[t].getRect())}else this.rect=new o.vW}offset(t,e){this.notationLineObjects.forEach(e=>e.offset(t,0)),this.requestRectUpdate()}draw(t){0!==this.barLineType&&(t.drawDebugRect(this.getRect()),this.notationLineObjects.forEach(e=>{e.vlines.forEach(i=>e.line.drawVerticalLine(t,i.left,i.width)),e.dots.forEach(e=>t.fillCircle(e.x,e.y,e.r))}))}},Vt=class extends Zt{constructor(t){super(t),(0,r.Mu)(this,"mi"),this.mi=new gi(this)}getMusicInterface(){return this.mi}solveBarLineType(){let t=this.measure,e=t.getPrevMeasure();return t.hasNavigation("startRepeat")?e&&e.row===t.row&&e.hasNavigation("endRepeat")?0:4:0}},Ht=class extends Zt{constructor(t){super(t),(0,r.Mu)(this,"playerProps"),(0,r.Mu)(this,"mi"),this.playerProps=new Ft(this),this.mi=new hi(this)}getMusicInterface(){return this.mi}getPlayerProps(){return this.playerProps}solveBarLineType(){let t=this.measure,e=t.getNextMeasure();return t.hasNavigation("endRepeat")?e&&e.row===t.row&&e.hasNavigation("startRepeat")?6:5:t.doc.hasSingleMeasure()||!t.hasEndSong()&&t.getNextMeasure()?t.hasEndSection()||t===t.row.getLastMeasure()&&e&&e.row===t.row.getNextRow()&&e.hasNavigation("startRepeat")?2:e&&e.hasNavigation("startRepeat")?0:1:3}},Xt=class extends rt{constructor(t,e,i){if(super(t),this.measure=t,this.color=e,this.passages=i,(0,r.Mu)(this,"endingText"),(0,r.Mu)(this,"shapeRects",[]),(0,r.Mu)(this,"mi"),this.mi=new _e(this),!o.I8.isIntegerGte(i.length,1))throw new h.O1(h.mN.Score,"Passages is empty.");if(!this.passages.every(t=>o.I8.isIntegerGte(t,1)))throw new h.O1(h.mN.Score,"Invalid passages: "+this.passages);this.passages.sort((t,e)=>t-e);const s=this.passages.map(t=>t+".").join("");this.endingText=new At(this,{text:s,color:e},0,1)}getMusicInterface(){return this.mi}getShapeRects(){return this.shapeRects}isSingleMeasureEnding(){let{measure:t}=this,e=t.getNextMeasure();return!0===(null==e?void 0:e.hasNavigation("ending"))||t.hasNavigation("endRepeat")||t.isLastMeasure()}hasPassage(t){return this.passages.some(e=>e===t)}getHighestPassage(){return Math.max(0,...this.passages)}pick(t,e){return this.rect.contains(t,e)?[this]:[]}layout(t){this.rect=new o.vW,this.shapeRects=[this.rect.clone()]}layoutFitToMeasure(t){let{unitSize:e}=t,{measure:i}=this;this.endingText.layout(t);let s=this.endingText.getRect(),n=i.getColumnsContentRect(),r=s.height;this.rect=new o.vW(n.left+e,n.right-e,-r,0),this.endingText.setLeft(this.rect.left+e/2),this.endingText.setBottom(this.rect.bottom),this.shapeRects=[new o.vW(this.rect.left,this.rect.left+1,this.rect.top,this.rect.bottom),new o.vW(this.rect.left,this.rect.right,this.rect.top,this.rect.top+1),new o.vW(this.rect.right-1,this.rect.right,this.rect.top,this.rect.bottom),this.endingText.getRect().clone()]}offset(t,e){this.endingText.offset(t,e),this.shapeRects.forEach(i=>i.offsetInPlace(t,e)),this.rect.offsetInPlace(t,e)}draw(t){let{rect:e}=this;t.drawDebugRect(this.rect),t.color(this.color).lineWidth(1),t.beginPath(),t.moveTo(e.left,e.bottom),t.lineTo(e.left,e.top),t.lineTo(e.right,e.top),this.isSingleMeasureEnding()&&t.lineTo(e.right,e.bottom),t.stroke(),this.endingText.draw(t)}},qt=class{constructor(t,e,i,s,n){this.staff=t,this.beamGroup=e,this.symbol=i,this.x=s,this.y=n,(0,r.Mu)(this,"topBeamsHeight",0),(0,r.Mu)(this,"bottomBeamsHeight",0),t.addObject(this)}offset(t,e){this.x+=t,this.y+=e,this.beamGroup.requestRectUpdate()}getRect(){return new o.vW(this.x,this.x,this.x,this.y-this.topBeamsHeight,this.y,this.y+this.bottomBeamsHeight)}},Jt=class extends rt{constructor(t,e){super(t),this.staff=t,this.beamGroup=e,(0,r.Mu)(this,"tupletNumber"),(0,r.Mu)(this,"tupletNumberOffsetY",0),(0,r.Mu)(this,"points",[]),(0,r.Mu)(this,"mi"),t.addObject(this),this.mi=new qe(this)}getMusicInterface(){return this.mi}pick(t,e){return this.getRect().contains(t,e)?[this]:[]}offset(t,e){var i;this.points.forEach(e=>e.offset(t,0)),null==(i=this.tupletNumber)||i.offset(t,e),this.requestRectUpdate(),this.beamGroup.requestRectUpdate()}updateRect(){this.points.length>0?this.rect=this.points[0].getRect().clone():this.tupletNumber&&(this.rect=this.tupletNumber.getRect().clone()),this.points.forEach(t=>this.rect.expandInPlace(t.getRect())),this.tupletNumber&&this.rect.expandInPlace(this.tupletNumber.getRect())}},Kt=class{constructor(t,e){this.beamGroup=t,this.message=e}},Qt=class t extends rt{constructor(t,e){super(t[0].measure),this.symbols=t,this.tupletRatio=e,(0,r.Mu)(this,"mi"),(0,r.Mu)(this,"type"),(0,r.Mu)(this,"staffObjects",[]),this.mi=new He(this);let i=e?"Tuplet":"BeamGroup";if(!t.every(e=>e.measure===t[0].measure))throw new h.O1(h.mN.Score,`All ${i} symbols are not in same measure.`);if(t.length<2)throw new h.O1(h.mN.Score,`${i} needs minimum 2 symbols, but ${t.length} given.`);if(void 0!==e){let e=t.length<3||t.some(t=>!(t instanceof Lt))||t.some(e=>e.rhythmProps.flagCount!==t[0].rhythmProps.flagCount);t.length>=3&&t[0]instanceof Lt&&t[t.length-1]instanceof Lt&&t[0].rhythmProps.flagCount===t[t.length-1].rhythmProps.flagCount&&(e=!1),t.some(t=>a.Xp.cmp(t.rhythmProps.noteLength,a.r5.Quarter)>=0)&&(e=!0),this.type=e?2:1,this.setTupletBeamCounts()}else this.type=0,this.setBeamCounts();if(!t.every(t=>void 0===t.getBeamGroup()))throw new h.O1(h.mN.Score,`Cannot add ${i} because some symbol already has one.`);if(t.forEach(t=>t.setBeamGroup(this)),t[0].measure.addBeamGroup(this),0===this.type&&this.symbols.filter(t=>t instanceof Lt).some((t,e)=>{let i=0===e,s=e===this.symbols.length-1;if(i&&0===t.getRightBeamCount()||s&&0===t.getLeftBeamCount()||!i&&!s&&(0===t.getLeftBeamCount()||0===t.getRightBeamCount()))throw new Kt(this,"Beam has zero left or right beam count!")}),t.some(e=>e.voiceId!==t[0].voiceId))throw 0===this.type?new Kt(this,"Beam symbols have different voiceId."):new h.O1(h.mN.Score,"Tuplet symbols have different voiceId.");t[0].row.getStaves().forEach(e=>{e.getActualStaff(t[0].getDiatonicId(e))&&e.containsVoiceId(t[0].voiceId)&&t.forEach(t=>{let i=e.getActualStaff(t.getDiatonicId(e));if(!i||!i.containsVoiceId(t.voiceId))throw new Kt(this,"Some of beam or tuplet symbols are not visible!")})})}get stemDir(){return this.symbols[0].stemDir}get showTupletRatio(){var t;return!0===(null==(t=this.tupletRatio)?void 0:t.showRatio)}static createBeam(e){if(e.length>1&&e.every(t=>!t.hasTuplet()))try{return new t(e,void 0),!0}catch(i){if(!(i instanceof Kt))throw i;i.beamGroup.detach()}return!1}static createOldStyleTriplet(e){try{let i=e.slice(0,2),s=i.map(t=>t.rhythmProps.noteSize);if(2===i.length&&i.every(t=>t.oldStyleTriplet&&void 0===t.getBeamGroup())&&(2*s[0]===s[1]||2*s[1]===s[0]))return new t(i,a.Jh.Triplet),2;let n=e.slice(0,3),o=n.map(t=>t.rhythmProps.noteSize);if(3===n.length&&n.every(t=>t.oldStyleTriplet&&void 0===t.getBeamGroup())&&o.every(t=>t===o[0]))return new t(n,a.Jh.Triplet),3}catch(i){if(!(i instanceof Kt))throw i;console.error(i.message),i.beamGroup.detach()}return 0}static createTuplet(e,i){try{new t(e,i)}catch(s){if(!(s instanceof Kt))throw s;console.error(s.message),s.beamGroup.detach()}}getMusicInterface(){return this.mi}detach(){this.getSymbols().forEach(t=>t.resetBeamGroup())}isEmpty(){return 0===this.staffObjects.length}pick(t,e){if(!this.getRect().contains(t,e))return[];for(let i=0;i<this.staffObjects.length;i++){let s=this.staffObjects[i].pick(t,e);if(s.length>0)return[this,...s]}return[this]}getType(){return this.type}isTuplet(){return 1===this.type||2===this.type}getTupletRatioText(){var t,e,i;return this.showTupletRatio?String(null==(t=this.tupletRatio)?void 0:t.parts)+":"+String(null==(e=this.tupletRatio)?void 0:e.inTimeOf):String(null==(i=this.tupletRatio)?void 0:i.parts)}getSymbols(){return this.symbols}getFirstSymbol(){return this.symbols[0]}getLastSymbol(){return this.symbols[this.symbols.length-1]}get color(){return this.symbols[0].color}layout(t){this.requestRectUpdate(),this.staffObjects.length=0;let e=this.getSymbols();if(0===e.length)return;let{unitSize:i}=t,{stemDir:s,type:n}=this,r=e.map(t=>t.getBeamCoords());r[0].map(t=>null==t?void 0:t.staff).forEach((a,h)=>{var c,g;if(!a)return;let u=r.map(t=>{var e;return null==(e=t[h])?void 0:e.x}),l=r.map(t=>{var e;return null==(e=t[h])?void 0:e.y}),d=r.map(t=>{var e;return null==(e=t[h])?void 0:e.staff}),f=r.map(t=>{var e;return null==(e=t[h])?void 0:e.stemHeight}),I=e[0],m=u[0],C=l[0],p=d[0],A=e[e.length-1],b=u[u.length-1],y=l[l.length-1],v=d[l.length-1];if(void 0===m||void 0===C||void 0===p||void 0===b||void 0===y||void 0===v)return;let w=null!=(c=f[0])?c:0,M=null!=(g=f[f.length-1])?g:0;if(2!==n){let t=w<M?Math.sqrt(M-w):0,e=M<w?Math.sqrt(w-M):0;"up"===s&&(t*=-1,e*=-1),0!==t&&(C+=t,l[0]+=t),0!==e&&(y+=e,l[l.length-1]+=e)}let S=2*i*("up"===s?-1:1),T=(y+C)/2,N=((t,e)=>{let i=x;if(Number.isFinite(i)&&0!==i){let s=t/e/i;return s=Math.sign(s)*Math.sqrt(Math.abs(s)),t/s*i}return e})(b-m,y-C)/2;C=T-N,y=T+N;let O=0;l.forEach((t,e)=>{let i=u[e];if(void 0!==i&&void 0!==t){let e=t-o.OZ.Math.interpolateY(m,C,b,y,i);"up"===s&&e<0?O=Math.min(O,e):"down"===s&&e>0&&(O=Math.max(O,e))}}),C+=O,y+=O,l=l.map(t=>void 0===t?void 0:t+O);let j=new Jt(a,this);if(2===n){let t=i/(b-m),e=o.OZ.Math.interpolateCoord(m,C+S,b,y+S,-t),s=o.OZ.Math.interpolateCoord(m,C+S,b,y+S,1+t);j.points.push(new qt(p,this,I,e.x,e.y)),j.points.push(new qt(v,this,A,s.x,s.y)),j.tupletNumberOffsetY=0}else if(0===n||1===n){O*=.5;let n=t._lineWidth*L;const o=t=>{let n=e[t];if(n instanceof Lt){let t=n instanceof Lt?Math.max(n.getLeftBeamCount(),n.getRightBeamCount()):0;return R*i*("up"===s?t-1:0)}return 0};e.forEach((t,e)=>{let i=d[e],r=u[e],a=l[e];if(i&&void 0!==r&&void 0!==a){let h=new qt(i,this,t,r,a);switch(s){case"up":h.topBeamsHeight=n/2,h.bottomBeamsHeight=n/2+o(e);break;case"down":h.topBeamsHeight=n/2+o(e),h.bottomBeamsHeight=n/2}j.points.push(h)}}),j.tupletNumberOffsetY=S}this.isTuplet()&&(j.tupletNumber=new At(this,this.getTupletRatioText(),.5,.5),j.tupletNumber.layout(t),j.tupletNumber.offset((m+b)/2,(C+y)/2+j.tupletNumberOffsetY)),j.points.length>=2&&this.staffObjects.push(j)})}updateRect(){if(0===this.staffObjects.length)this.rect=new o.vW;else{this.staffObjects.forEach(t=>t.updateRect()),this.rect=this.staffObjects[0].getRect().clone();for(let t=1;t<this.staffObjects.length;t++)this.rect.expandInPlace(this.staffObjects[t].getRect())}}updateStemTips(){this.staffObjects.forEach(t=>{let e=t.points[0],i=t.points[t.points.length-1];2!==this.type&&t.points.forEach(t=>{t.symbol instanceof Lt&&(t!==e&&t!==i&&(t.y=o.OZ.Math.interpolateY(e.x,e.y,i.x,i.y,t.x)),t.symbol.setStemTipY(t.staff,t.y))}),t.tupletNumber&&t.tupletNumber.setAnchorY((e.y+i.y)/2+t.tupletNumberOffsetY)})}offset(t,e){this.staffObjects.forEach(e=>e.offset(t,0)),this.requestRectUpdate()}draw(t){let{unitSize:e}=t,{stemDir:i,color:s,type:n}=this;if(2===n){t.color(s).lineWidth(1);let n=("up"===i?1:-1)*e;this.staffObjects.forEach(e=>{let{x:i,y:s}=e.points[0],{x:r,y:a}=e.points[e.points.length-1];if(e.tupletNumber){let n=e.tupletNumber.getRect().width/(r-i)*1.2,h=o.OZ.Math.interpolateCoord(i,s,r,a,.5-n/2),c=o.OZ.Math.interpolateCoord(i,s,r,a,.5+n/2);t.strokeLine(i,s,h.x,h.y),t.strokeLine(c.x,c.y,r,a)}else t.strokeLine(i,s,r,a);t.strokeLine(i,s,i,s+n),t.strokeLine(r,a,r,a+n)})}else 0!==n&&1!==n||(t.color(s).lineWidth(L),this.staffObjects.forEach(s=>{let n=s.points.filter(t=>t.symbol instanceof Lt),{x:o,y:r}=n[0],{x:a,y:h}=n[n.length-1],c=R*e*("up"===i?1:-1)*(1+.5*Math.abs(Math.atan2(h-r,a-o)));for(let e=0;e<n.length-1;e++){let{x:i,y:s,symbol:o}=n[e],{x:r,y:a,symbol:h}=n[e+1],g=o.getRightBeamCount(),u=h.getLeftBeamCount();for(let e=0;e<Math.max(g,u);e++)e<g&&e<u?t.strokeLine(i,s,r,a):g>u?t.strokePartialLine(i,s,r,a,0,.25):u>g&&t.strokePartialLine(i,s,r,a,.75,1),s+=c,a+=c}}));this.staffObjects.forEach(e=>{var i;return null==(i=e.tupletNumber)?void 0:i.draw(t)})}setBeamCounts(){const t=(t,e)=>{let{flagCount:i,noteSize:s,dotCount:n}=t.rhythmProps,{flagCount:o,noteSize:r,dotCount:a}=e.rhythmProps;return i>0&&o>0&&n>0&&0===a&&s*Math.pow(2,n)===r};let e,i=this.symbols.filter(t=>t instanceof Lt);for(let s=0;s<i.length;s++){let e=i[s],n=i[s-1],o=i[s+1];e&&(e.setLeftBeamCount(0),e.setRightBeamCount(0),n&&(n.rhythmProps.flagCount===e.rhythmProps.flagCount||t(n,e)||t(e,n)?e.setLeftBeamCount(e.rhythmProps.flagCount):e.setLeftBeamCount(Math.min(n.rhythmProps.flagCount,e.rhythmProps.flagCount))),o&&(o.rhythmProps.flagCount===e.rhythmProps.flagCount||t(o,e)||t(e,o)?e.setRightBeamCount(e.rhythmProps.flagCount):e.setRightBeamCount(Math.min(o.rhythmProps.flagCount,e.rhythmProps.flagCount))))}do{e=!1;for(let t=0;t<i.length;t++){let s=i[t],n=i[t-1],o=i[t+1];s&&s.getLeftBeamCount()!==s.rhythmProps.flagCount&&s.getRightBeamCount()!==s.rhythmProps.flagCount&&(s.setLeftBeamCount(0),s.setRightBeamCount(0),n&&n.getRightBeamCount()>0&&(n.setRightBeamCount(0),e=!0),o&&o.getLeftBeamCount()>0&&(o.setLeftBeamCount(0),e=!0))}}while(e)}setTupletBeamCounts(){let t=this.getType(),e=this.getSymbols();1===t?e.forEach((t,i)=>{t instanceof Lt&&(t.setLeftBeamCount(0===i?0:t.rhythmProps.flagCount),t.setRightBeamCount(i===e.length-1?0:t.rhythmProps.flagCount))}):2===t&&e.forEach(t=>{t instanceof Lt&&(t.setLeftBeamCount(0),t.setRightBeamCount(0))})}},_t=class extends rt{constructor(t,e,i){super(t),this.pos=e,this.color=i,(0,r.Mu)(this,"mi"),this.mi=new ti(this)}getMusicInterface(){return this.mi}static getFermataPositions(t){let{measure:e}=t,{row:i}=e;return i.getTopStaff()!==i.getBottomStaff()?[0,1]:[0]}pick(t,e){return this.rect.contains(t,e)?[this]:[]}layout(t){let{unitSize:e}=t,i=4*e,s=3*e;this.rect=new o.vW(-i/2,i/2,-s,0)}offset(t,e){this.rect.offsetInPlace(t,e)}draw(t){let{unitSize:e}=t,i=1===this.pos,s=.7*(i?e:-e),n=this.rect.left,o=this.rect.right,r=(i?this.rect.bottom:this.rect.top)+s,a=(i?this.rect.top:this.rect.bottom)+s,h=a-r;t.drawDebugRect(this.rect),t.color(this.color).lineWidth(1),t.beginPath(),t.moveTo(n,a),t.bezierCurveTo(n,r,o,r,o,a),t.bezierCurveTo(o,r+h/5,n,r+h/5,n,a),t.stroke(),t.fill();let c=h/6;t.fillCircle((n+o)/2,a-c,Math.abs(c))}};function $t(t){return t instanceof Ht||t instanceof At||t instanceof Ot}var te=class extends rt{constructor(t,e,i,s){super(t),this.measure=t,this.line=e,this.extension=i,this.cols=s,(0,r.Mu)(this,"mi"),i.addTail(this),this.mi=new Hi(this)}get row(){return this.measure.row}getMusicInterface(){return this.mi}getLineLeft(t){let e=this.cols[0];if(function(t){return t instanceof At||t instanceof Ot}(e))return e.getRect().right+t.unitSize;if(e instanceof Vt)return e.getRect().anchorX;if(e instanceof Tt){const t=e.measure.getColumns();if(e===t[0])return e.measure.getRect().left}return e.getRect().right}getLineRight(t){let e=this.cols[this.cols.length-1];if($t(e))return e.getRect().left-t.unitSize;if(e instanceof Tt){const t=e.measure.getColumns();if(e===t[t.length-1])return e.measure.getRect().right;let i=e.getNextColumn();if(i&&i.measure===e.measure)return(e.getRect().right+i.getRect().left)/2}return e.getRect().anchorX}layoutFitToMeasure(t){let e=t.unitSize,i=this.getLineLeft(t),s=this.getLineRight(t);[i,s]=[Math.min(i,s),Math.max(i,s)],this.rect=new o.vW(i,s,-e/2,e/2)}pick(t,e){return this.rect.contains(t,e)?[this]:[]}layout(t){this.rect=new o.vW}offset(t,e){this.rect.offsetInPlace(t,e)}draw(t){let{rect:e}=this;const i=this.extension.headObj.musicObj,s=String(i.userData["extension-color"]);"dashed"===this.extension.getLineStyle()&&t.setLineDash([7,3]),t.color(s).lineWidth(1),t.strokeLine(e.left,e.anchorY,e.right,e.anchorY),t.setLineDash([]);let n=this.extension.getTails();if(this===n[n.length-1]&&!$t(this.cols[this.cols.length-1])){let i=e.anchorY>this.line.getRect().anchorY?-t.unitSize:t.unitSize;t.strokeLine(e.right,e.anchorY,e.right,e.anchorY+i)}}},ee=class extends rt{constructor(t,e,i,s,n,...a){var h;super(i),this.connectiveProps=t,this.measure=i,(0,r.Mu)(this,"lx",0),(0,r.Mu)(this,"ly",0),(0,r.Mu)(this,"rx",0),(0,r.Mu)(this,"ry",0),(0,r.Mu)(this,"cp1x",0),(0,r.Mu)(this,"cp1y",0),(0,r.Mu)(this,"cp2x",0),(0,r.Mu)(this,"cp2y",0),(0,r.Mu)(this,"arcHeight",0),(0,r.Mu)(this,"line"),(0,r.Mu)(this,"leftNoteGroup"),(0,r.Mu)(this,"leftNoteId"),(0,r.Mu)(this,"rightNoteGroup"),(0,r.Mu)(this,"rightNoteId"),(0,r.Mu)(this,"tieType"),(0,r.Mu)(this,"mi"),this.line=null!=(h=this.measure.row.findMatchingLine(e))?h:e,this.leftNoteGroup=s,this.leftNoteId=n,a[0]instanceof Lt&&"number"==typeof a[1]?(this.rightNoteGroup=a[0],this.rightNoteId=a[1],this.tieType=void 0):o.I8.isEnumValue(a[0],X)&&(this.rightNoteGroup=void 0,this.rightNoteId=void 0,this.tieType=a[0]),this.measure.addConnectiveObject(this),this.mi=new Ue(this)}getMusicInterface(){return this.mi}get doc(){return this.measure.doc}isInsideMeasure(){return void 0===this.rightNoteGroup||this.leftNoteGroup.measure===this.rightNoteGroup.measure}pick(t,e){return this.rect.contains(t,e)?[this]:[]}layout(t){let e,i,s,n,r,a,{unitSize:c}=t,{measure:g,line:u,leftNoteGroup:l,leftNoteId:d,rightNoteGroup:f,rightNoteId:I,connectiveProps:m}=this,{noteAnchor:C,arcDir:p}=m,{row:A}=g,b=A.getPrevRow(),y=A.getNextRow(),v=A.getConnectivesContentRect();if(e=l.getConnectiveAnchorPoint(m,u,d,C,"left"),i=void 0!==f&&void 0!==I?f.getConnectiveAnchorPoint(m,u,I,C,"right"):"toMeasureEnd"===this.tieType?{x:g.getColumnsContentRect().right,y:e.y}:{x:e.x+c*O,y:e.y},void 0===f)s=e.x,n=e.y,r=i.x,a=i.y;else if(l.row===A&&f.row===A)s=e.x,n=e.y,r=i.x,a=i.y;else if(l.row===b&&f.row===A){let t=b.getConnectivesContentRect().right-e.x,o=i.x-v.left;s=v.left,n=e.y+(i.y-e.y)*t/(t+o),r=i.x,a=i.y}else{if(l.row!==A||f.row!==y)throw new h.O1(h.mN.Score,"Cannot layout connective object because no valid left and right note groups.");{let t=y.getConnectivesContentRect(),o=v.right-e.x,h=i.x-t.left;s=e.x,n=e.y,r=v.right,a=e.y+(i.y-e.y)*o/(o+h)}}let w=("up"===p?-1:1)*c*Math.log2(r-s)/3;this.lx=s,this.ly=n,this.rx=r,this.ry=a,this.arcHeight="slide"===this.connectiveProps.connective?0:w;let{nx:M,ny:S}=o.OZ.Math.calcNormal(s,n,r,a);this.cp1x=.7*s+.3*r+M*this.arcHeight,this.cp1y=.7*n+.3*a+S*this.arcHeight,this.cp2x=.3*s+.7*r+M*this.arcHeight,this.cp2y=.3*n+.7*a+S*this.arcHeight,this.rect=new o.vW(Math.min(this.lx,this.cp1x,this.cp2x,this.rx),Math.max(this.lx,this.cp1x,this.cp2x,this.rx),Math.min(this.ly,this.cp1y,this.cp2y,this.ry),Math.max(this.ly,this.cp1y,this.cp2y,this.ry)),this.line.addObject(this)}offset(t,e){this.lx+=t,this.ly+=e,this.rx+=t,this.ry+=e,this.cp1x+=t,this.cp1y+=e,this.cp2x+=t,this.cp2y+=e,this.rect.offsetInPlace(t,e)}draw(t){if(void 0===this.rightNoteGroup);else if(this.leftNoteGroup.measure===this.rightNoteGroup.measure);else if(this.leftNoteGroup.row.getNextRow()===this.rightNoteGroup.row);else if(this.measure!==this.rightNoteGroup.measure)return;let{rect:e}=this,{_lineWidth:i}=t;t.drawDebugRect(e);let s=1.5*i,n=.25*i;t.lineWidth(1),t.color(this.line instanceof fe?P.Tab_Connective:P.Staff_Connective),0===this.arcHeight?(t.beginPath(),t.moveTo(this.lx,this.ly),t.lineTo(this.rx,this.ry),t.stroke()):(t.beginPath(),t.moveTo(this.lx,this.ly-n),t.bezierCurveTo(this.cp1x,this.cp1y-s,this.cp2x,this.cp2y-s,this.rx,this.ry-n),t.lineTo(this.rx,this.ry+n),t.bezierCurveTo(this.cp2x,this.cp2y+s,this.cp1x,this.cp1y+s,this.lx,this.ly+n),t.fill())}},ie=class{constructor(t,e,i,s){this.connective=t,this.span=e,this.noteAnchor=i,(0,r.Mu)(this,"noteGroups"),(0,r.Mu)(this,"arcDir","down"),this.noteGroups=[s]}getStartNoteGroup(){return this.noteGroups[0]}startsWith(t){return this.noteGroups[0]===t}addNoteGroup(t){return"stub"!==this.span&&"toMeasureEnd"!==this.span&&(this.span>this.noteGroups.length&&(this.noteGroups.push(t),!0))}computeParams(t){let{stemDir:e}=this.noteGroups[0],{hasStem:i}=this.noteGroups[0].rhythmProps;if("stemTip"===this.noteAnchor)this.arcDir="up"===e?"up":"down";else if("auto"===this.noteAnchor)this.arcDir="up"!==e&&i?"up":"down",this.noteGroups[0].notes.length>1||"slide"===this.connective?this.noteAnchor="center":"up"===this.arcDir?this.noteAnchor="above":this.noteAnchor="below";else if("center"===this.noteAnchor){let e=t instanceof de?t:void 0,i=this.noteGroups[0].getDiatonicId(e);this.arcDir=!e||i<e.middleLineDiatonicId?"down":"up"}else"above"===this.noteAnchor?this.arcDir="up":"below"===this.noteAnchor&&(this.arcDir="down")}removeConnectives(){this.noteGroups.forEach(t=>{t.measure.removeConnectiveObjects(),t.removeConnectiveProps()}),this.noteGroups.length=1}createConnectives(){if(0===this.noteGroups.length)return;this.getStartNoteGroup().collectConnectiveProps();let{connective:t,span:e}=this;this.noteGroups[0].row.getNotationLines().forEach(i=>{if(this.computeParams(i),"tie"===t){if(o.I8.isEnumValue(e,X)){let t=this.noteGroups[0];for(let s=0;s<t.notes.length;s++)this.createObjConnectiveWithTieType(i,t,s,e)}else if(this.noteGroups.length>=2)for(let t=0;t<this.noteGroups.length-1;t++){let e=this.noteGroups[t],s=this.noteGroups[t+1];e.notes.forEach((t,n)=>{let o=s.notes.findIndex(e=>a.L7.equals(e,t));o>=0&&this.createObjConnective(i,e,n,s,o)})}}else if("slur"===t){if("number"==typeof e&&e>=2&&this.noteGroups.length===e){let t=this.noteGroups[0],e=this.noteGroups[this.noteGroups.length-1];this.createObjConnective(i,t,0,e,0)}}else if("slide"===t&&this.noteGroups.length>=2)for(let t=0;t<this.noteGroups.length-1;t++){let e=this.noteGroups[t],s=this.noteGroups[t+1];this.createObjConnective(i,e,0,s,0)}})}createObjConnectiveWithTieType(t,e,i,s){if(e.enableConnective(t))if(t instanceof de)new ee(this,t,e.measure,e,i,s);else if(t instanceof fe){void 0!==e.getFretNumberString(i)&&new ee(this,t,e.measure,e,i,s)}}createObjConnective(t,e,i,s,n){const o=(e,i,s,n,o)=>{if(i.enableConnective(t)&&n.enableConnective(t))if(t instanceof de)new ee(this,t,e,i,s,n,o);else if(t instanceof fe){let r=i.getFretNumberString(s),a=n.getFretNumberString(o);void 0===r||void 0===a||r!==a&&"slur"!==this.connective||new ee(this,t,e,i,s,n,o)}};if(e.measure===s.measure)o(e.measure,e,i,s,n);else{if(e.measure.getNextMeasure()!==s.measure)throw new h.O1(h.mN.Score,"Cannot create connective because it is jumping measures.");o(e.measure,e,i,s,n),o(s.measure,e,i,s,n)}}},se=class extends rt{constructor(t,e,i,s,a,h,c){super(t),this.col=t,this.verse=e,this.line=i,this.vpos=s,(0,r.Mu)(this,"nextLyricsObject"),(0,r.Mu)(this,"rhythmProps"),(0,r.Mu)(this,"color","black"),(0,r.Mu)(this,"hyphen"),(0,r.Mu)(this,"text"),(0,r.Mu)(this,"mi"),this.rhythmProps=n.R6.get(a);let g="left"===(null==c?void 0:c.align)?0:"right"===(null==c?void 0:c.align)?1:.5;this.hyphen=o.I8.isEnumValue(null==c?void 0:c.hyphen,_)?null==c?void 0:c.hyphen:void 0,this.text=new At(this,{text:h,color:this.color,scale:.8},g,0),this.rect=this.text.getRect().clone(),this.mi=new Zi(this)}getMusicInterface(){return this.mi}get measure(){return this.col.measure}getText(){return this.text.getText()}setNextLyricsObject(t){this.nextLyricsObject=t}pick(t,e){return this.getRect().contains(t,e)?[this]:[]}layout(t){this.text.layout(t),this.rect=this.text.getRect().clone()}offset(t,e){this.text.offset(t,e),this.rect.offsetInPlace(t,e)}draw(t){var e;if(this.text.draw(t),void 0!==this.hyphen){t.color(this.color).lineWidth(1);let i=this.getRect(),s=null==(e=this.nextLyricsObject)?void 0:e.getRect(),n=1.5*t.unitSize,o=s?.85*(s.left-i.right):n,r="-"===this.hyphen?Math.min(n,o):o;if(r>0){let e=s?(i.right+s.left)/2:i.right+r/.85,n=i.centerY;t.moveTo(e-r/2,n),t.lineTo(e+r/2,n),t.stroke()}}}},ne=class extends rt{constructor(t,e){super(t),this.measure=t,this.tab=e,(0,r.Mu)(this,"voiceId"),(0,r.Mu)(this,"mi"),(0,r.Mu)(this,"tupletPartsTextObjMap",new o.b1),this.voiceId=[0,1,2,3].filter(t=>e.containsVoiceId(t)),this.rect=new o.vW,this.mi=new Bi(this)}getMusicInterface(){return this.mi}get doc(){return this.measure.doc}pick(t,e){return this.rect.contains(t,e)?[this]:[]}layout(t){let e=this.measure.getColumns(),i=[0,1,2,3].map(t=>o.OZ.Math.sum(e.map(e=>e.getVoiceSymbol(t)?1:0)));this.voiceId.sort((t,e)=>o.OZ.Math.cmp(i[t],i[e])),this.rect=new o.vW}hasTuplets(){return this.measure.getBeamGroups().some(t=>t.isTuplet())}layoutFitToMeasure(t){let{unitSize:e,fontSize:i}=t,{measure:s}=this,n=s.getColumnsContentRect(),o=5*e;this.rect.left=n.left,this.rect.anchorX=n.centerX,this.rect.right=n.right,this.rect.top=this.hasTuplets()?-i:0,this.rect.anchorY=0,this.rect.bottom=o}offset(t,e){this.rect.offsetInPlace(t,e)}draw(t){t.drawDebugRect(this.rect),t.lineWidth(1);let{unitSize:e,fontSize:i}=t,s=e,n=e,r=.25*e,{bottom:a,anchorY:h}=this.getRect(),c=h,g=a,u=this.measure.getColumns();for(let l=0;l<u.length;l++){let e=u[l],a=this.voiceId.map(t=>e.getVoiceSymbol(t)).find(t=>void 0!==t);if(!a)continue;let h=a.getBeamGroup(),d=h?h.getSymbols():[a];for(let f=0;f<d.length;f++){let e=d[f],a=d[f+1],I=e.col.getRect().anchorX;if(e instanceof Lt){if(t.lineWidth(1),t.color(P.Tab_Note),e.rhythmProps.noteSize>=2&&(t.lineWidth(4===e.rhythmProps.noteSize?2:1),t.strokeLine(I,g,I,c)),1===d.length)for(let i=0;i<e.rhythmProps.flagCount;i++)t.drawFlag(new o.vW(I,I+s,c+i*s,c+(i+2)*s),"up");for(let i=0;i<e.rhythmProps.dotCount;i++)t.fillCircle(I+n*(i+1),g-r,r)}else if(e instanceof St){t.lineWidth(1),t.color(P.Tab_Rest);let i=I,s=(c+g)/2,o=.65;t.save(),t.scale(o,o),t.drawRest(e.rhythmProps.noteSize,i/o,s/o),t.restore();for(let a=0;a<e.rhythmProps.dotCount;a++)i+=1.5*n,t.fillCircle(i,s+n,r)}if(a){let i=e,o=a,h=i.col.getRect().anchorX,u=o.col.getRect().anchorX,l=i.hasTuplet()?1:i instanceof Lt?i.getRightBeamCount():1,d=o.hasTuplet()?1:o instanceof Lt?o.getLeftBeamCount():1,f=Math.max(l,d);t.color(P.Tab_Note),t.lineWidth(2);for(let e=0;e<f;e++){let i=d>l&&e>=l?.75:0,n=l>d&&e>=d?.25:1;t.strokePartialLine(h,c+e*s,u,c+e*s,i,n)}t.lineWidth(1);for(let e=0;e<i.rhythmProps.dotCount;e++)t.fillCircle(h+n*(e+1),g-r,r);for(let e=0;e<o.rhythmProps.dotCount;e++)t.fillCircle(u+n*(e+1),g-r,r)}if(h&&h.isTuplet()){t.color(P.Tab_Note);let e=(d[0].col.getRect().anchorX+d[d.length-1].col.getRect().anchorX)/2,s=h.getTupletRatioText(),n=this.tupletPartsTextObjMap.get(s);n||(this.tupletPartsTextObjMap.set(s,n=new At(this,{text:s,scale:.75},.5,.5)),n.layout(t)),n.setCenter(e,c-i/2),n.draw(t)}d.length>1&&(l=u.indexOf(d[d.length-1].col),l<0&&(l=u.length))}}}};var oe=class{constructor(){(0,r.Mu)(this,"tabTuning_0",0),(0,r.Mu)(this,"signature_1",0),(0,r.Mu)(this,"leftBarLine_2",0),(0,r.Mu)(this,"padding_3",0),(0,r.Mu)(this,"columnsMin_4",0),(0,r.Mu)(this,"padding_5",0),(0,r.Mu)(this,"rightBarLine_6",0)}get leftSolid(){return this.tabTuning_0+this.signature_1+this.leftBarLine_2+this.padding_3}get columnsMin(){return this.columnsMin_4}get rightSolid(){return this.padding_5+this.rightBarLine_6}},re=class extends rt{constructor(t,e){super(t),this.row=t,this.options=e,(0,r.Mu)(this,"prevMeasure"),(0,r.Mu)(this,"nextMeasure"),(0,r.Mu)(this,"keySignature",(0,a.$E)()),(0,r.Mu)(this,"timeSignature",(0,a.tW)()),(0,r.Mu)(this,"tempo",(0,a.ze)()),(0,r.Mu)(this,"alterKeySignature"),(0,r.Mu)(this,"alterTimeSignature"),(0,r.Mu)(this,"alterTempo"),(0,r.Mu)(this,"signatures",[]),(0,r.Mu)(this,"tabStringNotes",[]),(0,r.Mu)(this,"barLineLeft"),(0,r.Mu)(this,"columns",[]),(0,r.Mu)(this,"barLineRight"),(0,r.Mu)(this,"connectives",[]),(0,r.Mu)(this,"beamGroups",[]),(0,r.Mu)(this,"measureId"),(0,r.Mu)(this,"regions",new oe),(0,r.Mu)(this,"needLayout",!0),(0,r.Mu)(this,"voiceSymbols",(0,o.Sl)(new o.qG)),(0,r.Mu)(this,"lastAddedRhythmColumn"),(0,r.Mu)(this,"lastAddedRhythmSymbol"),(0,r.Mu)(this,"addExtensionTo",[]),(0,r.Mu)(this,"layoutObjects",[]),(0,r.Mu)(this,"postMeasureBreakWidth",0),(0,r.Mu)(this,"passCount",0),(0,r.Mu)(this,"needBeamsUpdate",!0),(0,r.Mu)(this,"navigationSet",new o.wu),(0,r.Mu)(this,"isEndSong",!1),(0,r.Mu)(this,"isEndSection",!1),(0,r.Mu)(this,"endRepeatPlayCount",2),(0,r.Mu)(this,"endRepeatPlayCountText"),(0,r.Mu)(this,"staticObjectsCache",new o.b1),(0,r.Mu)(this,"lyricsObjectsCache",new o.Yz),(0,r.Mu)(this,"mi"),this.mi=new ri(this),this.prevMeasure=t.doc.getLastMeasure(),this.prevMeasure&&(this.prevMeasure.nextMeasure=this),this.barLineLeft=new Vt(this),this.barLineRight=new Ht(this),this.measureId=this.prevMeasure?this.prevMeasure.measureId+1:0,this.updateKeySignature(),this.updateTimeSignature(),this.updateTempo(),this.row.getTabs().forEach(t=>{this.addLayoutObject(new ne(this,t),t,0,0)})}getMusicInterface(){return this.mi}get doc(){return this.row.doc}isPartialMeasure(){return this.getConsumedTicks()<this.getMeasureTicks()}isUpBeat(){return this===this.doc.getFirstMeasure()}resetPassCount(){this.passCount=0}incPassCount(){this.passCount++}getPassCount(){return this.passCount}updateRunningArguments(t){var e;null!=t||(t=[]);let i=o.OZ.Math.sum([0,1,2,3].map(t=>this.getVoiceSymbols(t).length>0?1:0));[0,1,2,3].forEach(e=>{var s;let n=null!=(s=t[e])?s:t[e]={diatonicId:(()=>{let t=this.row.getStaves().filter(t=>t.containsVoiceId(e)),i=this.row.getTabs().filter(t=>t.containsVoiceId(e));return t.length>0?t[0].middleLineDiatonicId:i.length>0?i[0].getTuningStrings()[3].diatonicId:a.L7.getNote("G4").diatonicId})(),stemDir:"auto",stringNumbers:[]};this.getVoiceSymbols(e).forEach((t,e,s)=>{var o,r;if(t.setDiatonicId===St.UndefinedDiatonicId?i<2&&(n.diatonicId=St.UndefinedDiatonicId):n.diatonicId=t.setDiatonicId,t instanceof Lt)switch(t.setStringsNumbers&&(n.stringNumbers=t.setStringsNumbers),null==(o=t.options)?void 0:o.stem){case"up":case"up":n.stemDir="up";break;case"down":case"down":n.stemDir="down";break;case"auto":case"auto":n.stemDir="auto"}let a,h=null==(r=t.getBeamGroup())?void 0:r.getSymbols();a=void 0===h?"auto"===n.stemDir?this.row.solveAutoStemDir([t]):n.stemDir:t===h[0]?"auto"===n.stemDir?this.row.solveAutoStemDir(h):n.stemDir:h[0].stemDir,t.updateRunningArguments(n.diatonicId,a,n.stringNumbers)})}),null==(e=this.getNextMeasure())||e.updateRunningArguments(t)}pick(t,e){if(!this.getRect().contains(t,e))return[];for(let i=0;i<this.signatures.length;i++){let s=this.signatures[i].pick(t,e);if(s.length>0)return[this,...s]}for(let i=0;i<this.tabStringNotes.length;i++){let s=this.tabStringNotes[i].pick(t,e);if(s.length>0)return[this,...s]}for(let i=0;i<this.columns.length;i++){let s=this.columns[i].pick(t,e);if(s.length>0)return[this,...s]}if(this.barLineLeft){let i=this.barLineLeft.pick(t,e);if(i.length>0)return[this,...i]}if(this.barLineRight){let i=this.barLineRight.pick(t,e);if(i.length>0)return[this,...i]}if(this.endRepeatPlayCountText){let i=this.endRepeatPlayCountText.pick(t,e);if(i.length>0)return[this,...i]}for(let i=0;i<this.connectives.length;i++){let s=this.connectives[i].pick(t,e);if(s.length>0)return[this,...s]}for(let i=0;i<this.beamGroups.length;i++){let s=this.beamGroups[i].pick(t,e);if(s.length>0)return[this,...s]}for(let i=0;i<this.layoutObjects.length;i++){let s=this.layoutObjects[i].musicObj.pick(t,e);if(s.length>0)return[this,...s]}return[this]}getMeasureNumber(){let t=this.doc.getFirstMeasure();return t&&t.isPartialMeasure()?this.measureId:this.measureId+1}getColumns(){return this.columns}getColumnCount(){return this.columns.length}getColumn(t){return this.getColumns()[t]}isFirstMeasure(){return void 0===this.prevMeasure}isLastMeasure(){return void 0===this.nextMeasure}isFirstMeasureInRow(){return this===this.row.getFirstMeasure()}isLastMeasureInRow(){return this===this.row.getLastMeasure()}getNextMeasure(){return this.nextMeasure}getPrevMeasure(){return this.prevMeasure}getKeySignature(){return this.keySignature}setKeySignature(...t){var e;if(null==(e=this.getPrevMeasure())||e.endSection(),t[0]instanceof a.u9)this.alterKeySignature=t[0];else if(t[0]instanceof a.FE)this.alterKeySignature=t[0];else if(o.I8.isNonEmptyString(t[0]))if(1===t.length)this.alterKeySignature=(0,a.X_)(t[0]);else if(2===t.length)try{let e=""+t[0],i=(0,a.Jv)(""+t[1]);this.alterKeySignature=(0,a.X_)(e,i)}catch(i){throw new h.O1(h.mN.Score,"Cannot set key signature because invalid args: "+t)}this.updateKeySignature()}updateKeySignature(){this.keySignature=this.prevMeasure?this.prevMeasure.keySignature:(0,a.$E)(),this.alterKeySignature&&(this.keySignature=this.alterKeySignature),this.nextMeasure&&this.nextMeasure.updateKeySignature(),this.requestLayout()}getTimeSignature(){return this.timeSignature}setTimeSignature(t){var e;null==(e=this.getPrevMeasure())||e.endSection(),this.alterTimeSignature=t,this.updateTimeSignature()}updateTimeSignature(){this.timeSignature=this.prevMeasure?this.prevMeasure.timeSignature:(0,a.tW)(),this.alterTimeSignature&&(this.timeSignature=this.alterTimeSignature),this.nextMeasure&&this.nextMeasure.updateTimeSignature(),this.requestLayout()}getTempo(){return this.tempo}setTempo(t,e){var i;if(null==(i=this.getPrevMeasure())||i.endSection(),void 0===e)this.alterTempo={beatsPerMinute:t};else{let i=a.Xp.get(e).dotCount,s={beatLength:(0,a.PW)(e),dotCount:i>0?i:void 0};this.alterTempo={beatsPerMinute:t,options:s}}this.updateTempo()}updateTempo(){var t;if(this.tempo=this.prevMeasure?this.prevMeasure.tempo:(0,a.ze)(),this.alterTempo){let e,i,s=this.alterTempo.beatsPerMinute;this.alterTempo.options?(e=this.alterTempo.options.beatLength,i=null!=(t=this.alterTempo.options.dotCount)?t:0):this.alterTimeSignature?(e=this.alterTimeSignature.beatLength,i=0):(e=this.tempo.options.beatLength,i=this.tempo.options.dotCount),this.tempo={beatsPerMinute:s,options:{beatLength:e,dotCount:i}}}this.nextMeasure&&this.nextMeasure.updateTempo(),this.requestLayout()}hasPostMeasureBreak(){return this.isEndSong&&this!==this.row.getLastMeasure()}getPostMeasureBreakWidth(){return this.postMeasureBreakWidth}addLayoutObject(t,e,i,s){const n=new ge(t,e,i,s);return this.layoutObjects.push(n),this.requestLayout(),this.requestRectUpdate(),n}forEachStaffGroup(t,e,i){const s=this.row.getNotationLines(),n=(t,r,a=[])=>{if("number"==typeof t)s[t]&&i(s[t],r);else if("string"==typeof t&&t.length>0){let h=s.filter(e=>e.name===t);if(h.forEach(t=>i(t,r)),0===h.length){let i=this.doc.getStaffGroup(t);if(i&&!a.includes(t)){let s=[...a,t];(o.I8.isArray(i.staffsTabsAndGroups)?i.staffsTabsAndGroups:[i.staffsTabsAndGroups]).forEach(t=>{switch(i.verticalPosition){case"above":n(t,0,s);break;case"below":n(t,1,s);break;case"both":n(t,0,s),n(t,1,s);break;case"auto":n(t,e,s)}})}}}};void 0===t?s.length>=2&&s[0]instanceof de&&s[1]instanceof de&&void 0!==s[0].staffConfig.grandId&&s[0].staffConfig.grandId===s[1].staffConfig.grandId?n(1===e?1:0,e):n(0,e):o.I8.isArray(t)?t.forEach(t=>n(t,e)):n(t,e)}addFermata(t,e){let i="atMeasureEnd"===e?this.barLineRight:this.lastAddedRhythmColumn;if(!i)throw new h.O1(h.mN.Score,"Cannot add Fermata because anchor is undefined.");this.forEachStaffGroup(t,0,(t,e)=>{const s=t instanceof fe?P.Staff_Element_Fermata:P.Tab_Element_Fermata;this.addLayoutObject(new _t(i,e,s),t,1,e)}),this.disableExtension(),this.requestLayout()}hasFermata(t){return this.layoutObjects.some(e=>e.musicObj instanceof _t&&e.anchor===t)}addNavigation(t,e,...i){let s;switch(e){case"ending":if(this.navigationSet.has(e))throw new h.O1(h.mN.Score,"Cannot add ending beasure measure already has one.");let n=this,r=i;s={createObj:t=>{const e=t instanceof fe?P.Staff_Element_Navigation:P.Tab_Element_Navigation;return new Xt(n,e,r)},layoutGroupId:4,defaultVerticalPos:0};break;case"D.C. al Coda":case"D.C. al Fine":case"D.S. al Coda":case"D.S. al Fine":{let i=this.barLineRight,n=Dt(e);s={createObj:t=>{const e=t instanceof fe?P.Staff_Element_Navigation:P.Tab_Element_Navigation;return new At(i,{text:n,color:e},1,1)},layoutGroupId:3,defaultVerticalPos:0},this.addNavigation(t,"endRepeat"),this.endSong();break}case"Fine":{let t=this.barLineRight,i=Dt(e);s={createObj:e=>{const s=e instanceof fe?P.Staff_Element_Navigation:P.Tab_Element_Navigation;return new At(t,{text:i,color:s},1,1)},layoutGroupId:3,defaultVerticalPos:0};break}case"Segno":case"Coda":{let t=this.barLineLeft,i=Dt(e);s={createObj:e=>{const s=e instanceof fe?P.Staff_Element_Navigation:P.Tab_Element_Navigation;return new Ot(t,i,s)},layoutGroupId:3,defaultVerticalPos:0};break}case"toCoda":{let t=this.barLineRight,i=Dt(e);s={createObj:e=>{const s=e instanceof fe?P.Staff_Element_Navigation:P.Tab_Element_Navigation;return new Ot(t,i,s)},layoutGroupId:3,defaultVerticalPos:0};break}case"endRepeat":if(0===i.length)this.endRepeatPlayCount=2;else{if(!o.I8.isIntegerGte(i[0],2))throw new h.O1(h.mN.Score,"Invalid end repeat play count (should be 2 or greater integer): "+i[0]);this.endRepeatPlayCount=i[0]}if(2!==this.endRepeatPlayCount){const t={text:`${this.endRepeatPlayCount}x`,scale:.8,color:P.Staff_Frame};this.endRepeatPlayCountText=new At(this,t,.5,1)}}s&&this.forEachStaffGroup(t,s.defaultVerticalPos,(t,e)=>{this.addLayoutObject(s.createObj(t),t,s.layoutGroupId,e)}),this.navigationSet.add(e),this.disableExtension()}hasNavigation(t){return this.navigationSet.has(t)}addAnnotation(t,e,i){let s=this.lastAddedRhythmColumn;if(!s)throw new h.O1(h.mN.Score,"Cannot add annotation because anchor is undefined.");if(0===i.length)throw new h.O1(h.mN.Score,"Cannot add annotation because annotation text is empty.");let n,o,r,a={text:i};switch(e){case"dynamics":n=6,o=0,a.italic=!0,r="bottom";break;case"tempo":n=5,o=0,a.italic=!0,r="bottom"}const c=function(t){switch(t){case"bottom":return.8;case"middle":return.5}}(r);this.disableExtension(),this.forEachStaffGroup(t,o,(t,e)=>{const i=t instanceof fe?P.Staff_Element_Annotation:P.Tab_Element_Annotation;a.color=i;let o=new At(s,a,.5,c);const r=this.addLayoutObject(o,t,n,e);this.enableExtension(r,i)})}addLabel(t,e,i){let s=this.lastAddedRhythmColumn;if(!s)throw new h.O1(h.mN.Score,"Cannot add label because anchor is undefined.");if(0===i.length)throw new h.O1(h.mN.Score,"Cannot add label because label text is empty.");let n,o,r={text:i};switch(e){case"note":n=2,o=1;break;case"chord":n=7,o=0}this.disableExtension(),this.forEachStaffGroup(t,o,(t,e)=>{const i=t instanceof fe?P.Staff_Element_Label:P.Tab_Element_Label;r.color=i;let o=new At(s,r,.5,1);const a=this.addLayoutObject(o,t,n,e);this.enableExtension(a,i)})}addConnective(t,...e){let i=this.lastAddedRhythmSymbol;if(!(i instanceof Lt))throw new h.O1(h.mN.Score,"Connective can be added to note group only.");if("tie"===t){let t=o.I8.isInteger(e[0])||o.I8.isEnumValue(e[0],X)?e[0]:2,s=o.I8.isEnumValue(e[1],q)?e[1]:"auto";i.startConnective(new ie("tie",t,s,i))}else if("slur"===t){let t=o.I8.isInteger(e[0])?e[0]:2,s=o.I8.isEnumValue(e[1],q)?e[1]:"auto";i.startConnective(new ie("slur",t,s,i))}else if("slide"===t){let t=o.I8.isEnumValue(e[0],q)?e[0]:"auto";i.startConnective(new ie("slide",2,t,i))}}addExtension(t,e){if(this.addExtensionTo.forEach(i=>{const{layoutObj:s,color:n}=i,{musicObj:r}=s;r.userData["extension-color"]=n;const c=r.getParent();if(!(r instanceof At&&c instanceof Tt))throw new h.O1(h.mN.Score,"Cannot add extension becaue no compatible music object to attach it to.");{let i="dashed",n="bottom",h=new Et(s,c,function(t){if("string"==typeof t&&(t=[t]),o.I8.isArray(t)){let e=0;for(let i=0;i<t.length;){let s=t[i],n=t[i+1];if("string"==typeof s){i++;let t=a.R6.get(s).ticks;"number"==typeof n&&(i++,t*=n),e+=t}else i++}return e}return t}(t),e,i,n);r.setLink(h)}}),0===this.addExtensionTo.length)throw new h.O1(h.mN.Score,"Cannot add extension because music object to attach it to is undefined.");this.disableExtension(),this.requestLayout()}enableExtension(t,e){this.addExtensionTo.push({layoutObj:t,color:e})}disableExtension(){this.addExtensionTo=[]}getEnding(){return this.layoutObjects.map(t=>t.musicObj).find(t=>t instanceof Xt)}getEndRepeatPlayCount(){return this.endRepeatPlayCount}endSong(){this.isEndSong=!0,this.requestLayout(),this.disableExtension()}hasEndSong(){return this.isEndSong}endSection(){this.isEndSection=!0,this.requestLayout(),this.disableExtension()}hasEndSection(){return this.isEndSection}endRow(){this.doc.requestNewRow(),this.disableExtension()}addRhythmSymbol(t){let{col:e,voiceId:i}=t;e.setVoiceSymbol(i,t),this.voiceSymbols.add(i,t),t.oldStyleTriplet&&this.createOldStyleTriplets(i),this.requestBeamsUpdate(),this.lastAddedRhythmColumn=e,this.lastAddedRhythmSymbol=t}addNoteGroup(t,e,i,s,n){let o=e.map(t=>"string"==typeof t?a.L7.getNote(t):t),r=this.getRhythmColumn(t),h=new Lt(r,t,o,i,s,n);return this.addRhythmSymbol(h),h}addRest(t,e,i,s){let n=this.getRhythmColumn(t),o=new St(n,t,e,i,s);return this.addRhythmSymbol(o),o}addLyrics(t,e,i,s,n){this.forEachStaffGroup(t,1,(t,r)=>{var c;let g=this.getRhythmColumn({verse:e,line:t,vpos:r}),u=new se(g,e,t,r,(0,a.PW)(i),s,n);g.addLyricsObject(u);let l=this.lyricsObjectsCache.getOrCreate(t,r,e,[]);l.push(u),l.sort((t,e)=>o.OZ.Math.cmp(t.col.positionTicks,e.col.positionTicks)),null==(c=u.measure.getPrevLyricsObject(u))||c.setNextLyricsObject(u),this.addLayoutObject(u,t,function(t){switch(t){case 1:return 8;case 2:return 9;case 3:return 10;default:throw new h.O1(h.mN.Unknown,"VerseNumber is not 1, 2 or 3.")}}(e),r),this.lastAddedRhythmColumn=g})}getRhythmColumn(t){let e=0;for(let i=this.columns.length-1;i>=0&&0===e;i--){let s=this.columns[i],n="number"==typeof t?s.getVoiceSymbol(t):s.getLyricsObject(t.verse,t.line,t.vpos);n&&(e=s.positionTicks+n.rhythmProps.ticks)}for(let i=0;i<=this.columns.length;i++){let t=this.columns[i];if(t&&t.positionTicks===e)return t;if(!t||t.positionTicks>e){let t=new Tt(this,e);return this.columns.splice(i,0,t),t}}throw new h.O1(h.mN.Score,"Error in rhythm column. Should never get here.")}getMeasureTicks(){return this.getTimeSignature().measureTicks}getConsumedTicks(t){let e=0;return this.columns.forEach(i=>{[0,1,2,3].forEach(s=>{let n=i.getVoiceSymbol(s);!n||void 0!==t&&t!==s||(e=Math.max(e,i.positionTicks+n.rhythmProps.ticks))})}),e}getColumnsContentRect(){return new o.vW(this.barLineLeft.getRect().anchorX,this.barLineRight.getRect().anchorX,this.getRect().top,this.getRect().bottom)}getLeftSolidWidth(){return this.regions.leftSolid}getMinColumnsWidth(){return this.regions.columnsMin}getRightSolidWidth(){return this.regions.rightSolid}getTotalSolidWidth(){return this.getLeftSolidWidth()+this.getRightSolidWidth()}getMinWidth(){return this.getLeftSolidWidth()+this.getMinColumnsWidth()+this.getRightSolidWidth()}getStaffLineLeft(){let t=this.getPrevMeasure();return t&&t.row===this.row&&!t.hasPostMeasureBreak()?t.getStaffLineRight():this.getRect().left+this.regions.tabTuning_0}getStaffLineRight(){return this.barLineRight.getRect().anchorX}getPrevLyricsObject(t){var e;let{line:i,verse:s,vpos:n}=t,o=this.lyricsObjectsCache.getOrDefault(i,n,s,[]),r=o.indexOf(t);if(r>0)return o[r-1];if(0===r){let o=null==(e=t.measure.getPrevMeasure())?void 0:e.lyricsObjectsCache.get(i,n,s);if(o&&o.length>0)return o[o.length-1]}}getStaticObjects(t){let e=this.layoutObjects.filter(e=>e.line===t&&e.isPositionResolved()).map(t=>t.musicObj),i=e.length>0?[...this.staticObjectsCache.getOrDefault(t,[]),...e]:this.staticObjectsCache.getOrDefault(t,[]);return i.forEach(t=>t.getRect()),i}addStaticObject(t,e){this.staticObjectsCache.getOrCreate(t,[]).push(e)}removeLayoutObjects(t){this.layoutObjects=this.layoutObjects.filter(e=>{if(e.musicObj===t){let t=e.musicObj.getLink();return t&&t.detachTail(e.musicObj),e.layoutGroup.remove(e),!1}return!0})}addConnectiveObject(t){this.connectives.push(t),this.requestLayout()}removeConnectiveObjects(){this.connectives.length>0&&(this.connectives=[],this.requestLayout())}createExtensions(){this.layoutObjects.forEach(t=>{let{musicObj:e,measure:i,layoutGroupId:s,verticalPos:n,line:o}=t;if(e.getLink()instanceof Et){let t=e.getLink();if(t.getHead()!==e)return;if(t.getTails().forEach(t=>i.removeLayoutObjects(t)),!t.isVisible())return;const r=t.getRange(),a=r.columnRange.slice();for(let i=!0;a.length>1;i=!1){const{measure:h}=a[0],c=a.findIndex(t=>t.measure!==h),g=a.splice(0,c>0?c:a.length);if(g.length<2)continue;const u=h.row.findMatchingLine(o);if(!u)continue;const l=0===a.length,d=[...i?[e]:[],...g,...l&&r.stopObject?[r.stopObject]:[]];h.addLayoutObject(new te(h,u,t,d),u,s,n)}}})}addBeamGroup(t){this.beamGroups.push(t)}requestBeamsUpdate(){this.needBeamsUpdate=!0}createOldStyleTriplets(t){let e=this.getVoiceSymbols(t);for(let i=0;i<e.length;)if(e[i].oldStyleTriplet){let t=Qt.createOldStyleTriplet(e.slice(i,i+3));i+=0===t?1:t}else i++;this.requestLayout()}getBeamGroups(){return this.beamGroups}createBeams(){if(!this.needBeamsUpdate)return;this.beamGroups=this.beamGroups.filter(t=>!!t.isTuplet()||(t.detach(),!1));let t=this.getTimeSignature();this.needBeamsUpdate&&0!==t.beamGroupSizes.length&&([0,1,2,3].forEach(e=>{let i=this.getVoiceSymbols(e).slice();if(i.length<2)return;let s=this.isUpBeat()?Math.max(0,this.getMeasureTicks()-this.getConsumedTicks()):0,n=0;for(let r=0;r<t.beamGroupSizes.length;r++){let e=t.beamGroupSizes[r],h=[e];e.length>1&&h.unshift([o.OZ.Math.sum(e)]);let c=!1,g=n;for(;h.length>0&&!c;){let t=h.shift();n=g,t.forEach(t=>{let e=t*a.Xp.get("8n").ticks,r=n+e,g=i.filter(t=>{let e=s+t.col.positionTicks,i=e+t.rhythmProps.ticks;return e>=n&&i<=r});o.OZ.Math.sum(g.map(t=>t.rhythmProps.ticks))===e&&g.every(t=>t instanceof Lt)&&(g.every(t=>1===t.rhythmProps.flagCount)||0===h.length)&&Qt.createBeam(g)&&(c=!0),n+=e})}}}),this.needBeamsUpdate=!1,this.requestLayout())}getBarLineLeft(){return this.barLineLeft}getBarLineRight(){return this.barLineRight}getVoiceSymbols(t){return this.voiceSymbols.getAll(t)}completeRests(t){if(void 0!==t)if(o.I8.isArray(t))t.forEach(t=>this.completeRests(t));else{B(t);let e=this.getMeasureTicks()-this.getConsumedTicks(t),i=[];for(;e>0;)for(let t=a.Xp.LongestNoteSize;t<=a.Xp.ShortestNoteSize;t*=2){let s=a.Xp.create(t).noteLength;for(let t=a.Xp.get(s).maxDotCount;t>=0;t--){let n=a.R6.get(s,t);for(;n.ticks<=e;)i.push(n),e-=n.ticks}}i.reverse().forEach(e=>this.addRest(t,a.Xp.create(e.noteLength,e.dotCount).noteLength))}else 0===this.getConsumedTicks()?this.completeRests(0):this.completeRests([0,1,2,3].filter(t=>this.getConsumedTicks(t)>0))}requestLayout(){this.needLayout||(this.needLayout=!0,this.row.requestLayout())}layout(t){var e;if(!this.needLayout)return;this.staticObjectsCache.clear(),this.requestRectUpdate();let{unitSize:i}=t;this.postMeasureBreakWidth=this.hasPostMeasureBreak()?I*i:0;let s=this.isFirstMeasureInRow(),n=!0===(null==(e=this.getPrevMeasure())?void 0:e.hasPostMeasureBreak());this.regions.tabTuning_0=s&&this.row.hasTab?4*i:0;let o=s||n,r=!1!==this.options.showNumber&&(!0===this.options.showNumber||s&&!this.row.isFirstRow()),h=s||n||!!this.alterKeySignature,c=!!this.alterTimeSignature,g=!!this.alterTempo;this.signatures=[],this.row.getNotationLines().forEach((e,i)=>{if(e instanceof de&&(o||r||h||c||g)){let s=this.signatures.filter(t=>t instanceof bt).find(t=>t.staff===e),n=null!=s?s:new bt(this,e);n.staff.addObject(n),n.updateClefImage(t,o),n.updateMeasureNumber(r&&0===i),n.updateKeySignature(h),n.updateTimeSignature(c),n.updateTempo(g&&0===i),n.layout(t),this.signatures.push(n)}else if(e instanceof fe&&(r||c||g)){let s=this.signatures.filter(t=>t instanceof yt).find(t=>t.tab===e),n=null!=s?s:new yt(this,e);n.tab.addObject(n),n.updateMeasureNumber(r&&0===i),n.updateTimeSignature(c),n.updateTempo(g&&0===i),n.layout(t),this.signatures.push(n)}}),this.tabStringNotes.length=0,this.isFirstMeasureInRow()&&this.row.getTabs().forEach(e=>{for(let i=0;i<6;i++){let s=e.getTuningStrings()[i].format(a.Nf.Helmholtz,a.dd.Unicode),n=P.Tab_Tuning,o=new At(this,{text:s,scale:.8,color:n},1,.5);o.layout(t),o.setRight(.8*this.regions.tabTuning_0),o.setCenterY(e.getStringY(i)),this.tabStringNotes.push(o),e.addObject(o)}}),this.barLineLeft.layout(t);const u=new mt(this);this.columns.forEach(e=>e.layout(t,u)),this.columns.forEach(e=>e.layoutReserveSpace(t)),this.barLineRight.layout(t),this.endRepeatPlayCountText&&this.endRepeatPlayCountText.layout(t),this.layoutObjects.forEach(e=>e.layout(t));let l=t.unitSize;this.regions.signature_1=Math.max(0,...this.signatures.map(t=>t.getRect().width)),this.regions.leftBarLine_2=this.barLineLeft.getRect().width,this.regions.padding_3=l,this.regions.columnsMin_4=Math.max(d*i,this.columns.map(t=>t.getRect().width).reduce((t,e)=>t+e,0)),this.regions.padding_5=l,this.regions.rightBarLine_6=this.barLineRight.getRect().width}layoutWidth(t,e){if(!this.needLayout)return;e=Math.max(e,this.getMinWidth()),this.rect=new o.vW,this.rect.anchorX=this.rect.left+e/2,this.rect.right=this.rect.left+e,this.signatures.forEach(t=>{t.setLeft(this.rect.left+this.regions.tabTuning_0),t.setAnchorY(this.rect.anchorY)});let i=Math.max(0,...this.signatures.map(t=>t.getRect().width));this.barLineLeft.setLeft(this.rect.left+this.regions.tabTuning_0+i),this.barLineLeft.setAnchorY(this.rect.anchorY),this.barLineRight.setRight(this.rect.right),this.barLineRight.setAnchorY(this.rect.anchorY),this.endRepeatPlayCountText&&(this.endRepeatPlayCountText.setCenterX(this.barLineRight.getRect().left),this.endRepeatPlayCountText.setBottom(this.barLineRight.getRect().top));let s=this.rect.left+this.regions.leftSolid,n=(this.rect.right-this.regions.rightSolid-s)/this.regions.columnsMin,r=s;this.columns.forEach(t=>{let e=t.getRect(),i=r+e.leftw*n;t.setAnchor(i,this.rect.anchorY),r+=e.width*n}),[0,1,2,3].forEach(t=>{const e=this.getVoiceSymbols(t),i=1===e.length&&e[0]instanceof St?e[0]:void 0;if(!i)return;0===[0,1,2,3].map(t=>i.col.getVoiceSymbol(t)).filter(t=>void 0!==t&&t!==i).length||i.setAnchorX(this.getColumnsContentRect().centerX)})}layoutConnectives(t){this.needLayout&&this.connectives.forEach(e=>{e.layout(t),this.rect.top=Math.min(this.rect.top,e.getRect().top),this.rect.bottom=Math.max(this.rect.bottom,e.getRect().bottom)})}layoutBeams(t){this.needLayout&&this.beamGroups.forEach(e=>{e.layout(t),this.rect.top=Math.min(this.rect.top,e.getRect().top),this.rect.bottom=Math.max(this.rect.bottom,e.getRect().bottom)})}alignStemsToBeams(){this.beamGroups.forEach(t=>t.updateStemTips())}layoutDone(){this.columns.forEach(t=>t.layoutDone()),this.needLayout=!1}updateRect(){this.rect.top=Math.min(...this.signatures.map(t=>t.getRect().top),...this.tabStringNotes.map(t=>t.getRect().top),this.barLineLeft.getRect().top,...this.columns.filter(t=>!t.isEmpty()).map(t=>t.getRect().top),this.barLineRight.getRect().top,...this.connectives.map(t=>t.getRect().top),...this.beamGroups.filter(t=>!t.isEmpty()).map(t=>t.getRect().top),...this.layoutObjects.filter(t=>t.isPositionResolved()).map(t=>t.musicObj.getRect().top)),this.rect.bottom=Math.max(...this.signatures.map(t=>t.getRect().bottom),...this.tabStringNotes.map(t=>t.getRect().bottom),this.barLineLeft.getRect().bottom,...this.columns.filter(t=>!t.isEmpty()).map(t=>t.getRect().bottom),this.barLineRight.getRect().bottom,...this.connectives.map(t=>t.getRect().bottom),...this.beamGroups.filter(t=>!t.isEmpty()).map(t=>t.getRect().bottom),...this.layoutObjects.filter(t=>t.isPositionResolved()).map(t=>t.musicObj.getRect().bottom)),this.isLastMeasureInRow()&&(this.rect.right=Math.max(this.rect.right,...this.layoutObjects.filter(t=>t.isPositionResolved()&&t.musicObj instanceof _t).map(t=>t.musicObj.getRect().right))),this.row.getNotationLines().forEach(t=>{this.rect.top=Math.min(this.rect.top,t.calcTop()),this.rect.bottom=Math.max(this.rect.bottom,t.calcBottom())}),this.row.requestRectUpdate()}offset(t,e){this.signatures.forEach(e=>e.offset(t,0)),this.tabStringNotes.forEach(e=>e.offset(t,0)),this.barLineLeft.offset(t,e),this.columns.forEach(i=>i.offset(t,e)),this.barLineRight.offset(t,e),this.endRepeatPlayCountText&&this.endRepeatPlayCountText.offset(t,e),this.connectives.forEach(e=>e.offset(t,0)),this.beamGroups.forEach(i=>i.offset(t,e)),this.layoutObjects.forEach(e=>e.offset(t,0)),this.rect.offsetInPlace(t,e),this.requestRectUpdate()}draw(t){t.drawDebugRect(this.getRect()),t.lineWidth(1);let e=this.getStaffLineLeft(),i=this.getStaffLineRight();const s=(s,n)=>t.color(n).strokeLine(e,s,i,s);this.row.getNotationLines().forEach(t=>{if(t instanceof de)for(let e=t.bottomLineDiatonicId;e<=t.topLineDiatonicId;e+=2)s(t.getDiatonicIdY(e),P.Staff_Frame);else if(t instanceof fe)for(let e=0;e<6;e++)s(t.getStringY(e),P.Tab_Frame)}),this.isFirstMeasureInRow()&&1===this.row.getNotationLines().length&&this.row.getTabs().forEach(e=>{if(e.getRowGroup().hasBrace)return;const i=this.getStaffLineLeft(),s=e.getTopLineY(),n=e.getBottomLineY();t.color(P.Tab_Frame).lineWidth(1).strokeLine(i,s,i,n)}),this.signatures.forEach(e=>e.draw(t)),this.tabStringNotes.forEach(e=>e.draw(t)),this.barLineLeft.draw(t),this.columns.forEach(e=>e.draw(t)),this.barLineRight.draw(t),this.endRepeatPlayCountText&&this.endRepeatPlayCountText.draw(t),this.connectives.forEach(e=>e.draw(t)),this.layoutObjects.forEach(e=>e.musicObj.draw(t)),this.beamGroups.forEach(e=>e.draw(t))}},ae=(t=>(t[t.TabRhythm=0]="TabRhythm",t[t.Fermata=1]="Fermata",t[t.NoteLabel=2]="NoteLabel",t[t.Navigation=3]="Navigation",t[t.Ending=4]="Ending",t[t.TempoAnnotation=5]="TempoAnnotation",t[t.DynamicsAnnotation=6]="DynamicsAnnotation",t[t.ChordLabel=7]="ChordLabel",t[t.LyricsVerse1=8]="LyricsVerse1",t[t.LyricsVerse2=9]="LyricsVerse2",t[t.LyricsVerse3=10]="LyricsVerse3",t))(ae||{}),he=new o.b1([[0,{rowAlign:!0}],[1,{reserveSpace:!0}],[2,{reserveSpace:!0}],[3,{rowAlign:!0}],[4,{rowAlign:!0,padding:2}],[5,{rowAlign:!0,padding:2}],[6,{rowAlign:!0,padding:2}],[7,{reserveSpace:!0,rowAlign:!0}],[8,{reserveSpace:!0,rowAlign:!0}],[9,{reserveSpace:!0,rowAlign:!0}],[10,{reserveSpace:!0,rowAlign:!0}]]);var ce=class{constructor(t,e,i){this.groupName=t,this.staffsTabsAndGroups=e,this.verticalPosition=i}},ge=class{constructor(t,e,i,s){this.musicObj=t,this.line=e,this.layoutGroupId=i,this.verticalPos=s,(0,r.Mu)(this,"anchor"),(0,r.Mu)(this,"measure"),(0,r.Mu)(this,"row"),(0,r.Mu)(this,"layoutGroup"),(0,r.Mu)(this,"positionResolved",!0),this.measure=function(t){for(;t;){if(t instanceof re)return t;t=t.getParent()}throw new h.O1(h.mN.Score,"Parent measure is required but not found!")}(this.musicObj),this.row=this.measure.row;let n=this.musicObj.getParent();if(!n)throw new h.O1(h.mN.Score,"Parent music object is required as an anchor.");this.anchor=n,this.anchor.addAnchoredLayoutObject(this),this.layoutGroup=this.line.getLayoutGroup(i),this.layoutGroup.add(this)}resetPositionResolved(){this.positionResolved=!1}setPositionResolved(){this.positionResolved=!0}isPositionResolved(){return this.positionResolved}resolveClosestToStaffY(t){let{musicObj:e,measure:i,verticalPos:s,line:n}=this,r=n.getTopLineY(),a=n.getBottomLineY(),h=2*t.unitSize,c=1===s?a+h+e.getRect().toph:r-h-e.getRect().bottomh,g=i.getStaticObjects(n),u=e.getShapeRects();return g.forEach(t=>{let e=t.getShapeRects();u.forEach(t=>{e.forEach(e=>{o.vW.overlapX(t,e)&&(c=1===s?Math.max(c,e.bottom+t.toph+t.anchorY):Math.min(c,e.top-t.bottomh-t.anchorY))})})}),c}layout(t){this.line.addObject(this)}offset(t,e){this.musicObj.offset(t,e)}setAnchorY(t){this.musicObj.setAnchorY(t)}getRect(){return this.musicObj.getRect()}},ue=class{constructor(t){var e,i,s,n;this.layoutGroupId=t,(0,r.Mu)(this,"layoutObject",(0,o.Sl)(new o.qG)),(0,r.Mu)(this,"rowAlign"),(0,r.Mu)(this,"reserveSpace"),(0,r.Mu)(this,"padding"),this.rowAlign=!0===(null==(e=he.get(t))?void 0:e.rowAlign),this.reserveSpace=!0===(null==(i=he.get(t))?void 0:i.reserveSpace),this.padding=null!=(n=null==(s=he.get(t))?void 0:s.padding)?n:0}getLayoutObjects(t){return this.layoutObject.getAll(t)}add(t){this.layoutObject.add(t.verticalPos,t)}remove(t){this.layoutObject.remove(t.verticalPos,t)}layout(t){for(const e of this.layoutObject.values())e.resetPositionResolved(),e.musicObj.layout(t)}getPadding(t){return this.padding*t.unitSize}},le=class extends rt{constructor(t){super(t),this.row=t,(0,r.Mu)(this,"objects",[]),(0,r.Mu)(this,"layoutGroups",new o.b1)}getRowGroup(){return this.row.getRowGroupByLineId(this.id)}addObject(t){this.objects.push(t)}removeObjects(){this.objects.length=0}getLayoutGroup(t){return this.layoutGroups.getOrCreate(t,()=>new ue(t))}resetLayoutGroups(t){this.layoutGroups.forEach(e=>e.layout(t))}layoutLayoutGroups(t){for(const e of o.OZ.Enum.getEnumValues(ae)){const i=this.getLayoutGroup(e);i&&(this.layoutLayoutGroup(t,i,0),this.layoutLayoutGroup(t,i,1))}}setObjectY(t,e){void 0!==e&&(t.setAnchorY(e-t.getRect().anchorY),t.setPositionResolved())}alignObjectsY(t,e,i){const s=e.filter(t=>!t.isPositionResolved()&&t.verticalPos===i);if(0===s.length)return;const n=1===i?1:-1;let o=s.map(e=>e.resolveClosestToStaffY(t)+e.layoutGroup.getPadding(t)*n);const r=1===i?Math.max(...o):Math.min(...o);s.forEach(t=>this.setObjectY(t,r))}layoutLayoutGroup(t,e,i){let s=e.getLayoutObjects(i).filter(t=>!t.isPositionResolved());s.forEach(e=>{let{musicObj:i,anchor:s}=e;i instanceof Xt||i instanceof te||i instanceof ne?i.layoutFitToMeasure(t):i.setAnchorX(s.getRect().anchorX)}),e.rowAlign?this.alignObjectsY(t,s,i):s.forEach(e=>{let n=e.musicObj.getLink();if(n&&n.getHead()===e.musicObj){let e=[n.getHead(),...n.getTails()],o=s.filter(t=>e.some(e=>e===t.musicObj));this.alignObjectsY(t,o,i)}else this.alignObjectsY(t,[e],i)})}drawVerticalLine(t,e,i,s=!1){t.color("tab"===this.getConfig().type?P.Tab_Frame:P.Staff_Frame);const n=this.row.getNotationLines().indexOf(this),o=n>=0?this.row.getNotationLines()[n+1]:void 0,r=this.getRowGroup().lines.length>1,a=this instanceof de&&this.isGrandTreble(),h=this.getTopLineY(),c=o&&(s||r||a)?o.getTopLineY():this.getBottomLineY();t.fillRect(e,h,i,c-h)}},de=class extends le{constructor(t,e,i){super(t),this.staffConfig=e,this.id=i,(0,r.Mu)(this,"clefImageAsset"),(0,r.Mu)(this,"clefLineDiatonicId"),(0,r.Mu)(this,"topLineDiatonicId"),(0,r.Mu)(this,"middleLineDiatonicId"),(0,r.Mu)(this,"bottomLineDiatonicId"),(0,r.Mu)(this,"minDiatonicId"),(0,r.Mu)(this,"maxDiatonicId"),(0,r.Mu)(this,"joinedGrandStaff"),(0,r.Mu)(this,"topLineY",0),(0,r.Mu)(this,"bottomLineY",0),(0,r.Mu)(this,"mi");const s=(t,e)=>a.L7.getNote(t).diatonicId-(e?7:0);if("G"===e.clef)this.clefImageAsset=0,this.clefLineDiatonicId=s("G4",!0===e.isOctaveDown),this.middleLineDiatonicId=this.clefLineDiatonicId+2;else{if("F"!==e.clef)throw new h.O1(h.mN.Score,`Invalid staffConfig.clef ${e.clef}.`);this.clefImageAsset=1,this.clefLineDiatonicId=s("F3",!0===e.isOctaveDown),this.middleLineDiatonicId=this.clefLineDiatonicId-2}this.topLineDiatonicId=this.middleLineDiatonicId+4,this.bottomLineDiatonicId=this.middleLineDiatonicId-4,this.minDiatonicId=void 0!==e.minNote?Math.min(s(e.minNote,!1),this.bottomLineDiatonicId):void 0,this.maxDiatonicId=void 0!==e.maxNote?Math.max(s(e.maxNote,!1),this.topLineDiatonicId):void 0,this.mi=new Ni(this)}getMusicInterface(){return this.mi}get isOctaveDown(){return!0===this.staffConfig.isOctaveDown}get name(){var t;return null!=(t=this.staffConfig.name)?t:""}getConfig(){return this.staffConfig}getTopLineY(){return this.topLineY}getMiddleLineY(){return(this.topLineY+this.bottomLineY)/2}getBottomLineY(){return this.bottomLineY}joinGrandStaff(t){t!==this&&(this.joinedGrandStaff=t)}isGrandTreble(){return void 0!==this.joinedGrandStaff&&"G"===this.staffConfig.clef}isGrandBass(){return void 0!==this.joinedGrandStaff&&"F"===this.staffConfig.clef}getLineSpacing(){return(this.bottomLineY-this.topLineY)/4}getDiatonicSpacing(){return this.getLineSpacing()/2}containsDiatonicId(t){return a.L7.validateDiatonicId(t),(void 0===this.minDiatonicId||t>=this.minDiatonicId)&&(void 0===this.maxDiatonicId||t<=this.maxDiatonicId)}getDiatonicIdY(t){if(this.containsDiatonicId(t))return this.bottomLineY+(this.bottomLineDiatonicId-t)*this.getDiatonicSpacing();if(this.joinedGrandStaff&&this.joinedGrandStaff.containsDiatonicId(t))return this.joinedGrandStaff.getDiatonicIdY(t);throw new h.O1(h.mN.Score,"Staff does not contain diatonicId "+t)}getActualStaff(t){if(this.containsDiatonicId(t))return this;if(this.joinedGrandStaff&&this.joinedGrandStaff.containsDiatonicId(t))return this.joinedGrandStaff;throw new h.O1(h.mN.Score,"Staff does not contain diatonicId "+t)}getDiatonicIdAt(t){let e=Math.round(this.bottomLineDiatonicId-(t-this.bottomLineY)/this.getDiatonicSpacing());return this.containsDiatonicId(e)?e:void 0}isLine(t){return t%2==this.middleLineDiatonicId%2}isSpace(t){return t%2!=this.middleLineDiatonicId%2}containsVoiceId(t){return o.I8.isUndefined(this.staffConfig.voiceId)||o.OZ.Arr.toArray(this.staffConfig.voiceId).includes(t)}calcTop(){let t=this.topLineY;if(this.objects.forEach(e=>t=Math.min(t,e.getRect().top)),void 0!==this.maxDiatonicId){let e=this.getDiatonicIdY(this.maxDiatonicId),i=this.getDiatonicIdY(this.maxDiatonicId-1);t=Math.min(t,e-Math.abs(i-e)+1)}return t}calcBottom(){let t=this.bottomLineY;if(this.objects.forEach(e=>t=Math.max(t,e.getRect().bottom)),void 0!==this.minDiatonicId){let e=this.getDiatonicIdY(this.minDiatonicId),i=this.getDiatonicIdY(this.minDiatonicId+1);t=Math.max(t,e+Math.abs(i-e)-1)}return t}pick(t,e){return this.getRect().contains(t,e)?[this]:[]}layoutHeight(t){let{unitSize:e}=t,i=e*j;this.topLineY=-i/2,this.bottomLineY=i/2,this.rect=new o.vW(0,0,this.topLineY,this.bottomLineY)}layoutWidth(t){this.rect.left=this.row.getRect().left,this.rect.right=this.row.getRect().right}offset(t,e){this.topLineY+=e,this.bottomLineY+=e,this.objects.forEach(t=>{t.offsetInPlace?t.offsetInPlace(0,e):t.offset&&t.offset(0,e)}),this.rect.offsetInPlace(t,e)}draw(t){}},fe=class extends le{constructor(t,e,i){super(t),this.tabConfig=e,this.id=i,(0,r.Mu)(this,"top",0),(0,r.Mu)(this,"bottom",0),(0,r.Mu)(this,"tuningName"),(0,r.Mu)(this,"tuningStrings"),(0,r.Mu)(this,"mi"),o.I8.isArray(e.tuning)?(this.tuningName=void 0,this.tuningStrings=e.tuning.map(t=>a.L7.getNote(t)).reverse()):"string"==typeof e.tuning?(this.tuningName=(0,a.XH)(e.tuning),this.tuningStrings=(0,a.eg)(this.tuningName)):(this.tuningName="Standard",this.tuningStrings=(0,a.eg)(this.tuningName)),this.mi=new ji(this)}getMusicInterface(){return this.mi}get name(){var t;return null!=(t=this.tabConfig.name)?t:""}getConfig(){return this.tabConfig}getTuningName(){return this.tuningName}getTuningStrings(){return this.tuningStrings}getStringY(t){return this.top+(this.bottom-this.top)/6*(t+.5)}getTopStringY(){return this.getStringY(0)}getBottomStringY(){return this.getStringY(5)}getTopLineY(){return this.getTopStringY()}getBottomLineY(){return this.getBottomStringY()}getTop(){return this.top}getBottom(){return this.bottom}containsVoiceId(t){return o.I8.isUndefined(this.tabConfig.voiceId)||o.OZ.Arr.toArray(this.tabConfig.voiceId).includes(t)}containsDiatonicId(t){return!0}calcTop(){let{top:t}=this;return this.objects.forEach(e=>t=Math.min(t,e.getRect().top)),t}calcBottom(){let{bottom:t}=this;return this.objects.forEach(e=>t=Math.max(t,e.getRect().bottom)),t}pick(t,e){return this.getRect().contains(t,e)?[this]:[]}layoutHeight(t){let{unitSize:e}=t,i=e*k;this.top=-i/2,this.bottom=i/2,this.rect=new o.vW(0,0,this.top,this.bottom)}layoutWidth(t){this.rect.left=this.row.getRect().left,this.rect.right=this.row.getRect().right}offset(t,e){this.top+=e,this.bottom+=e,this.objects.forEach(t=>{t.offsetInPlace?t.offsetInPlace(0,e):t.offset&&t.offset(0,e)}),this.rect.offsetInPlace(t,e)}draw(t){}};var Ie=class extends rt{constructor(t){var e;super(t[0].row),this.lines=t,(0,r.Mu)(this,"space",0),(0,r.Mu)(this,"instrument"),(0,r.Mu)(this,"hasBrace"),(0,r.Mu)(this,"instrText"),(0,r.Mu)(this,"braceRect",new o.vW),(0,r.Mu)(this,"mi");const i=P.RowGroup_Instrument,s=function(t){return{instrName:(t.startsWith("!{")?t.substring(2):t.startsWith("!")?t.substring(1):t).trim(),hideInstr:t.startsWith("!"),hideBrace:t.startsWith("!{")}}(null!=(e=t[0].getConfig().instrument)?e:"");this.instrument=s.instrName,this.hasBrace=!s.hideBrace&&(this.hasInstrument&&t.length>=2);const n=s.hideInstr?"":this.instrument;this.instrText=new At(this,{text:n,color:i,scale:1},1,.5),this.mi=new Li(this)}getMusicInterface(){return this.mi}get row(){return this.lines[0].row}get hasInstrument(){return this.instrument.length>0}hasNotationLine(t){return this.lines.includes(t)}pick(t,e){if(!this.getRect().contains(t,e))return[];let i=this.instrText.pick(t,e);return i.length>0?[this,...i]:[this]}updateRect(){this.instrText.setRight(this.braceRect.left-this.space),this.instrText.setCenterY(this.braceRect.anchorY),this.rect=this.instrText.getRect().clone().expandInPlace(this.braceRect)}layout(t){this.space=t.unitSize,this.instrText.layout(t),this.braceRect=new o.vW(-(this.hasBrace?5*t.unitSize:0),0,0,0),this.forceRectUpdate()}layoutToNotationLines(){this.braceRect.top=this.lines[0].getTopLineY(),this.braceRect.bottom=this.lines[this.lines.length-1].getBottomLineY(),this.braceRect.anchorY=this.braceRect.centerY,this.forceRectUpdate()}offset(t,e){this.instrText.offset(t,e),this.braceRect.offsetInPlace(t,e),this.rect.offsetInPlace(t,e)}draw(t){if(this.instrText.draw(t),this.hasBrace){const e=this.braceRect;t.color(P.RowGroup_Frame).lineWidth(1).drawBracket(e,"{")}}},me=class{constructor(){(0,r.Mu)(this,"instrWidth",0),(0,r.Mu)(this,"staffWidth",0)}resetWidths(){this.instrWidth=this.staffWidth=0}addRowInstrWidth(t){this.instrWidth=Math.max(this.instrWidth,t)}addRowstaffWidth(t){this.staffWidth=Math.max(this.staffWidth,t)}get instrLeft(){return 0}get instrRight(){return this.instrWidth}get staffLeft(){return this.instrRight}get staffRight(){return this.staffLeft+this.staffWidth}get left(){return this.instrLeft}get right(){return this.staffRight}get width(){return this.instrWidth+this.staffWidth}},Ce=class extends rt{constructor(t,e,i){super(t),this.doc=t,this.prevRow=e,this.scoreConfig=i,(0,r.Mu)(this,"nextRow"),(0,r.Mu)(this,"notationLines"),(0,r.Mu)(this,"rowGroups"),(0,r.Mu)(this,"staves"),(0,r.Mu)(this,"tabs"),(0,r.Mu)(this,"measures",[]),(0,r.Mu)(this,"rowGroupByLine"),(0,r.Mu)(this,"needLayout",!0),(0,r.Mu)(this,"mi"),this.notationLines=this.createNotationLines(),this.staves=this.notationLines.filter(t=>t instanceof de),this.tabs=this.notationLines.filter(t=>t instanceof fe);let s=[];for(let n=0;n<this.notationLines.length;n++){let t=this.notationLines[n],e=s[s.length-1];void 0===e||void 0===e[0].getConfig().instrument||e[0].getConfig().instrument!==t.getConfig().instrument?s.push([t]):e.push(t)}this.rowGroups=s.filter(t=>t.length>0).map(t=>new Ie(t)),this.rowGroupByLine=this.notationLines.map(t=>this.rowGroups.find(e=>e.lines.includes(t))),this.prevRow&&(this.prevRow.nextRow=this),this.mi=new Ri(this)}getMusicInterface(){return this.mi}createNotationLines(){let t=this.scoreConfig.map((t,e)=>"staff"===t.type?new de(this,t,e):new fe(this,t,e));for(let e=0;e<t.length-1;e++){let i=t[e],s=t[e+1];i instanceof de&&s instanceof de&&void 0!==i.staffConfig.grandId&&i.staffConfig.grandId===s.staffConfig.grandId&&(i.joinGrandStaff(s),s.joinGrandStaff(i))}return t}getNotationLines(){return this.notationLines}getRowGroups(){return this.rowGroups}getRowGroupByLineId(t){return this.rowGroupByLine[t]}findMatchingLine(t){return t.row===this?t:this.notationLines.find(e=>o.OZ.Obj.deepEqual(t.row.scoreConfig,e.row.scoreConfig)&&t.id===e.id||o.I8.isNonEmptyString(t.getConfig().name)&&t.getConfig().name===e.getConfig().name&&t.getConfig().type===e.getConfig().type)}get regions(){return this.doc.regions}getStaves(){return this.staves}getTabs(){return this.tabs}get hasStaff(){return this.staves.length>0}get hasTab(){return this.tabs.length>0}getTopStaff(){let t=this.staves[0];if(t)return t;throw new h.O1(h.mN.Score,"Top staff is required!")}getBottomStaff(){let t=this.staves[this.staves.length-1];if(t)return t;throw new h.O1(h.mN.Score,"Bottom staff is required!")}getStaff(t){a.L7.validateDiatonicId(t);for(let e=0;e<this.notationLines.length;e++){let i=this.notationLines[e];if(i instanceof de&&i.containsDiatonicId(t))return i}}resetLayoutGroups(t){this.notationLines.forEach(e=>e.resetLayoutGroups(t))}layoutLayoutGroups(t){this.notationLines.forEach(e=>e.layoutLayoutGroups(t))}pick(t,e){if(!this.getRect().contains(t,e))return[];for(let i=0;i<this.measures.length;i++){let s=this.measures[i].pick(t,e);if(s.length>0)return[this,...s]}for(let i=0;i<this.rowGroups.length;i++){let s=this.rowGroups[i].pick(t,e);if(s.length>0)return[this,...s]}for(let i=0;i<this.notationLines.length;i++){let s=this.notationLines[i].pick(t,e);if(s.length>0)return[this,...s]}return[this]}getConnectivesContentRect(){let t=this.getRect(),e=this.getFirstMeasure(),i=e?e.getColumnsContentRect().left:t.left;return new o.vW(i,(i+t.right)/2,t.right,t.top,t.anchorY,t.bottom)}getDiatonicIdAt(t){for(let e=0;e<this.notationLines.length;e++){let i=this.notationLines[e],s=i instanceof de?i.getDiatonicIdAt(t):void 0;if(void 0!==s)return s}}addMeasure(t){this.measures.push(t)}getMeasures(){return this.measures}isFirstRow(){return this===this.doc.getFirstRow()}isLastRow(){return this===this.doc.getLastRow()}getPrevRow(){return this.prevRow}getNextRow(){return this.nextRow}getFirstMeasure(){return this.measures.length>0?this.measures[0]:void 0}getLastMeasure(){return this.measures.length>0?this.measures[this.measures.length-1]:void 0}solveAutoStemDir(t){if(0===t.length)return"up";{let e=t[0].voiceId,i=t.filter(t=>t instanceof Lt).map(t=>t.setDiatonicId),s=t.filter(t=>t instanceof St&&t.setDiatonicId!==St.UndefinedDiatonicId).map(t=>t.setDiatonicId);if(0===i.length&&0===s.length)return"up";let n=i.length>0?i:s,r=Math.floor(o.OZ.Math.avg(...n)),a=this.getStaves().filter(t=>t.containsVoiceId(e)&&t.containsDiatonicId(r));return a.length>0&&r>=a[0].middleLineDiatonicId?"down":"up"}}requestLayout(){this.needLayout||(this.needLayout=!0,this.doc.requestLayout())}layout(t){if(!this.needLayout)return;this.requestRectUpdate(),this.notationLines.forEach(e=>{e.removeObjects(),e.layoutHeight(t)}),this.rowGroups.forEach(e=>{e.layout(t),this.regions.addRowInstrWidth(e.getRect().width)}),this.measures.forEach(e=>e.layout(t));let e=this.measures.map(t=>t.getMinWidth()+t.getPostMeasureBreakWidth()).reduce((t,e)=>t+e);this.regions.addRowstaffWidth(e)}layoutStretch(t){if(!this.needLayout)return;this.rect=new o.vW(this.regions.left,this.regions.right,0,0),this.notationLines.forEach(e=>e.layoutWidth(t)),this.rowGroups.forEach(t=>t.setRight(this.regions.instrRight));let e=this.regions.staffWidth,i=0;this.measures.forEach(t=>{e-=t.getTotalSolidWidth()+t.getPostMeasureBreakWidth(),i+=t.getMinColumnsWidth()});let s=e/i,n=this.regions.staffLeft;this.measures.forEach(e=>{let i=e.getTotalSolidWidth()+e.getMinColumnsWidth()*s;e.layoutWidth(t,i);let o=e.getRect();e.setLeft(n),e.setAnchorY(0),n+=o.width,n+=e.getPostMeasureBreakWidth()}),this.measures.forEach(e=>{e.layoutConnectives(t),e.layoutBeams(t)})}updateRect(){var t;let e=this.regions.left,i=this.regions.right,s=0,n=0;const r=null==(t=this.getLastMeasure())?void 0:t.getBarLineRight().getAnchoredLayoutObjects().map(t=>t.musicObj).find(t=>t instanceof _t);r&&(i=Math.max(i,r.getRect().right)),this.measures.length>0&&(s=Math.min(...this.measures.map(t=>t.getRect().top)),n=Math.max(...this.measures.map(t=>t.getRect().bottom))),this.rect=new o.vW(e,i,s,n)}alignStemsToBeams(){this.measures.forEach(t=>t.alignStemsToBeams())}layoutSetNotationLines(t){let{unitSize:e}=t;for(let i=1;i<this.notationLines.length;i++){let t=this.notationLines[i-1],s=this.notationLines[i];if(t instanceof de&&s instanceof de&&void 0!==t.staffConfig.grandId&&t.staffConfig.grandId===s.staffConfig.grandId){let i=t.getBottomLineY()-s.getTopLineY()+6*e;s.offsetY(i)}else{let i=t.calcBottom()-s.calcTop()+3*e;s.offsetY(i)}}this.measures.forEach(t=>{t.requestRectUpdate(),t.getBarLineLeft().requestRectUpdate(),t.getBarLineRight().requestRectUpdate(),t.getColumns().forEach(t=>{t.requestRectUpdate(),[0,1,2,3].forEach(e=>{var i;return null==(i=t.getVoiceSymbol(e))?void 0:i.requestRectUpdate()})})}),this.rowGroups.forEach(t=>t.layoutToNotationLines()),this.alignStemsToBeams(),this.requestRectUpdate()}layoutDone(){this.measures.forEach(t=>t.layoutDone()),this.needLayout=!1}offset(t,e){this.measures.forEach(i=>i.offset(t,e)),this.rect.offsetInPlace(t,e),this.notationLines.forEach(i=>i.offset(t,e)),this.rowGroups.forEach(i=>i.offset(t,e))}getStaffLineLeft(){var t;return null==(t=this.getFirstMeasure())?void 0:t.getStaffLineLeft()}draw(t){t.drawDebugRect(this.getRect());const{left:e,top:i,width:s,height:n}=this.getRect(),o=t._lineWidth;t.save(),t.rect(e-o,i,s+2*o,n),t.clip(),this.measures.forEach(e=>e.draw(t)),this.notationLines.forEach(e=>e.draw(t));const r=this.getStaffLineLeft();void 0!==r&&this.notationLines.length>1&&this.notationLines.forEach(e=>e.drawVerticalLine(t,r,t._lineWidth,!0)),this.rowGroups.forEach(e=>e.draw(t)),t.restore()}},pe=class extends rt{constructor(t,e,i,s){super(t),this.doc=t,this.title=e,this.composer=i,this.arranger=s,(0,r.Mu)(this,"titleText"),(0,r.Mu)(this,"composerText"),(0,r.Mu)(this,"arrangerText"),(0,r.Mu)(this,"mi"),this.mi=new ii(this);const n=P.Header_Title,o=P.Header_Composer,a=P.Header_Arranger;this.titleText=this.title?new At(this,{text:this.title,color:n,scale:2},.5,0):void 0,this.composerText=this.composer?new At(this,{text:this.composer,color:o},1,0):void 0,this.arrangerText=this.arranger?new At(this,{text:"Arr.: "+this.arranger,color:a},1,0):void 0}getMusicInterface(){return this.mi}pick(t,e){if(!this.rect.contains(t,e))return[];if(this.titleText){let i=this.titleText.pick(t,e);if(i)return[this,...i]}if(this.composerText){let i=this.composerText.pick(t,e);if(i)return[this,...i]}if(this.arrangerText){let i=this.arrangerText.pick(t,e);if(i)return[this,...i]}return[this]}layout(t){let e=0;const i=this.doc.regions.staffLeft,s=this.doc.regions.staffRight;this.rect=new o.vW(i,s,0,0),this.titleText&&(this.titleText.layout(t),this.titleText.setCenterX((i+s)/2),this.titleText.setTop(e),e+=this.titleText.getRect().height,this.rect.expandInPlace(this.titleText.getRect())),this.composerText&&(this.composerText.layout(t),this.composerText.setRight(s),this.composerText.setTop(e),e+=this.composerText.getRect().height,this.rect.expandInPlace(this.composerText.getRect())),this.arrangerText&&(this.arrangerText.layout(t),this.arrangerText.setRight(s),this.arrangerText.setTop(e),e+=this.arrangerText.getRect().height,this.rect.expandInPlace(this.arrangerText.getRect()))}offset(t,e){this.titleText&&this.titleText.offset(t,e),this.composerText&&this.composerText.offset(t,e),this.arrangerText&&this.arrangerText.offset(t,e),this.rect.offsetInPlace(t,e)}draw(t){this.titleText&&this.titleText.draw(t),this.composerText&&this.composerText.draw(t),this.arrangerText&&this.arrangerText.draw(t)}},Ae=class extends rt{constructor(){super(void 0),(0,r.Mu)(this,"needLayout",!0),(0,r.Mu)(this,"ctx"),(0,r.Mu)(this,"regions",new me),(0,r.Mu)(this,"rows",[]),(0,r.Mu)(this,"measures",[]),(0,r.Mu)(this,"measuresPerRow",1/0),(0,r.Mu)(this,"curScoreConfig",[{type:"staff",clef:"G"}]),(0,r.Mu)(this,"header"),(0,r.Mu)(this,"newRowRequested",!1),(0,r.Mu)(this,"allConnectiveProps",[]),(0,r.Mu)(this,"staffGroups",new o.b1),(0,r.Mu)(this,"mi"),this.mi=new Ke(this)}getMusicInterface(){return this.mi}setScoreConfiguration(t){if(o.I8.isEnumValue(t,E))switch(t){default:case"treble":this.curScoreConfig=[{type:"staff",clef:"G"}];break;case"bass":this.curScoreConfig=[{type:"staff",clef:"F"}];break;case"grand":this.curScoreConfig=[{type:"staff",clef:"G",grandId:"grand1"},{type:"staff",clef:"F",grandId:"grand1"}];break;case"guitarTreble":this.curScoreConfig=[{type:"staff",clef:"G",isOctaveDown:!0}];break;case"guitarTab":this.curScoreConfig=[{type:"tab",tuning:"Standard"}];break;case"guitarCombined":this.curScoreConfig=[{type:"staff",clef:"G",isOctaveDown:!0},{type:"tab",tuning:"Standard"}]}else o.I8.isArray(t)?this.curScoreConfig=t:this.curScoreConfig=[t];for(let e=0,i=[];e<this.curScoreConfig.length;){let t=this.curScoreConfig[e],s=this.curScoreConfig[e+1];if(t&&s&&"staff"===t.type&&"staff"===s.type&&void 0!==t.grandId&&t.grandId===s.grandId){if(i.includes(t.grandId))throw new h.O1(h.mN.Score,`Grand staff error: grandId "${t.grandId}" already used!`);if("G"!==t.clef)throw new h.O1(h.mN.Score,`Grand staff error: Invalid treble clef "${t.clef}"!`);if("F"!==s.clef)throw new h.O1(h.mN.Score,`Grand staff error: Invalid treble clef "${t.clef}"!`);if(t.isOctaveDown||s.isOctaveDown)throw new h.O1(h.mN.Score,"Grand staff error: cannot use isOctaveDown option!");i.push(t.grandId),t.minNote="C4",s.maxNote="B3",e+=2}else{if(t&&"staff"===t.type&&void 0!==t.grandId)throw new h.O1(h.mN.Score,`Grand staff error: invalid use of grandId "${t.grandId}"!`);e++}}this.requestNewRow()}setMeasuresPerRow(t){this.measuresPerRow=t}addConnectiveProps(t){this.allConnectiveProps.push(t)}setRenderContext(t){if(this.ctx===t)return;let e=this.ctx;this.ctx=t,e&&e.setDocument(void 0),t&&t.setDocument(this.mi),this.requestFullLayout()}setHeader(t,e,i){this.header=new pe(this,t,e,i),this.requestLayout()}getTitle(){var t;return null==(t=this.header)?void 0:t.title}getComposer(){var t;return null==(t=this.header)?void 0:t.composer}getArranger(){var t;return null==(t=this.header)?void 0:t.arranger}hasSingleMeasure(){return 1===this.measures.length}getFirstMeasure(){return this.measures.length>0?this.measures[0]:void 0}getLastMeasure(){return this.measures.length>0?this.measures[this.measures.length-1]:void 0}addNewRow(t){let e=new Ce(this,t,this.curScoreConfig);return this.rows.push(e),e}getFirstRow(){return 0===this.rows.length?this.addNewRow(void 0):this.rows[0]}getLastRow(){return 0===this.rows.length?this.addNewRow(void 0):this.rows[this.rows.length-1]}getRows(){return this.rows}getMeasures(){return this.measures}requestNewRow(){this.newRowRequested=!0}addMeasure(t){let e=this.rows[this.rows.length-1];(!e||this.newRowRequested&&e.getMeasures().length>0||e.getMeasures().length>=this.measuresPerRow)&&(e=this.addNewRow(e),this.newRowRequested=!1);let i=new re(e,t);return this.measures.push(i),e.addMeasure(i),this.requestLayout(),i}addStaffGroup(t,e,i){this.staffGroups.set(t,new ce(t,e,i))}getStaffGroup(t){return this.staffGroups.get(t)}getVoiceSymbols(t){let e=[];return this.forEachMeasure(i=>e=e.concat(i.getVoiceSymbols(t))),e}removeLayoutObjects(t){this.forEachMeasure(e=>e.removeLayoutObjects(t))}forEachMeasure(t){let e=this.getFirstMeasure();for(;e;)t(e),e=e.getNextMeasure()}resetMeasures(){this.measures.forEach(t=>t.resetPassCount())}updateCursorRect(t){this.ctx&&this.ctx.updateCursorRect(t)}requestLayout(){this.needLayout=!0}requestFullLayout(){this.rows.forEach(t=>t.requestLayout()),this.forEachMeasure(t=>{t.getColumns().forEach(t=>t.requestLayout()),t.requestLayout()}),this.requestLayout()}layout(){var t;if(!this.needLayout)return;const{ctx:e}=this;if(!e)return;let{unitSize:i}=e;this.forEachMeasure(t=>t.createBeams()),null==(t=this.getFirstMeasure())||t.updateRunningArguments(),this.forEachMeasure(t=>t.createExtensions()),this.allConnectiveProps.forEach(t=>t.removeConnectives()),this.allConnectiveProps.forEach(t=>t.createConnectives()),this.rows.forEach(t=>t.resetLayoutGroups(e)),this.regions.resetWidths(),this.regions.addRowstaffWidth(l*i),this.rows.forEach(t=>t.layout(e)),this.rows.forEach(t=>t.layoutStretch(e)),this.rows.forEach(t=>t.layoutLayoutGroups(e)),this.rows.forEach(t=>t.layoutSetNotationLines(e)),this.rect=new o.vW,this.header&&(this.header.layout(e),this.rect.expandInPlace(this.header.getRect())),this.rows.forEach(t=>{t.setLeft(0),t.setTop(this.rect.bottom+2*i),this.rect.expandInPlace(t.getRect())}),this.rows.forEach(t=>t.layoutDone()),this.needLayout=!1}offset(t,e){}drawContent(){const{ctx:t}=this;t&&(this.rows.forEach(e=>e.draw(t)),this.header&&this.header.draw(t))}pickStaffPosAt(t,e){if(this.rect.contains(t,e))for(let i=0;i<this.rows.length;i++){let s=this.rows[i];if(!s.hasStaff)continue;if(!s.getRect().contains(t,e))continue;let n=s.getDiatonicIdAt(e);if(void 0!==n)return{scoreRow:s,diatonicId:n}}}pick(t,e){if(!this.rect.contains(t,e))return[];if(this.header){let i=this.header.pick(t,e);if(i.length>0)return[this,...i]}for(let i=0;i<this.rows.length;i++){let s=this.rows[i].pick(t,e);if(s.length>0)return[this,...s]}return[this]}},be="";function ye(t,...e){let i=e.map(t=>JSON.stringify(t)).join(", ");be=`DocumentBuilder.${t}(${i})`}function ve(...t){t.forEach(t=>{if(!t)throw new h.O1(h.mN.Score,be)})}function we(t,e){if(!t)throw new h.O1(h.mN.Score,e)}function Me(t,e,i){we(!o.I8.isTypedObject(t,[e]),i)}function Se(t){ve(o.I8.isObject(t),o.I8.isStringOrUndefined(t.name),o.I8.isUndefined(t.voiceId)||G(t.voiceId)||o.I8.isArray(t.voiceId)&&t.voiceId.every(t=>G(t))),Me(t,"voiceIds","Baseconfig.voiceIds was removed. Use BaseConfig.voiceId instead."),o.I8.isArray(t.voiceId)&&(t.voiceId=o.OZ.Arr.removeDuplicates(t.voiceId)),ve(o.I8.isStringOrUndefined(t.instrument))}function Re(t){Se(t),ve(o.I8.isObject(t),o.I8.isStrictEqual(t.type,"staff"),o.I8.isEnumValue(t.clef,D),o.I8.isBooleanOrUndefined(t.isOctaveDown),o.I8.isUndefined(t.minNote)||a.L7.isNote(t.minNote),o.I8.isUndefined(t.maxNote)||a.L7.isNote(t.maxNote),o.I8.isStringOrUndefined(t.grandId)),Me(t,"isGrand","StaffConfig.isGrand was removed. Use StaffConfig.grandId instead.")}function xe(t){Se(t),ve(o.I8.isObject(t),o.I8.isStrictEqual(t.type,"tab"),o.I8.isUndefined(t.tuning)||o.I8.isString(t.tuning)&&o.I8.isIncluded(t.tuning,a.fW)||o.I8.isArray(t.tuning)&&o.I8.isStrictEqual(t.tuning.length,t.tuning.every(t=>a.L7.isNote(t))))}function Le(t){ve(o.I8.isObject(t),o.I8.isEnumValueOrUndefined(t.stem,V),o.I8.isStringOrUndefined(t.color),o.I8.isBooleanOrUndefined(t.arpeggio)||o.I8.isEnumValue(t.arpeggio,H),o.I8.isBooleanOrUndefined(t.staccato),o.I8.isBooleanOrUndefined(t.diamond),o.I8.isUndefined(t.string)||Y(t.string)||o.I8.isEmptyArray(t.string)||o.I8.isNonEmptyArray(t.string)&&t.string.every(t=>Y(t))),Me(t,"dotted","NoteOptions.dotted was removed."),Me(t,"triplet","NoteOptions.triplet was removed."),Me(t,"tieSpan",'NoteOptions.tieSpan was removed. Use addConnective("tie", tieSpan)'),Me(t,"slurSpan",'NoteOptions.slurSpan was removed. Use addConnective("slur", slurSpan)')}function Te(t){ve(o.I8.isObject(t),o.I8.isStringOrUndefined(t.staffPos)||o.I8.isInteger(t.staffPos)||t.staffPos instanceof a.L7,o.I8.isStringOrUndefined(t.color),o.I8.isBooleanOrUndefined(t.hide)),Me(t,"dotted","RestOptions.dotted was removed."),Me(t,"triplet","RestOptions.triplet was removed.")}function Ne(t){ve(o.I8.isStringOrUndefined(t)||o.I8.isIntegerGte(t,0)||o.I8.isNonEmptyArray(t)&&t.every(t=>o.I8.isString(t)||o.I8.isIntegerGte(t,0)))}var Oe=class t{constructor(){(0,r.Mu)(this,"doc"),(0,r.Mu)(this,"currentLyricsAlign","center"),this.doc=new Ae}setScoreConfiguration(t){return ye("setScoreConfiguration",t),o.I8.isEnumValue(t,E)?this.doc.setScoreConfiguration(t):o.I8.isObject(t)&&"staff"===t.type?(Re(t),this.doc.setScoreConfiguration(t)):o.I8.isObject(t)&&"tab"===t.type?(xe(t),this.doc.setScoreConfiguration(t)):o.I8.isNonEmptyArray(t)?(t.forEach(t=>{o.I8.isObject(t)&&"staff"===t.type?Re(t):o.I8.isObject(t)&&"tab"===t.type?xe(t):ve(!1)}),this.doc.setScoreConfiguration(t)):ve(!1),this}getMeasure(){var e;return null!=(e=this.doc.getLastMeasure())?e:this.doc.addMeasure(t.DefaultMeasureOptions)}getDocument(){return this.getMeasure(),this.doc.getMusicInterface()}setHeader(t,e,i){return ye("setHeader",t,e,i),ve(o.I8.isStringOrUndefined(t),o.I8.isStringOrUndefined(e),o.I8.isStringOrUndefined(i)),this.doc.setHeader(t,e,i),this}setMeasuresPerRow(t){return ye("setMeasuresPerRow",t),ve(o.I8.isIntegerGte(t,1)||o.I8.isPosInfinity(t)),this.doc.setMeasuresPerRow(t),this}addMeasure(t){return ye("addMeasure",t),null!=t||(t={}),function(t){ve(o.I8.isObject(t),o.I8.isBooleanOrUndefined(t.showNumber))}(t),this.doc.addMeasure(t),this}setKeySignature(...t){return ye("setKeySignature",...t),ve(t[0]instanceof a.FE||t[0]instanceof a.u9||o.I8.isNonEmptyString(t[0])&&o.I8.isEnumValueOrUndefined(t[1],a.bF)),this.getMeasure().setKeySignature(...t),this}setTimeSignature(...t){return ye("setTimeSignature",...t),t[0]instanceof a.m9?this.getMeasure().setTimeSignature(t[0]):o.I8.isEnumValue(t[0],a.RN)&&o.I8.isEnumValueOrUndefined(t[1],a.Nl)?this.getMeasure().setTimeSignature(new a.m9(t[0],t[1])):o.I8.isIntegerGte(t[0],1)&&o.I8.isIntegerGte(t[1],1)&&o.I8.isEnumValueOrUndefined(t[2],a.Nl)?this.getMeasure().setTimeSignature(new a.m9(t[0],t[1],t[2])):ve(!1),this}setTempo(t,e){return ye("setTempo",t,e),ve(o.I8.isIntegerGte(t,1),o.I8.isUndefined(e)||(0,a.DF)(e)),this.getMeasure().setTempo(t,e),this}addNote(t,e,i,s){if(ye("addNote",t,e,i,s),ve(G(t),e instanceof a.L7||o.I8.isNonEmptyString(e)||o.I8.isArray(e)&&e.every(t=>t instanceof a.L7||o.I8.isNonEmptyString(t)),(0,a.DF)(i)),null!=s||(s={}),Le(s),o.I8.isArray(e)){let n=s.string;e.forEach((e,r)=>{s.string=o.I8.isArray(n)?n[r]:n,this.getMeasure().addNoteGroup(t,[e],i,s)})}else this.getMeasure().addNoteGroup(t,[e],i,s);return this}addChord(t,e,i,s){return ye("addChord",t,e,i,s),ve(G(t),o.I8.isNonEmptyArray(e)&&e.every(t=>t instanceof a.L7||o.I8.isNonEmptyString(t)),(0,a.DF)(i)),null!=s||(s={}),Le(s),this.getMeasure().addNoteGroup(t,e,i,s),this}addRest(t,e,i){return ye("addRest",t,e,i),ve(G(t),(0,a.DF)(e)),null!=i||(i={}),Te(i),this.getMeasure().addRest(t,e,i),this}addTuplet(t,e,i){ye("addTuplet",t,e),ve(G(t),o.I8.isFunction(i),(0,a.q9)(e)&&o.I8.isBooleanOrUndefined(e.showRatio));let s=[];const n={addNote:(i,r,h)=>{if(ye("addTuplet => addNote",i,r,h),ve(i instanceof a.L7||o.I8.isNonEmptyString(i)||o.I8.isArray(i)&&i.every(t=>t instanceof a.L7||o.I8.isNonEmptyString(t)),(0,a.DF)(r)),null!=h||(h={}),Le(h),o.I8.isArray(i)){let n=h.string;i.forEach((i,a)=>{h.string=o.I8.isArray(n)?n[a]:n;let c=this.getMeasure().addNoteGroup(t,[i],r,h,e);s.push(c)})}else{let n=this.getMeasure().addNoteGroup(t,[i],r,h,e);s.push(n)}return n},addChord:(i,r,h)=>{ye("addTuplet => addChord",i,r,h),ve(o.I8.isNonEmptyArray(i)&&i.every(t=>t instanceof a.L7||o.I8.isNonEmptyString(t)),(0,a.DF)(r)),null!=h||(h={}),Le(h);let c=this.getMeasure().addNoteGroup(t,i,r,h,e);return s.push(c),n},addRest:(i,o)=>{ye("addTuplet => addRest",i,o),ve((0,a.DF)(i)),null!=o||(o={}),Te(o);let r=this.getMeasure().addRest(t,i,o,e);return s.push(r),n}};return i(n),Qt.createTuplet(s,e),this}addLyricsInternal(t,e,i,s,n){return Ne(t),ve(W(e),o.I8.isEnumValue(i,a.r5),o.I8.isString(s)||o.I8.isArray(s)&&s.every(t=>o.I8.isString(t))),null!=n||(n={}),function(t){ve(o.I8.isObject(t),o.I8.isEnumValueOrUndefined(t.align,Q),o.I8.isEnumValueOrUndefined(t.hyphen,_))}(n),void 0!==n.align?this.currentLyricsAlign=n.align:null!=n.align||(n.align=this.currentLyricsAlign),o.I8.isArray(s)?s.forEach(s=>this.getMeasure().addLyrics(t,e,i,s,n)):this.getMeasure().addLyrics(t,e,i,s,n),this}addLyrics(t,e,i,s){return ye("addLyrics",t,e,i,s),this.addLyricsInternal(void 0,t,e,null!=i?i:"",s)}addLyricsTo(t,e,i,s,n){return ye("addLyricsTo",e,i,s,n),this.addLyricsInternal(t,e,i,null!=s?s:"",n)}addFermataInternal(t,e){return Ne(t),ve(o.I8.isEnumValue(e,$)),this.getMeasure().addFermata(t,e),this}addFermata(t="atNote"){return ye("addFermata",t),this.addFermataInternal(void 0,t)}addFermataTo(t,e="atNote"){return ye("addFermataTo",t,e),this.addFermataInternal(t,e)}addNavigationInternal(t,e,...i){return Ne(t),ve(o.I8.isStrictEqual(e,"endRepeat")&&o.I8.isStrictEqual(i.length,1)||o.I8.isStrictEqual(e,"ending")&&o.I8.isIntegerGte(i.length,1)&&i.every(t=>o.I8.isIntegerGte(t,1))||o.I8.isEnumValue(e,tt)&&o.I8.isEmptyArray(i)),this.getMeasure().addNavigation(t,e,...i),this}addNavigation(t,...e){return ye("addNavigation",t,...e),this.addNavigationInternal(void 0,t,...e)}addNavigationTo(t,e,...i){return ye("addNavigationTo",t,e,...i),this.addNavigationInternal(t,e,...i)}addAnnotationInternal(t,e,i){if(null!=e||(e=function(t){return o.I8.isEnumValue(t,it)?"dynamics":o.I8.isEnumValue(t,st)?"tempo":void 0}(i)),void 0===e)throw new h.O1(h.mN.Score,`Annotation text "${i}" is not known annotation.`);return Ne(t),ve(o.I8.isEnumValue(e,et),o.I8.isNonEmptyString(i)),this.getMeasure().addAnnotation(t,e,i),this}addAnnotation(...t){return ye("addAnnotation",...t),1===t.length?this.addAnnotationInternal(void 0,void 0,t[0]):this.addAnnotationInternal(void 0,t[0],t[1])}addAnnotationTo(t,...e){return ye("addAnnotationTo",t,...e),1===e.length?this.addAnnotationInternal(t,void 0,e[0]):this.addAnnotationInternal(t,e[0],e[1])}addLabelInternal(t,e,i){return Ne(t),ve(o.I8.isEnumValue(e,nt),o.I8.isNonEmptyString(i)),this.getMeasure().addLabel(t,e,i),this}addLabel(t,e){return ye("addLabel",t,e),this.addLabelInternal(void 0,t,e)}addLabelTo(t,e,i){return ye("addLabelTo",t,e,i),this.addLabelInternal(t,e,i)}addConnective(t,...e){if(ye("addConnective",t,...e),ve(o.I8.isEnumValue(t,J)),"tie"===t){ve(o.I8.isIntegerOrUndefined(e[0])||o.I8.isEnumValue(e[0],X)),ve(o.I8.isEnumValueOrUndefined(e[1],q));let i=e[0],s=e[1];this.getMeasure().addConnective(t,i,s)}else if("slur"===t){ve(o.I8.isIntegerOrUndefined(e[0])),ve(o.I8.isEnumValueOrUndefined(e[1],q));let i=e[0],s=e[1];this.getMeasure().addConnective(t,i,s)}else if("slide"===t){ve(o.I8.isEnumValueOrUndefined(e[0],q));let i=e[0];this.getMeasure().addConnective(t,i)}return this}addExtension(t){ye("addExtension"),we(o.I8.isFunctionOrUndefined(t),"addExtension() has new usage, e.g. addExtension(ext => ext.measures(2)).");let e=0,i=!0;const s={notes:(t,i)=>(ye("addExtension.notes",t,i),ve((0,a.DF)(t)),ve(o.I8.isUndefined(i)||o.I8.isNumber(i)&&i>=0),e+=a.R6.get(t).ticks*(null!=i?i:1),s),measures:t=>(ye("addExtension.measures",t),ve(o.I8.isNumber(t)&&t>=1),e+=this.getMeasure().getMeasureTicks()*t,s),infinity:()=>(ye("addExtension.infinity"),e=1/0,s),hide:()=>(ye("addExtension.hide"),i=!1,s)};return t?t(s):e=1/0,this.getMeasure().addExtension(e,i),this}addStaffGroup(t,e,i="auto"){return ye("addStaffGroup",t,e,i),ve(o.I8.isNonEmptyString(t),o.I8.isNonEmptyString(e)||o.I8.isIntegerGte(e,0)||o.I8.isNonEmptyArray(e)&&e.every(t=>o.I8.isNonEmptyString(t)||o.I8.isIntegerGte(t,0)),o.I8.isEnumValue(i,K)),this.doc.addStaffGroup(t,e,i),this}endSong(){return ye("endSong"),this.getMeasure().endSong(),this}endSection(){return ye("endSection"),this.getMeasure().endSection(),this}endRow(){var t;return ye("endRow"),null==(t=this.doc.getLastMeasure())||t.endRow(),this}completeRests(t){return ye("completeRests",t),ve(o.I8.isUndefined(t)||G(t)||o.I8.isArray(t)&&t.every(t=>G(t))),this.getMeasure().completeRests(t),this}addScaleArpeggio(t,e,i){ye("addScaleArpeggio",t,e,i),ve(o.I8.isNonEmptyString(e),o.I8.isIntegerGte(i,1));let s=this.getMeasure().getTimeSignature(),n=t.getScaleNotes(e,i);for(let o=0;o<n.length;o++){o%s.beatCount===0&&o>0&&this.addMeasure();let t=n[o];this.addNote(0,t,s.beatLength),this.addLabel("note",t.formatOmitOctave(a.dd.Unicode))}return this}};(0,r.Mu)(Oe,"DefaultMeasureOptions",{});var je=Oe,ke=class{constructor(t){this.type=t}},Pe=class extends ke{constructor(t,e,i,s){super(t),this.renderContext=e,this.scoreRow=i,this.diatonicId=s}},Ee=class extends ke{constructor(t,e,i){if(super(t),this.renderContext=e,this.objects=i,0===arguments.length)throw new h.O1(h.mN.Score,"Empty array in score object event!")}get topObject(){return this.objects[this.objects.length-1]}findObject(t){return this.objects.find(e=>t(e))}};function De(t,e,i){if(!t)throw new h.O1(h.mN.Score,`Invalid arg: ${e} = ${i}`)}function Ge(t){if(t instanceof de||t instanceof fe)return t.getMusicInterface();throw new h.O1(h.mN.Score,"Notation line not staff nor tab.")}var Be=class{constructor(t){this.name=t}getParent(){var t;return null==(t=this.getMusicObject().getParent())?void 0:t.getMusicInterface()}},Ye=class t extends Be{constructor(e){super(t.Name),this.obj=e}getMusicObject(){return this.obj}getAccidental(){return this.obj.accidental}};(0,r.Mu)(Ye,"Name","Accidental");var We=Ye,Fe=class t extends Be{constructor(e){super(t.Name),this.obj=e}getMusicObject(){return this.obj}};(0,r.Mu)(Fe,"Name","Connective");var Ue=Fe,ze=class t extends Be{constructor(e){super(t.Name),this.obj=e}getMusicObject(){return this.obj}getRhythmColumn(){return this.obj.col.getMusicInterface()}getNotationLine(){return Ge(this.obj.line)}};(0,r.Mu)(ze,"Name","Arpeggio");var Ze=ze,Ve=class t extends Be{constructor(e){super(t.Name),this.obj=e}getMusicObject(){return this.obj}};(0,r.Mu)(Ve,"Name","BeamGroup");var He=Ve,Xe=class t extends Be{constructor(e){super(t.Name),this.obj=e}getMusicObject(){return this.obj}getStaff(){return this.obj.staff.getMusicInterface()}};(0,r.Mu)(Xe,"Name","StaffBeamGroup");var qe=Xe,Je=class t extends Be{constructor(e){super(t.Name),this.obj=e}getMusicObject(){return this.obj}getTitle(){return this.obj.getTitle()}getComposer(){return this.obj.getComposer()}getArranger(){return this.obj.getArranger()}getRows(){return this.obj.getRows().map(t=>t.getMusicInterface())}getMeasures(){return this.obj.getMeasures().map(t=>t.getMusicInterface())}play(t){return De(o.I8.isFunctionOrUndefined(t),"playStateChangeListener",t),new Ki(this,t).play()}};(0,r.Mu)(Je,"Name","Document");var Ke=Je,Qe=class t extends Be{constructor(e){super(t.Name),this.obj=e}getMusicObject(){return this.obj}getPassages(){return this.obj.passages}hasPassage(t){return De(o.I8.isIntegerGte(t,1),"passage",t),this.obj.hasPassage(t)}};(0,r.Mu)(Qe,"Name","Ending");var _e=Qe,$e=class t extends Be{constructor(e){super(t.Name),this.obj=e}getMusicObject(){return this.obj}};(0,r.Mu)($e,"Name","Fermata");var ti=$e,ei=class t extends Be{constructor(e){super(t.Name),this.obj=e}getMusicObject(){return this.obj}getTitle(){return this.obj.title}getComposer(){return this.obj.composer}getArranger(){return this.obj.arranger}};(0,r.Mu)(ei,"Name","Header");var ii=ei,si=class t extends Be{constructor(e){super(t.Name),this.obj=e}getMusicObject(){return this.obj}};(0,r.Mu)(si,"Name","Image");var ni=si,oi=class t extends Be{constructor(e){super(t.Name),this.obj=e}getMusicObject(){return this.obj}getMeasureNumber(){return this.obj.getMeasureNumber()}getRhythmColumns(){return this.obj.getColumns().map(t=>t.getMusicInterface())}getRow(){return this.obj.row.getMusicInterface()}};(0,r.Mu)(oi,"Name","Measure");var ri=oi,ai=class t extends Be{constructor(e){super(t.Name),this.obj=e}getMusicObject(){return this.obj}};(0,r.Mu)(ai,"Name","BarLineRight");var hi=ai,ci=class t extends Be{constructor(e){super(t.Name),this.obj=e}getMusicObject(){return this.obj}};(0,r.Mu)(ci,"Name","BarLineLeft");var gi=ci,ui=class t extends Be{constructor(e){super(t.Name),this.obj=e}getMusicObject(){return this.obj}getBarLine(){let t=this.obj.barLine;if(t instanceof Vt||t instanceof Ht)return t.getMusicInterface();throw new h.O1(h.mN.Score,"Bar line not left nor right.")}getNotationLine(){return Ge(this.obj.line)}};(0,r.Mu)(ui,"Name","StaffBarLine");var li=ui,di=class t extends Be{constructor(e){super(t.Name),this.obj=e}getMusicObject(){return this.obj}getNotes(){return this.obj.notes}getRhythmProps(){return this.obj.rhythmProps}getRhythmColumn(){return this.obj.col.getMusicInterface()}getMeasure(){return this.obj.measure.getMusicInterface()}};(0,r.Mu)(di,"Name","NoteGroup");var fi=di,Ii=class t extends Be{constructor(e){super(t.Name),this.obj=e}getMusicObject(){return this.obj}getNoteGroup(){return this.obj.noteGroup.getMusicInterface()}getRhythmColumn(){return this.getNoteGroup().getRhythmColumn()}getMeasure(){return this.getNoteGroup().getMeasure()}getStaff(){return this.obj.staff.getMusicInterface()}};(0,r.Mu)(Ii,"Name","StaffNoteGroup");var mi=Ii,Ci=class t extends Be{constructor(e){super(t.Name),this.obj=e}getMusicObject(){return this.obj}getNoteGroup(){return this.obj.noteGroup.getMusicInterface()}getRhythmColumn(){return this.getNoteGroup().getRhythmColumn()}getMeasure(){return this.getNoteGroup().getMeasure()}getTab(){return this.obj.tab.getMusicInterface()}};(0,r.Mu)(Ci,"Name","TabNoteGroup");var pi=Ci,Ai=class t extends Be{constructor(e){super(t.Name),this.obj=e}getMusicObject(){return this.obj}getRhythmProps(){return this.obj.rhythmProps}getRhythmColumn(){return this.obj.col.getMusicInterface()}getMeasure(){return this.obj.measure.getMusicInterface()}};(0,r.Mu)(Ai,"Name","Rest");var bi=Ai,yi=class t extends Be{constructor(e){super(t.Name),this.obj=e}getMusicObject(){return this.obj}getRest(){return this.obj.rest.getMusicInterface()}getRhythmColumn(){return this.getRest().getRhythmColumn()}getMeasure(){return this.getRest().getMeasure()}getStaff(){return this.obj.staff.getMusicInterface()}};(0,r.Mu)(yi,"Name","StaffRest");var vi=yi,wi=class t extends Be{constructor(e){super(t.Name),this.obj=e}getMusicObject(){return this.obj}getRhythmSymbol(t){var e;return De(G(t),"voiceId",t),null==(e=this.obj.getVoiceSymbol(t))?void 0:e.getMusicInterface()}getMeasure(){return this.obj.measure.getMusicInterface()}};(0,r.Mu)(wi,"Name","RhythmColumn");var Mi=wi,Si=class t extends Be{constructor(e){super(t.Name),this.obj=e}getMusicObject(){return this.obj}getDocument(){return this.obj.doc.getMusicInterface()}getMeasures(){return this.obj.getMeasures().map(t=>t.getMusicInterface())}getNotationLines(){return this.obj.getNotationLines().map(t=>Ge(t))}};(0,r.Mu)(Si,"Name","ScoreRow");var Ri=Si,xi=class t extends Be{constructor(e){super(t.Name),this.obj=e}getMusicObject(){return this.obj}getInstrument(){return this.obj.instrument}};(0,r.Mu)(xi,"Name","ScoreRowGroup");var Li=xi,Ti=class t extends Be{constructor(e){super(t.Name),this.obj=e}getMusicObject(){return this.obj}getId(){return this.obj.id}getName(){return this.obj.name.length>0?this.obj.name:void 0}getRow(){return this.obj.row.getMusicInterface()}};(0,r.Mu)(Ti,"Name","Staff");var Ni=Ti,Oi=class t extends Be{constructor(e){super(t.Name),this.obj=e}getMusicObject(){return this.obj}getId(){return this.obj.id}getName(){return this.obj.name.length>0?this.obj.name:void 0}getRow(){return this.obj.row.getMusicInterface()}};(0,r.Mu)(Oi,"Name","Tab");var ji=Oi,ki=class t extends Be{constructor(e){super(t.Name),this.obj=e}getMusicObject(){return this.obj}getStaff(){return this.obj.staff.getMusicInterface()}};(0,r.Mu)(ki,"Name","StaffSignature");var Pi=ki,Ei=class t extends Be{constructor(e){super(t.Name),this.obj=e}getMusicObject(){return this.obj}getTab(){return this.obj.tab.getMusicInterface()}};(0,r.Mu)(Ei,"Name","TabSignature");var Di=Ei,Gi=class t extends Be{constructor(e){super(t.Name),this.obj=e}getMusicObject(){return this.obj}getMeasure(){return this.obj.measure.getMusicInterface()}getTab(){return this.obj.tab.getMusicInterface()}};(0,r.Mu)(Gi,"Name","TabRhythm");var Bi=Gi,Yi=class t extends Be{constructor(e){super(t.Name),this.obj=e}getMusicObject(){return this.obj}getText(){return this.obj.getText()}};(0,r.Mu)(Yi,"Name","SpecialText");var Wi=Yi,Fi=class t extends Be{constructor(e){super(t.Name),this.obj=e}getMusicObject(){return this.obj}getText(){return this.obj.getText()}};(0,r.Mu)(Fi,"Name","Text");var Ui=Fi,zi=class t extends Be{constructor(e){super(t.Name),this.obj=e}getMusicObject(){return this.obj}getText(){return this.obj.getText()}};(0,r.Mu)(zi,"Name","Lyrics");var Zi=zi,Vi=class t extends Be{constructor(e){super(t.Name),this.obj=e}getMusicObject(){return this.obj}};(0,r.Mu)(Vi,"Name","ExtensionLine");var Hi=Vi;function Xi(t,e,i){if(!t)throw new h.O1(h.mN.Score,`Invalid arg: ${e} = ${i}`)}function qi(t,e){if(null==t)throw new TypeError(e);return t}var Ji=class t{constructor(t,e){(0,r.Mu)(this,"player"),Xi(t instanceof Ke,"doc",t),Xi(o.I8.isFunctionOrUndefined(e),"playStateChangeListener",e),this.player=new Ut,this.player.setDocument(t.getMusicObject()),this.player.setCursorPositionChangeListener(e=>{t.getMusicObject().updateCursorRect(e)}),e&&this.player.setPlayStateChnageListener(e)}static stopAll(){this.currentlyPlaying.forEach(t=>t.stop()),c.ds()}play(){return t.currentlyPlaying.add(this),this.player.play(),this}pause(){return this.player.pause(),this}stop(){return this.player.stop(),t.currentlyPlaying.delete(this),this}};(0,r.Mu)(Ji,"currentlyPlaying",new o.wu);var Ki=Ji,Qi=class{constructor(){(0,r.Mu)(this,"ctx"),this.ctx=new It(this)}setDocument(t){return Xi(o.I8.isUndefined(t)||t instanceof Ke,"doc",t),this.ctx.setDocument(t),this}setCanvas(t){return t=qi(o.OZ.Dom.getCanvas(t),"string"==typeof t?"Cannot set render canvas because invalid canvas id: "+t:"Cannot set render canvas because given canvas is undefined."),this.ctx.setCanvas(t),this}setScoreEventListener(t){Xi(o.I8.isFunctionOrUndefined(t),"scoreEventListener",t),this.ctx.setScoreEventListener(t)}hilightObject(t){this.ctx.hilightObject(null==t?void 0:t.getMusicObject())}hilightStaffPos(t){this.ctx.hilightStaffPos(t?{scoreRow:t.scoreRow.getMusicObject(),diatonicId:t.diatonicId}:void 0)}draw(){try{this.ctx.draw()}catch(t){console.log("Draw failed in music render context!",t)}}},_i=class t{constructor(){(0,r.Mu)(this,"playButton"),(0,r.Mu)(this,"stopButton"),(0,r.Mu)(this,"playStopButton"),(0,r.Mu)(this,"pauseButton"),(0,r.Mu)(this,"onPlay"),(0,r.Mu)(this,"onStop"),(0,r.Mu)(this,"onPlayStop"),(0,r.Mu)(this,"onPause"),(0,r.Mu)(this,"playLabel","Play"),(0,r.Mu)(this,"stopLabel","Stop"),(0,r.Mu)(this,"pauseLabel","Pause"),(0,r.Mu)(this,"playState",2),(0,r.Mu)(this,"player"),this.onPlay=()=>{var t;return null==(t=this.player)?void 0:t.play()},this.onStop=()=>{var t;return null==(t=this.player)?void 0:t.stop()},this.onPlayStop=()=>{var t,e;0===this.playState?null==(t=this.player)||t.stop():null==(e=this.player)||e.play()},this.onPause=()=>{var t;return null==(t=this.player)?void 0:t.pause()},this.updateButtons()}setDocument(t){return Xi(o.I8.isUndefined(t)||t instanceof Ke,"doc",t),this.onStop(),this.player=t?new Ki(t,t=>{this.playState=t,this.updateButtons()}):void 0,this.updateButtons(),this}detachDocument(){this.setDocument(void 0)}updateButtons(){this.playButton&&(this.playButton.disabled=!this.player||0===this.playState,this.playButton.innerText=this.playLabel),this.stopButton&&(this.stopButton.disabled=!this.player||2===this.playState,this.stopButton.innerText=this.stopLabel),this.playStopButton&&(this.playStopButton.disabled=!this.player,this.playStopButton.innerText=0===this.playState?this.stopLabel:this.playLabel),this.pauseButton&&(this.pauseButton.disabled=!this.player||0!==this.playState,this.pauseButton.innerText=this.pauseLabel)}setPlayButton(e,i){return Xi(o.I8.isStringOrUndefined(i),"btnLabel",i),t.removeOnClickListeners(this.playButton,this.onPlay),this.playButton=qi(o.OZ.Dom.getButton(e),"Play button required!"),this.playLabel=null!=i?i:"Play",t.removeOnClickListeners(this.playButton,"all"),t.addOnClickListener(this.playButton,this.onPlay),this.updateButtons(),this}setStopButton(e,i){return Xi(o.I8.isStringOrUndefined(i),"btnLabel",i),t.removeOnClickListeners(this.stopButton,this.onStop),this.stopButton=qi(o.OZ.Dom.getButton(e),"Stop button required!"),this.stopLabel=null!=i?i:"Stop",t.removeOnClickListeners(this.stopButton,"all"),t.addOnClickListener(this.stopButton,this.onStop),this.updateButtons(),this}setPlayStopButton(e,i,s){return Xi(o.I8.isStringOrUndefined(i),"playLabel",i),Xi(o.I8.isStringOrUndefined(s),"stopLabel",s),t.removeOnClickListeners(this.playStopButton,this.onPlayStop),this.playStopButton=qi(o.OZ.Dom.getButton(e),"Play/stop button required!"),this.playLabel=null!=i?i:"Play",this.stopLabel=null!=s?s:"Stop",t.removeOnClickListeners(this.playStopButton,"all"),t.addOnClickListener(this.playStopButton,this.onPlayStop),this.updateButtons(),this}setPauseButton(e,i){return Xi(o.I8.isStringOrUndefined(i),"btnLabel",i),t.removeOnClickListeners(this.pauseButton,this.onPause),this.pauseButton=qi(o.OZ.Dom.getButton(e),"Pause button required!"),this.pauseLabel=null!=i?i:"Pause",t.removeOnClickListeners(this.pauseButton,"all"),t.addOnClickListener(this.pauseButton,this.onPause),this.updateButtons(),this}static removeOnClickListeners(t,e){if(!t)return;let i=this.savedOnClickListeners.getOrDefault(t,[]);i=i.filter(i=>e!==i&&"all"!==e||(t.removeEventListener("click",i),!1)),this.savedOnClickListeners.set(t,i)}static addOnClickListener(t,e){Xi(o.I8.isFunction(e),"onClick",e),t.addEventListener("click",e),this.savedOnClickListeners.getOrCreate(t,[]).push(e)}};(0,r.Mu)(_i,"savedOnClickListeners",new o.b1);var $i=_i;(0,h.Ts)()},8453:(t,e,i)=>{i.d(e,{R:()=>r,x:()=>a});var s=i(6540);const n={},o=s.createContext(n);function r(t){const e=s.useContext(o);return s.useMemo(function(){return"function"==typeof t?t(e):{...e,...t}},[e,t])}function a(t){let e;return e=t.disableParentContext?"function"==typeof t.components?t.components(n):t.components||n:r(t.components),s.createElement(o.Provider,{value:e},t.children)}}}]);